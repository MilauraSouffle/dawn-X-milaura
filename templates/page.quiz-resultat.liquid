{{ 'milaura-quiz-result.css' | asset_url | stylesheet_tag }}

{%- comment -%} Récupérer param URL ?profile=reconfort {%- endcomment -%}
{%- assign profile_handle = request.url | split: 'profile=' | last | split: '&' | first | downcase -%}

{%- comment -%} Lookup emotional_profile {%- endcomment -%}
{%- assign profile = shop.metaobjects.emotional_profile[profile_handle] -%}

{%- if profile -%}
  {%- comment -%} Données profil {%- endcomment -%}
  {%- assign profile_name = profile.name.value -%}
  {%- assign hero_copy = profile.hero_copy.value -%}
  {%- assign needs = profile.needs_bullets.value -%}
  {%- assign ritual_morning = profile.ritual_morning_steps.value -%}
  {%- assign ritual_evening = profile.ritual_evening_steps.value -%}
  {%- assign candle = profile.candle_product.value -%}
  {%- assign stone_handle = profile.stone_handle.value -%}
  {%- assign scent_handle = profile.scent_handle.value -%}

  {%- comment -%} Lookup stone et scent {%- endcomment -%}
  {%- assign stone = shop.metaobjects.stone[stone_handle] -%}
  {%- assign scent = shop.metaobjects.scent[scent_handle] -%}

  <div class="milaura-quiz-result-page">

    {%- comment -%} Hero Section {%- endcomment -%}
    <section class="milaura-result-hero">
      <div class="milaura-result-container">
        <h1 class="milaura-result-title">Votre profil : {{ profile_name }}</h1>

        <div class="milaura-result-hero-content">
          {{ hero_copy | newline_to_br }}
        </div>

        {%- if needs.size > 0 -%}
          <div class="milaura-result-needs">
            <h3>Vos besoins</h3>
            <ul>
              {%- for need in needs -%}
                <li>{{ need }}</li>
              {%- endfor -%}
            </ul>
          </div>
        {%- endif -%}
      </div>
    </section>

    {%- comment -%} Bougie Section {%- endcomment -%}
    {%- if candle -%}
      <section class="milaura-result-candle">
        <div class="milaura-result-container">
          <h2 class="milaura-result-section-title">Votre bougie</h2>

          <div class="milaura-result-candle-card">
            <div class="milaura-result-candle-image">
              {%- if candle.featured_image -%}
                <img src="{{ candle.featured_image | image_url: width: 600 }}" alt="{{ candle.title }}" loading="eager">
              {%- else -%}
                {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
              {%- endif -%}
            </div>

            <div class="milaura-result-candle-info">
              <h3>{{ candle.title }}</h3>
              <p class="milaura-result-candle-price">{{ candle.price | money }}</p>

              {%- if candle.available -%}
                <a href="{{ candle.url }}" class="milaura-result-cta">
                  Adopter ce rituel
                </a>
              {%- else -%}
                {%- comment -%} Gestion rupture stock {%- endcomment -%}
                <div class="milaura-result-out-of-stock">
                  <p class="milaura-result-stock-message">Cette bougie est en cours de fabrication</p>
                  <button type="button" class="milaura-result-cta-secondary" onclick="alert('Fonctionnalité notification à venir')">
                    Me prévenir quand elle revient
                  </button>
                  <a href="/" class="milaura-result-cta-tertiary">Revenir à l'accueil</a>
                </div>
              {%- endif -%}
            </div>
          </div>

          {%- comment -%} Pierre + Senteur {%- endcomment -%}
          <div class="milaura-result-details">
            {%- if stone -%}
              <div class="milaura-result-detail-card">
                <h4>La pierre : {{ stone.name.value }}</h4>
                <p class="milaura-result-detail-color">{{ stone.color.value }}</p>
                <p>{{ stone.short_essentiel.value | truncate: 200 }}</p>
              </div>
            {%- endif -%}

            {%- if scent -%}
              <div class="milaura-result-detail-card">
                <h4>La senteur : {{ scent.name.value }}</h4>
                <p class="milaura-result-detail-mood">{{ scent.mood.value }}</p>
                <p>{{ scent.description_short.value }}</p>
              </div>
            {%- endif -%}
          </div>

        </div>
      </section>
    {%- endif -%}

    {%- comment -%} Rituel Section {%- endcomment -%}
    <section class="milaura-result-ritual">
      <div class="milaura-result-container">
        <h2 class="milaura-result-section-title">Votre rituel quotidien</h2>

        <div class="milaura-result-ritual-grid">
          {%- if ritual_morning.size > 0 -%}
            <div class="milaura-result-ritual-card">
              <h3>Matin</h3>
              <ol>
                {%- for step in ritual_morning -%}
                  <li>{{ step }}</li>
                {%- endfor -%}
              </ol>
            </div>
          {%- endif -%}

          {%- if ritual_evening.size > 0 -%}
            <div class="milaura-result-ritual-card">
              <h3>Soir</h3>
              <ol>
                {%- for step in ritual_evening -%}
                  <li>{{ step }}</li>
                {%- endfor -%}
              </ol>
            </div>
          {%- endif -%}
        </div>
      </div>
    </section>

    {%- comment -%} CTA Retour {%- endcomment -%}
    <section class="milaura-result-footer">
      <div class="milaura-result-container">
        <a href="/pages/quiz" class="milaura-result-cta-secondary">Refaire le quiz</a>
      </div>
    </section>

  </div>

{%- else -%}
  {%- comment -%} Profil invalide {%- endcomment -%}
  <div class="milaura-quiz-result-page">
    <div class="milaura-result-container" style="text-align: center; padding: 3rem 1.5rem;">
      <h1>Profil introuvable</h1>
      <p style="margin: 1.5rem 0;">Le profil "{{ profile_handle }}" n'existe pas.</p>
      <a href="/pages/quiz" class="milaura-result-cta">Refaire le quiz</a>
    </div>
  </div>
{%- endif -%}
