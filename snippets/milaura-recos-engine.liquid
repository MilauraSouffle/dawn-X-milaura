{%- comment -%}
  MILAURA RECOS ENGINE V1
  Contrainte perf : Lookups bornés, source limitée (collection recos-pool max 50)

  INPUT :
    - current_product : Produit actuel
    - max_recos : Nombre max recos (défaut: 2)

  OUTPUT :
    - recommended_products : Array de produits (max 2)
{%- endcomment -%}

{%- liquid
  assign current_stone = current_product.metafields.milaura.stone_handle
  assign current_type = current_product.metafields.milaura.product_type_handle
  assign max_recos = max_recos | default: 2

  assign recommended_products = blank | split: ','
  assign reco_count = 0

  # Source bornée (collection recos-pool, max 50)
  assign reco_source = collections['recos-pool'].products

  # Étape 1 : Filter pierre commune + type différent
  for product in reco_source limit: 50
    if product.id == current_product.id
      continue
    endif

    assign product_stone = product.metafields.milaura.stone_handle
    assign product_type = product.metafields.milaura.product_type_handle

    if product_stone == current_stone and product_type != current_type
      assign recommended_products = recommended_products | push: product
      assign reco_count = reco_count | plus: 1

      if reco_count >= max_recos
        break
      endif
    endif
  endfor

  # Étape 2 : Fallback bestsellers si < max_recos
  if reco_count < max_recos
    for product in reco_source limit: 50
      if product.id == current_product.id
        continue
      endif

      # Éviter duplication
      assign already_recommended = false
      for match in recommended_products
        if match.id == product.id
          assign already_recommended = true
          break
        endif
      endfor

      if already_recommended
        continue
      endif

      # Vérifier bestseller
      assign is_bestseller = product.metafields.milaura.is_bestseller

      if is_bestseller == true
        assign recommended_products = recommended_products | push: product
        assign reco_count = reco_count | plus: 1

        if reco_count >= max_recos
          break
        endif
      endif
    endfor
  endif
-%}
