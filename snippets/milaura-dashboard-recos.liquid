{%- comment -%}
  MILAURA DASHBOARD - PROFIL √âMOTIONNEL
  Affichage du profil quiz + recommandations personnalis√©es
  Lit depuis localStorage (milauraLastResult)
{%- endcomment -%}

{%- if customer -%}
<div class="milaura-dashboard-profile" id="milaura-dashboard-profile">
  <!-- √âtat: Chargement -->
  <div class="dashboard-loading" id="dashboard-loading">
    <div class="dashboard-loading-spinner"></div>
    <p>Chargement de votre profil...</p>
  </div>

  <!-- √âtat: Pas de profil -->
  <div class="dashboard-no-profile" id="dashboard-no-profile" style="display: none;">
    <div class="dashboard-no-profile-icon">‚ú®</div>
    <h3 class="dashboard-no-profile-title">D√©couvrez votre bougie id√©ale</h3>
    <p class="dashboard-no-profile-text">
      R√©pondez √† notre diagnostic √©motionnel pour recevoir des recommandations personnalis√©es
      bas√©es sur vos besoins du moment.
    </p>
    <a href="/pages/diagnostic-emotionnel" class="dashboard-cta-quiz">
      <span>Faire le diagnostic</span>
      <span class="cta-arrow">‚Üí</span>
    </a>
  </div>

  <!-- √âtat: Profil trouv√© -->
  <div class="dashboard-has-profile" id="dashboard-has-profile" style="display: none;">
    <!-- En-t√™te profil -->
    <div class="dashboard-profile-header">
      <div class="dashboard-profile-badge">
        <span class="profile-icon" id="profile-icon">ü§ç</span>
      </div>
      <div class="dashboard-profile-info">
        <p class="dashboard-profile-label">Votre profil √©motionnel</p>
        <h3 class="dashboard-profile-name" id="profile-name">-</h3>
      </div>
      <div class="dashboard-profile-date">
        <span id="profile-date">-</span>
      </div>
    </div>

    <!-- Duo pierre + senteur -->
    <div class="dashboard-profile-duo">
      <div class="dashboard-duo-item">
        <span class="duo-icon">üíé</span>
        <span class="duo-label">Pierre</span>
        <span class="duo-value" id="profile-stone">-</span>
      </div>
      <div class="dashboard-duo-item">
        <span class="duo-icon">üå∏</span>
        <span class="duo-label">Senteur</span>
        <span class="duo-value" id="profile-scent">-</span>
      </div>
    </div>

    <!-- Bougie recommand√©e -->
    <div class="dashboard-candle-card" id="dashboard-candle-card" style="display: none;">
      <div class="dashboard-candle-image" id="candle-image-container">
        <div class="candle-placeholder">üïØÔ∏è</div>
      </div>
      <div class="dashboard-candle-info">
        <h4 class="dashboard-candle-title" id="candle-title">-</h4>
        <p class="dashboard-candle-baseline">Votre bougie du moment</p>
        <a href="#" class="dashboard-candle-link" id="candle-link">Voir le produit ‚Üí</a>
      </div>
    </div>

    <!-- M√©t√©o √©motionnelle r√©sum√©e -->
    <div class="dashboard-mood-summary">
      <h4 class="dashboard-mood-title">Votre m√©t√©o √©motionnelle</h4>
      <div class="dashboard-mood-bars" id="dashboard-mood-bars">
        <!-- Rempli par JS -->
      </div>
    </div>

    <!-- Actions -->
    <div class="dashboard-actions">
      <button type="button" class="dashboard-btn-restart" id="dashboard-restart-quiz">
        <span>üîÑ</span>
        <span>Refaire le diagnostic</span>
      </button>
    </div>
  </div>
</div>

<style>
  /* ===== BASE CONTAINER ===== */
  .milaura-dashboard-profile {
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: var(--milaura-border-radius, 20px);
    padding: var(--milaura-spacing-lg, 36px);
    border: 1px solid rgba(192, 160, 98, 0.2);
    margin-bottom: var(--milaura-spacing-lg, 36px);
    /* Fix d√©bordement */
    max-width: 100%;
    box-sizing: border-box;
    overflow-x: hidden;
  }

  /* ===== LOADING STATE ===== */
  .dashboard-loading {
    text-align: center;
    padding: var(--milaura-spacing-xl, 48px) 0;
  }

  .dashboard-loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(192, 160, 98, 0.2);
    border-top-color: var(--milaura-gold, #C0A062);
    border-radius: 50%;
    margin: 0 auto var(--milaura-spacing-md, 24px);
    animation: dashboardSpin 1s linear infinite;
  }

  @keyframes dashboardSpin {
    to { transform: rotate(360deg); }
  }

  .dashboard-loading p {
    color: var(--milaura-text-light, #666);
    font-size: 1.1rem;
  }

  /* ===== NO PROFILE STATE ===== */
  .dashboard-no-profile {
    text-align: center;
    padding: var(--milaura-spacing-lg, 36px) 0;
  }

  .dashboard-no-profile-icon {
    font-size: 3.5rem;
    margin-bottom: var(--milaura-spacing-md, 24px);
  }

  .dashboard-no-profile-title {
    font-family: var(--milaura-font-heading, 'Playfair Display', serif);
    font-size: 1.75rem;
    color: var(--milaura-text, #000);
    margin: 0 0 var(--milaura-spacing-sm, 12px) 0;
  }

  .dashboard-no-profile-text {
    color: var(--milaura-text-light, #666);
    font-size: 1.1rem;
    line-height: 1.6;
    max-width: 400px;
    margin: 0 auto var(--milaura-spacing-lg, 36px);
  }

  .dashboard-cta-quiz {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: linear-gradient(135deg, var(--milaura-gold, #C0A062) 0%, var(--milaura-gold-light, #E6C88B) 100%);
    color: #fff;
    font-weight: 600;
    font-size: 1.1rem;
    padding: 16px 32px;
    border-radius: 50px;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .dashboard-cta-quiz:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(192, 160, 98, 0.35);
  }

  .cta-arrow {
    transition: transform 0.3s ease;
  }

  .dashboard-cta-quiz:hover .cta-arrow {
    transform: translateX(4px);
  }

  /* ===== PROFILE HEADER ===== */
  .dashboard-profile-header {
    display: flex;
    align-items: center;
    gap: var(--milaura-spacing-md, 24px);
    padding-bottom: var(--milaura-spacing-md, 24px);
    border-bottom: 1px solid rgba(192, 160, 98, 0.15);
    margin-bottom: var(--milaura-spacing-md, 24px);
    flex-wrap: wrap;
  }

  .dashboard-profile-badge {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, var(--milaura-gold, #C0A062) 0%, var(--milaura-gold-light, #E6C88B) 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .profile-icon {
    font-size: 2rem;
  }

  .dashboard-profile-info {
    flex: 1;
    min-width: 150px;
  }

  .dashboard-profile-label {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--milaura-gold, #C0A062);
    margin: 0 0 4px 0;
  }

  .dashboard-profile-name {
    font-family: var(--milaura-font-heading, 'Playfair Display', serif);
    font-size: 1.75rem;
    color: var(--milaura-text, #000);
    margin: 0;
  }

  .dashboard-profile-date {
    font-size: 1rem;
    color: var(--milaura-text-light, #666);
  }

  /* ===== DUO PIERRE + SENTEUR ===== */
  .dashboard-profile-duo {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--milaura-spacing-md, 24px);
    margin-bottom: var(--milaura-spacing-md, 24px);
  }

  .dashboard-duo-item {
    background: rgba(255, 255, 255, 0.5);
    border-radius: var(--milaura-border-radius-sm, 12px);
    padding: var(--milaura-spacing-md, 24px);
    text-align: center;
    border: 1px solid rgba(192, 160, 98, 0.1);
    min-width: 0; /* Fix overflow dans grid */
  }

  .duo-icon {
    display: block;
    font-size: 1.75rem;
    margin-bottom: 10px;
  }

  .duo-label {
    display: block;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--milaura-gold, #C0A062);
    margin-bottom: 6px;
  }

  .duo-value {
    display: block;
    font-family: var(--milaura-font-heading, 'Playfair Display', serif);
    font-size: 1.25rem;
    color: var(--milaura-text, #000);
    font-weight: 600;
    word-wrap: break-word;
  }

  /* ===== CANDLE CARD ===== */
  .dashboard-candle-card {
    display: flex;
    align-items: center;
    gap: var(--milaura-spacing-md, 24px);
    background: rgba(253, 251, 247, 0.8);
    border-radius: var(--milaura-border-radius-sm, 12px);
    padding: var(--milaura-spacing-md, 24px);
    margin-bottom: var(--milaura-spacing-md, 24px);
    border: 1px solid rgba(192, 160, 98, 0.15);
  }

  .dashboard-candle-image {
    width: 90px;
    height: 90px;
    border-radius: 12px;
    overflow: hidden;
    flex-shrink: 0;
    background: linear-gradient(135deg, var(--milaura-beige, #FDFBF7), #f5f0e8);
  }

  .dashboard-candle-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .candle-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
  }

  .dashboard-candle-info {
    flex: 1;
    min-width: 0;
  }

  .dashboard-candle-title {
    font-family: var(--milaura-font-heading, 'Playfair Display', serif);
    font-size: 1.25rem;
    color: var(--milaura-text, #000);
    margin: 0 0 6px 0;
  }

  .dashboard-candle-baseline {
    font-size: 1rem;
    color: var(--milaura-text-light, #666);
    margin: 0 0 10px 0;
  }

  .dashboard-candle-link {
    font-size: 1rem;
    color: var(--milaura-gold, #C0A062);
    font-weight: 600;
    text-decoration: none;
    transition: color 0.3s ease;
  }

  .dashboard-candle-link:hover {
    color: var(--milaura-gold-dark, #8F723A);
    text-decoration: underline;
  }

  /* ===== MOOD SUMMARY ===== */
  .dashboard-mood-summary {
    margin-bottom: var(--milaura-spacing-md, 24px);
  }

  .dashboard-mood-title {
    font-family: var(--milaura-font-heading, 'Playfair Display', serif);
    font-size: 1.2rem;
    color: var(--milaura-text, #000);
    margin: 0 0 var(--milaura-spacing-sm, 12px) 0;
  }

  .dashboard-mood-bars {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .dashboard-mood-bar {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .mood-bar-label {
    width: 120px;
    font-size: 0.95rem;
    color: var(--milaura-text-light, #666);
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  .mood-bar-track {
    flex: 1;
    height: 8px;
    background: rgba(192, 160, 98, 0.1);
    border-radius: 8px;
    overflow: hidden;
    min-width: 60px;
  }

  .mood-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--milaura-gold, #C0A062) 0%, var(--milaura-gold-light, #E6C88B) 100%);
    border-radius: 8px;
    transition: width 0.8s ease;
  }

  .mood-bar-fill.is-secondary {
    background: linear-gradient(90deg, rgba(192, 160, 98, 0.4) 0%, rgba(192, 160, 98, 0.2) 100%);
  }

  .mood-bar-percent {
    width: 45px;
    font-size: 0.95rem;
    color: var(--milaura-text-light, #666);
    text-align: right;
    flex-shrink: 0;
  }

  /* ===== ACTIONS ===== */
  .dashboard-actions {
    display: flex;
    justify-content: center;
    padding-top: var(--milaura-spacing-md, 24px);
    border-top: 1px solid rgba(192, 160, 98, 0.15);
  }

  .dashboard-btn-restart {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: transparent;
    border: 1px solid var(--milaura-gold, #C0A062);
    color: var(--milaura-gold, #C0A062);
    font-weight: 600;
    font-size: 1rem;
    padding: 12px 24px;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .dashboard-btn-restart:hover {
    background: rgba(192, 160, 98, 0.1);
  }

  /* ===== TABLETTE (769px - 1024px) ===== */
  @media screen and (max-width: 1024px) {
    .milaura-dashboard-profile {
      padding: var(--milaura-spacing-md, 24px);
    }

    .dashboard-profile-name {
      font-size: 1.5rem;
    }

    .mood-bar-label {
      width: 110px;
      font-size: 0.9rem;
    }
  }

  /* ===== MOBILE (‚â§768px) ===== */
  @media screen and (max-width: 768px) {
    .milaura-dashboard-profile {
      padding: 20px 16px;
      border-radius: 16px;
      margin-left: -4px;
      margin-right: -4px;
    }

    /* Header */
    .dashboard-profile-header {
      gap: 16px;
    }

    .dashboard-profile-badge {
      width: 56px;
      height: 56px;
    }

    .profile-icon {
      font-size: 1.75rem;
    }

    .dashboard-profile-label {
      font-size: 0.85rem;
    }

    .dashboard-profile-name {
      font-size: 1.4rem;
    }

    .dashboard-profile-date {
      width: 100%;
      margin-top: 4px;
      font-size: 0.95rem;
    }

    /* Duo */
    .dashboard-profile-duo {
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .dashboard-duo-item {
      padding: 16px 12px;
    }

    .duo-icon {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    .duo-label {
      font-size: 0.8rem;
    }

    .duo-value {
      font-size: 1.1rem;
    }

    /* Candle */
    .dashboard-candle-card {
      flex-direction: column;
      text-align: center;
      padding: 20px 16px;
      gap: 16px;
    }

    .dashboard-candle-image {
      width: 100px;
      height: 100px;
    }

    .dashboard-candle-title {
      font-size: 1.2rem;
    }

    .dashboard-candle-baseline {
      font-size: 0.95rem;
    }

    /* Mood bars */
    .dashboard-mood-title {
      font-size: 1.1rem;
    }

    .dashboard-mood-bar {
      gap: 10px;
    }

    .mood-bar-label {
      width: 95px;
      font-size: 0.85rem;
      gap: 6px;
    }

    .mood-bar-track {
      height: 8px;
    }

    .mood-bar-percent {
      width: 40px;
      font-size: 0.85rem;
    }

    /* No profile */
    .dashboard-no-profile-title {
      font-size: 1.5rem;
    }

    .dashboard-no-profile-text {
      font-size: 1rem;
      padding: 0 8px;
    }

    .dashboard-cta-quiz {
      font-size: 1rem;
      padding: 14px 24px;
    }

    /* Restart button */
    .dashboard-btn-restart {
      font-size: 0.95rem;
      padding: 12px 20px;
    }
  }

  /* ===== PETIT MOBILE (<400px) ===== */
  @media screen and (max-width: 400px) {
    .milaura-dashboard-profile {
      padding: 16px 12px;
    }

    /* Duo en colonne */
    .dashboard-profile-duo {
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .dashboard-duo-item {
      display: flex;
      align-items: center;
      gap: 12px;
      text-align: left;
      padding: 14px 16px;
    }

    .duo-icon {
      font-size: 1.5rem;
      margin-bottom: 0;
      flex-shrink: 0;
    }

    .dashboard-duo-item > span:last-child {
      flex: 1;
    }

    .duo-label {
      margin-bottom: 2px;
    }

    /* Mood bars compacts */
    .mood-bar-label {
      width: 85px;
      font-size: 0.8rem;
    }

    .mood-bar-percent {
      width: 36px;
      font-size: 0.8rem;
    }

    .dashboard-profile-name {
      font-size: 1.25rem;
    }

    .dashboard-no-profile-title {
      font-size: 1.3rem;
    }

    .dashboard-cta-quiz {
      font-size: 0.95rem;
      padding: 12px 20px;
      width: 100%;
      justify-content: center;
    }
  }
</style>

<script>
(function() {
  const profileIcons = {
    reconfort: 'ü§ç',
    protection: 'üñ§',
    serenite: 'üíú',
    elegance: 'üíó',
    joie: 'üíö'
  };

  const profileDisplayNames = {
    reconfort: 'R√©confort',
    protection: 'Protection',
    serenite: 'S√©r√©nit√©',
    elegance: '√âl√©gance',
    joie: 'Joie de vivre'
  };

  function init() {
    const loadingEl = document.getElementById('dashboard-loading');
    const noProfileEl = document.getElementById('dashboard-no-profile');
    const hasProfileEl = document.getElementById('dashboard-has-profile');

    // Lire depuis localStorage
    const lastResultRaw = localStorage.getItem('milauraLastResult');

    // Masquer loading
    if (loadingEl) loadingEl.style.display = 'none';

    if (!lastResultRaw) {
      // Pas de profil
      if (noProfileEl) noProfileEl.style.display = 'block';
      return;
    }

    try {
      const data = JSON.parse(lastResultRaw);

      // Afficher le profil
      if (hasProfileEl) hasProfileEl.style.display = 'block';

      // Icon
      const iconEl = document.getElementById('profile-icon');
      if (iconEl && data.profileId) {
        iconEl.textContent = profileIcons[data.profileId] || '‚ú®';
      }

      // Nom
      const nameEl = document.getElementById('profile-name');
      if (nameEl) {
        nameEl.textContent = data.profileName || profileDisplayNames[data.profileId] || 'Votre profil';
      }

      // Date
      const dateEl = document.getElementById('profile-date');
      if (dateEl && data.timestamp) {
        const date = new Date(data.timestamp);
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        dateEl.textContent = date.toLocaleDateString('fr-FR', options);
      }

      // Pierre
      const stoneEl = document.getElementById('profile-stone');
      if (stoneEl && data.stone) {
        stoneEl.textContent = data.stone;
      }

      // Senteur
      const scentEl = document.getElementById('profile-scent');
      if (scentEl && data.scent) {
        scentEl.textContent = data.scent;
      }

      // Bougie (si produit handle existe)
      if (data.productHandle || data.productTitle) {
        const candleCardEl = document.getElementById('dashboard-candle-card');
        if (candleCardEl) candleCardEl.style.display = 'flex';

        const candleTitleEl = document.getElementById('candle-title');
        if (candleTitleEl) {
          candleTitleEl.textContent = data.productTitle || 'Votre bougie';
        }

        const candleLinkEl = document.getElementById('candle-link');
        if (candleLinkEl && data.productHandle) {
          candleLinkEl.href = '/products/' + data.productHandle;
        }
      }

      // M√©t√©o √©motionnelle
      const moodBarsEl = document.getElementById('dashboard-mood-bars');
      if (moodBarsEl && data.percentages) {
        moodBarsEl.innerHTML = '';

        // Trier par pourcentage
        const sorted = Object.entries(data.percentages)
          .sort((a, b) => b[1] - a[1]);

        sorted.forEach(([profileId, percent], index) => {
          const bar = document.createElement('div');
          bar.className = 'dashboard-mood-bar';

          const isWinner = index === 0;
          bar.innerHTML = `
            <span class="mood-bar-label">
              <span>${profileIcons[profileId] || '‚óã'}</span>
              ${profileDisplayNames[profileId] || profileId}
            </span>
            <div class="mood-bar-track">
              <div class="mood-bar-fill ${isWinner ? '' : 'is-secondary'}" style="width: 0%"></div>
            </div>
            <span class="mood-bar-percent">${percent}%</span>
          `;

          moodBarsEl.appendChild(bar);

          // Animer
          setTimeout(() => {
            const fill = bar.querySelector('.mood-bar-fill');
            if (fill) fill.style.width = percent + '%';
          }, 100 + (index * 100));
        });
      }

    } catch (e) {
      console.error('Erreur parsing profil:', e);
      if (noProfileEl) noProfileEl.style.display = 'block';
    }
  }

  // Bouton refaire le quiz
  document.addEventListener('DOMContentLoaded', function() {
    init();

    const restartBtn = document.getElementById('dashboard-restart-quiz');
    if (restartBtn) {
      restartBtn.addEventListener('click', function() {
        // Option: clear localStorage et redirect
        // localStorage.removeItem('milauraLastResult');
        window.location.href = '/pages/diagnostic-emotionnel';
      });
    }
  });
})();
</script>
{%- endif -%}
