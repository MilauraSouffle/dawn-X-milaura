{% comment %}
  MILAURA PRODUCT CTA FINAL
  Recap: nom + prix + CTA
  2-3 badges r√©assurance
  Derni√®re chance conversion avant footer
{% endcomment %}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant

  assign show_promo = false
  if current_variant.compare_at_price > current_variant.price
    assign show_promo = true
  endif

  assign stock_level = 'available'
  if current_variant.inventory_quantity <= 0
    assign stock_level = 'out_of_stock'
  elsif current_variant.inventory_quantity <= 5
    assign stock_level = 'low_stock'
  endif
-%}

<section
  id="MilauraProductCtaFinal-{{ section.id }}"
  class="milaura-product-cta-final"
  data-section-id="{{ section.id }}"
>
  <div class="milaura-product-cta-final__container">

    <div class="milaura-product-cta-final__content">

      {%- if section.settings.show_title -%}
        <h2 class="milaura-product-cta-final__title">
          {{ section.settings.title }}
        </h2>
      {%- endif -%}

      {%- comment -%} Recap produit {%- endcomment -%}
      <div class="milaura-product-cta-final__product">
        {%- if product.featured_image -%}
          <div class="milaura-product-cta-final__image">
            {{
              product.featured_image
              | image_url: width: 200
              | image_tag:
                loading: 'lazy',
                class: 'milaura-product-cta-final__img',
                alt: product.title | escape
            }}
          </div>
        {%- endif -%}

        <div class="milaura-product-cta-final__details">
          <h3 class="milaura-product-cta-final__product-title">
            {{ product.title | escape }}
          </h3>

          <div class="milaura-product-cta-final__price-wrapper">
            {%- if show_promo -%}
              <span class="milaura-product-cta-final__price milaura-product-cta-final__price--sale">
                {{ current_variant.price | money }}
              </span>
              <span class="milaura-product-cta-final__price milaura-product-cta-final__price--compare">
                {{ current_variant.compare_at_price | money }}
              </span>
            {%- else -%}
              <span class="milaura-product-cta-final__price">
                {{ current_variant.price | money }}
              </span>
            {%- endif -%}
          </div>
        </div>
      </div>

      {%- comment -%} CTA {%- endcomment -%}
      {%- assign cta_form_id = 'MilauraCtaFinalForm-' | append: section.id -%}
      {%- form 'product', product, id: cta_form_id, class: 'milaura-product-cta-final__form' -%}
        <input type="hidden" name="id" value="{{ current_variant.id }}">
        <input type="hidden" name="quantity" value="1">

        <button
          type="submit"
          name="add"
          class="milaura-product-cta-final__cta milaura-btn-gold"
          {% if stock_level == 'out_of_stock' %}disabled{% endif %}
          data-cta-final-add
        >
          {% if stock_level == 'out_of_stock' %}
            {{ section.settings.button_text_sold_out | default: 'Rupture de stock' }}
          {% else %}
            {{ section.settings.button_text | default: 'Ajouter au panier' }}
          {% endif %}
        </button>
      {%- endform -%}

      {%- comment -%} Badges r√©assurance {%- endcomment -%}
      {%- if section.settings.show_badges -%}
        <div class="milaura-product-cta-final__badges">
          {%- if section.settings.badge_1 != blank -%}
            <div class="milaura-product-cta-final__badge">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              {{ section.settings.badge_1 }}
            </div>
          {%- endif -%}
          {%- if section.settings.badge_2 != blank -%}
            <div class="milaura-product-cta-final__badge">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              {{ section.settings.badge_2 }}
            </div>
          {%- endif -%}
          {%- if section.settings.badge_3 != blank -%}
            <div class="milaura-product-cta-final__badge">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              {{ section.settings.badge_3 }}
            </div>
          {%- endif -%}
        </div>
      {%- endif -%}

    </div>

  </div>
</section>

<style>
  .milaura-product-cta-final {
    padding: 20px 0;
    background: transparent;
    position: relative;
    overflow: hidden;
  }

  .milaura-product-cta-final__container {
    max-width: 700px;
    margin: 0 auto;
    padding: 0 var(--milaura-spacing-md, 24px);
    position: relative;
    z-index: 1;
  }

  .milaura-product-cta-final__content {
    display: flex;
    flex-direction: column;
    gap: var(--milaura-spacing-lg, 36px);
    align-items: center;
    text-align: center;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(192, 160, 98, 0.3);
    border-radius: var(--milaura-border-radius, 20px);
    padding: var(--milaura-spacing-xl, 48px) var(--milaura-spacing-lg, 36px);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
  }

  .milaura-product-cta-final__title {
    font-family: var(--milaura-font-heading);
    font-size: {{ section.settings.title_size }}px;
    font-weight: 600;
    color: {{ section.settings.title_color }};
    margin: 0;
  }

  .milaura-product-cta-final__product {
    display: flex;
    align-items: center;
    gap: var(--milaura-spacing-md, 24px);
  }

  .milaura-product-cta-final__image {
    flex-shrink: 0;
    width: 80px;
    height: 80px;
    border-radius: 12px;
    overflow: hidden;
    background: #F2E8D5;
  }

  .milaura-product-cta-final__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .milaura-product-cta-final__details {
    flex: 1;
    text-align: left;
  }

  .milaura-product-cta-final__product-title {
    font-size: {{ section.settings.product_title_size }}px;
    font-weight: 600;
    color: {{ section.settings.product_title_color }};
    margin: 0 0 var(--milaura-spacing-xs, 6px) 0;
  }

  .milaura-product-cta-final__price-wrapper {
    display: flex;
    align-items: center;
    gap: var(--milaura-spacing-xs, 6px);
  }

  .milaura-product-cta-final__price {
    font-size: {{ section.settings.price_size }}px;
    font-weight: 600;
    color: {{ section.settings.price_color }};
  }

  .milaura-product-cta-final__price--sale {
    color: {{ section.settings.price_sale_color }};
  }

  .milaura-product-cta-final__price--compare {
    font-size: 16px;
    font-weight: 400;
    text-decoration: line-through;
    opacity: 0.6;
  }

  .milaura-product-cta-final__form {
    width: 100%;
  }

  .milaura-product-cta-final__cta {
    width: 100%;
    /* On laisse .milaura-btn-gold g√©rer le style */
    border: none;
    cursor: pointer;
  }

  .milaura-product-cta-final__cta:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #ccc !important;
    box-shadow: none !important;
  }

  .milaura-product-cta-final__badges {
    display: flex;
    flex-direction: column;
    gap: var(--milaura-spacing-xs, 6px);
    font-size: 14px;
    color: var(--milaura-text, #000000);
    opacity: 0.85;
  }

  .milaura-product-cta-final__badge {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .milaura-product-cta-final__badge svg {
    flex-shrink: 0;
    color: var(--milaura-gold, #C0A062);
  }

  /* Desktop */
  @media screen and (min-width: 768px) {
    .milaura-product-cta-final__title {
      font-size: 36px;
    }

    .milaura-product-cta-final__image {
      width: 100px;
      height: 100px;
    }

    .milaura-product-cta-final__product-title {
      font-size: 20px;
    }

    .milaura-product-cta-final__price {
      font-size: 24px;
    }

    .milaura-product-cta-final__cta {
      font-size: 20px;
      padding: 20px 48px;
    }

    .milaura-product-cta-final__badges {
      flex-direction: row;
      justify-content: center;
      gap: var(--milaura-spacing-lg, 36px);
      font-size: 15px;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .milaura-product-cta-final::before {
      animation: none;
    }

    .milaura-product-cta-final__cta {
      transition: none;
    }
  }
</style>

<script>
(function() {
  const sectionId = '{{ section.id }}';
  const section = document.getElementById('MilauraProductCtaFinal-' + sectionId);
  if (!section) return;

  const form = section.querySelector('.milaura-product-cta-final__form');

  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      const formData = new FormData(form);

      fetch('/cart/add.js', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        // Trigger cart update event
        document.dispatchEvent(new CustomEvent('cart:updated'));

        // Visual feedback
        const submitBtn = form.querySelector('[data-cta-final-add]');
        if (submitBtn) {
          const originalText = submitBtn.textContent;
          submitBtn.textContent = '‚úì Ajout√© au panier !';
          submitBtn.style.background = '#4CAF50';

          setTimeout(function() {
            submitBtn.textContent = originalText;
            submitBtn.style.background = '';
          }, 3000);
        }

        // Scroll to top (optional)
        if (window.scrollY > 500) {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      })
      .catch(error => {
        console.error('Erreur ajout panier:', error);

        const submitBtn = form.querySelector('[data-cta-final-add]');
        if (submitBtn) {
          const originalText = submitBtn.textContent;
          submitBtn.textContent = 'Erreur, r√©essaye';
          submitBtn.style.background = '#f44336';

          setTimeout(function() {
            submitBtn.textContent = originalText;
            submitBtn.style.background = '';
          }, 3000);
        }
      });
    });
  }
})();
</script>

{% schema %}
{
  "name": "Milaura Product CTA Final",
  "class": "milaura-section",
  "settings": [
    {
      "type": "header",
      "content": "üìù Titre"
    },
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Afficher le titre",
      "default": true
    },
    {
      "type": "text",
      "id": "title",
      "label": "Titre",
      "default": "Pr√™t¬∑e √† commencer ton rituel ?"
    },
    {
      "type": "header",
      "content": "‚úèÔ∏è Style Titre"
    },
    {
      "type": "range",
      "id": "title_size",
      "label": "Taille du titre",
      "min": 22,
      "max": 44,
      "step": 1,
      "unit": "px",
      "default": 28
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Couleur du titre",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "‚úèÔ∏è Style Produit"
    },
    {
      "type": "range",
      "id": "product_title_size",
      "label": "Taille nom produit",
      "min": 14,
      "max": 26,
      "step": 1,
      "unit": "px",
      "default": 18
    },
    {
      "type": "color",
      "id": "product_title_color",
      "label": "Couleur nom produit",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "price_size",
      "label": "Taille prix",
      "min": 16,
      "max": 30,
      "step": 1,
      "unit": "px",
      "default": 20
    },
    {
      "type": "color",
      "id": "price_color",
      "label": "Couleur prix",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "price_sale_color",
      "label": "Couleur prix promo",
      "default": "#C0A062"
    },
    {
      "type": "header",
      "content": "üõí Bouton d'achat"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Texte du bouton",
      "default": "Ajouter au panier"
    },
    {
      "type": "text",
      "id": "button_text_sold_out",
      "label": "Texte si rupture",
      "default": "Rupture de stock"
    },
    {
      "type": "header",
      "content": "‚úÖ Badges de r√©assurance"
    },
    {
      "type": "checkbox",
      "id": "show_badges",
      "label": "Afficher les badges",
      "default": true
    },
    {
      "type": "text",
      "id": "badge_1",
      "label": "Badge 1",
      "default": "Livraison offerte d√®s 50‚Ç¨"
    },
    {
      "type": "text",
      "id": "badge_2",
      "label": "Badge 2",
      "default": "Paiement s√©curis√©"
    },
    {
      "type": "text",
      "id": "badge_3",
      "label": "Badge 3",
      "default": "Retour gratuit 30 jours"
    }
  ],
  "presets": [
    {
      "name": "Milaura Product CTA Final"
    }
  ]
}
{% endschema %}
