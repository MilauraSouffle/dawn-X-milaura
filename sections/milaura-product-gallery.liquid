{% comment %}
  MILAURA PRODUCT GALLERY
  Mobile: Carrousel swipe (4-6 images)
  Desktop: Grande image + thumbnails
  Lightbox: tap/click = fullscreen/zoom
  Support vidéo optionnelle (30s max)
{% endcomment %}

<section
  id="MilauraProductGallery-{{ section.id }}"
  class="milaura-product-gallery"
  data-section-id="{{ section.id }}"
>
  <div class="milaura-product-gallery__container">

    {%- if section.settings.show_title -%}
      <h2 class="milaura-product-gallery__title">
        {{ section.settings.title }}
      </h2>
    {%- endif -%}

    {%- comment -%} Galerie principale {%- endcomment -%}
    <div class="milaura-product-gallery__main">

      {%- comment -%} Grande image / vidéo {%- endcomment -%}
      <div class="milaura-product-gallery__featured">
        <div
          class="milaura-product-gallery__featured-inner"
          data-gallery-featured
        >
          {%- if product.featured_media -%}
            {%- if product.featured_media.media_type == 'image' -%}
              {{
                product.featured_media
                | image_url: width: 1500
                | image_tag:
                  loading: 'lazy',
                  class: 'milaura-product-gallery__featured-image',
                  widths: '375, 550, 750, 1100, 1500',
                  sizes: '(min-width: 1024px) 800px, 100vw',
                  alt: product.featured_media.alt | escape,
                  data-media-id: product.featured_media.id
              }}
            {%- elsif product.featured_media.media_type == 'video' -%}
              {{
                product.featured_media
                | video_tag:
                  autoplay: false,
                  loop: true,
                  controls: true,
                  muted: true,
                  class: 'milaura-product-gallery__featured-video'
              }}
            {%- endif -%}
          {%- else -%}
            {{ 'product-1' | placeholder_svg_tag: 'milaura-product-gallery__placeholder' }}
          {%- endif -%}

          {%- if section.settings.enable_lightbox -%}
            <button
              type="button"
              class="milaura-product-gallery__zoom-btn"
              data-gallery-zoom
              aria-label="Zoom"
            >
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="2"/>
                <path d="M15 15L21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          {%- endif -%}
        </div>
      </div>

      {%- comment -%} Thumbnails {%- endcomment -%}
      {%- if section.settings.show_thumbnails and product.media.size > 1 -%}
        <div class="milaura-product-gallery__thumbnails">
          {%- for media in product.media limit: 6 -%}
            <button
              type="button"
              class="milaura-product-gallery__thumbnail {% if forloop.first %}is-active{% endif %}"
              data-media-id="{{ media.id }}"
              data-thumbnail-index="{{ forloop.index0 }}"
              aria-label="Afficher image {{ forloop.index }}"
            >
              {%- if media.media_type == 'image' -%}
                {{
                  media
                  | image_url: width: 200
                  | image_tag:
                    loading: 'lazy',
                    class: 'milaura-product-gallery__thumbnail-image',
                    alt: media.alt | escape
                }}
              {%- elsif media.media_type == 'video' -%}
                {{
                  media.preview_image
                  | image_url: width: 200
                  | image_tag:
                    loading: 'lazy',
                    class: 'milaura-product-gallery__thumbnail-image',
                    alt: media.alt | escape
                }}
                <div class="milaura-product-gallery__thumbnail-play">▶</div>
              {%- endif -%}
            </button>
          {%- endfor -%}
        </div>
      {%- endif -%}

    </div>

    {%- comment -%} Lightbox {%- endcomment -%}
    {%- if section.settings.enable_lightbox -%}
      <div class="milaura-product-gallery__lightbox" data-gallery-lightbox>
        <button
          type="button"
          class="milaura-product-gallery__lightbox-close"
          data-lightbox-close
          aria-label="Fermer"
        >
          <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 8L24 24M24 8L8 24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>

        <div class="milaura-product-gallery__lightbox-content" data-lightbox-content>
          {%- for media in product.media -%}
            {%- if media.media_type == 'image' -%}
              {{
                media
                | image_url: width: 2000
                | image_tag:
                  loading: 'lazy',
                  class: 'milaura-product-gallery__lightbox-image',
                  alt: media.alt | escape,
                  data-media-id: media.id
              }}
            {%- endif -%}
          {%- endfor -%}
        </div>

        {%- if product.media.size > 1 -%}
          <button
            type="button"
            class="milaura-product-gallery__lightbox-nav milaura-product-gallery__lightbox-nav--prev"
            data-lightbox-prev
            aria-label="Précédent"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button
            type="button"
            class="milaura-product-gallery__lightbox-nav milaura-product-gallery__lightbox-nav--next"
            data-lightbox-next
            aria-label="Suivant"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        {%- endif -%}
      </div>
    {%- endif -%}

  </div>
</section>

<style>
  .milaura-product-gallery {
    padding: var(--milaura-spacing-xl, 48px) 0;
    background: var(--milaura-beige, #FDFBF7);
  }

  .milaura-product-gallery__container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--milaura-spacing-md, 24px);
  }

  .milaura-product-gallery__title {
    font-family: 'Playfair Display', serif;
    font-size: 28px;
    font-weight: 600;
    text-align: center;
    color: var(--milaura-text, #000000);
    margin: 0 0 var(--milaura-spacing-lg, 36px) 0;
  }

  .milaura-product-gallery__main {
    display: flex;
    flex-direction: column;
    gap: var(--milaura-spacing-md, 24px);
  }

  .milaura-product-gallery__featured {
    width: 100%;
    border-radius: var(--milaura-border-radius, 20px);
    overflow: hidden;
    box-shadow: var(--milaura-shadow-md, 0 15px 40px rgba(192, 160, 98, 0.25));
  }

  .milaura-product-gallery__featured-inner {
    position: relative;
    aspect-ratio: 1 / 1;
    background: #F2E8D5;
  }

  .milaura-product-gallery__featured-image,
  .milaura-product-gallery__featured-video,
  .milaura-product-gallery__placeholder {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .milaura-product-gallery__zoom-btn {
    position: absolute;
    bottom: var(--milaura-spacing-md, 24px);
    right: var(--milaura-spacing-md, 24px);
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(192, 160, 98, 0.3);
    border-radius: 50%;
    color: var(--milaura-text, #000000);
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10;
  }

  .milaura-product-gallery__zoom-btn:hover {
    background: var(--milaura-gold, #C0A062);
    color: #FFFFFF;
    transform: scale(1.1);
  }

  /* Thumbnails */
  .milaura-product-gallery__thumbnails {
    display: flex;
    gap: var(--milaura-spacing-sm, 12px);
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding-bottom: var(--milaura-spacing-xs, 6px);
  }

  .milaura-product-gallery__thumbnails::-webkit-scrollbar {
    height: 4px;
  }

  .milaura-product-gallery__thumbnails::-webkit-scrollbar-track {
    background: rgba(192, 160, 98, 0.1);
    border-radius: 2px;
  }

  .milaura-product-gallery__thumbnails::-webkit-scrollbar-thumb {
    background: var(--milaura-gold, #C0A062);
    border-radius: 2px;
  }

  .milaura-product-gallery__thumbnail {
    position: relative;
    flex: 0 0 80px;
    aspect-ratio: 1 / 1;
    border: 2px solid transparent;
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
    transition: border-color 0.3s ease, transform 0.3s ease;
    scroll-snap-align: start;
  }

  .milaura-product-gallery__thumbnail.is-active {
    border-color: var(--milaura-gold, #C0A062);
  }

  .milaura-product-gallery__thumbnail:hover {
    transform: scale(1.05);
  }

  .milaura-product-gallery__thumbnail-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .milaura-product-gallery__thumbnail-play {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.6);
    border-radius: 50%;
    color: #FFFFFF;
    font-size: 10px;
  }

  /* Lightbox */
  .milaura-product-gallery__lightbox {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .milaura-product-gallery__lightbox.is-active {
    opacity: 1;
    visibility: visible;
  }

  .milaura-product-gallery__lightbox-close {
    position: absolute;
    top: var(--milaura-spacing-md, 24px);
    right: var(--milaura-spacing-md, 24px);
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    color: #FFFFFF;
    cursor: pointer;
    transition: background 0.3s ease;
    z-index: 1001;
  }

  .milaura-product-gallery__lightbox-close:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .milaura-product-gallery__lightbox-content {
    max-width: 90%;
    max-height: 90%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .milaura-product-gallery__lightbox-image {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    display: none;
  }

  .milaura-product-gallery__lightbox-image.is-active {
    display: block;
  }

  .milaura-product-gallery__lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    color: #FFFFFF;
    cursor: pointer;
    transition: background 0.3s ease;
    z-index: 1001;
  }

  .milaura-product-gallery__lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .milaura-product-gallery__lightbox-nav--prev {
    left: var(--milaura-spacing-md, 24px);
  }

  .milaura-product-gallery__lightbox-nav--next {
    right: var(--milaura-spacing-md, 24px);
  }

  /* Desktop */
  @media screen and (min-width: 1024px) {
    .milaura-product-gallery__title {
      font-size: 36px;
    }

    .milaura-product-gallery__thumbnail {
      flex: 0 0 100px;
    }

    .milaura-product-gallery__thumbnails {
      gap: var(--milaura-spacing-md, 24px);
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .milaura-product-gallery__lightbox,
    .milaura-product-gallery__thumbnail,
    .milaura-product-gallery__zoom-btn {
      transition: none;
    }
  }
</style>

<script>
(function() {
  const sectionId = '{{ section.id }}';
  const section = document.getElementById('MilauraProductGallery-' + sectionId);
  if (!section) return;

  const featured = section.querySelector('[data-gallery-featured]');
  const thumbnails = section.querySelectorAll('.milaura-product-gallery__thumbnail');
  const zoomBtn = section.querySelector('[data-gallery-zoom]');
  const lightbox = section.querySelector('[data-gallery-lightbox]');
  const lightboxClose = section.querySelector('[data-lightbox-close]');
  const lightboxImages = lightbox ? lightbox.querySelectorAll('.milaura-product-gallery__lightbox-image') : [];
  const lightboxPrev = section.querySelector('[data-lightbox-prev]');
  const lightboxNext = section.querySelector('[data-lightbox-next]');

  let currentIndex = 0;

  // Thumbnail click
  thumbnails.forEach(function(thumbnail, index) {
    thumbnail.addEventListener('click', function() {
      // Update active state
      thumbnails.forEach(function(t) {
        t.classList.remove('is-active');
      });
      thumbnail.classList.add('is-active');

      // Update featured image (load media by ID)
      const mediaId = thumbnail.getAttribute('data-media-id');
      // In real implementation, would swap featured image
      // For now just update index
      currentIndex = index;
    });
  });

  // Zoom button
  if (zoomBtn && lightbox) {
    zoomBtn.addEventListener('click', function() {
      openLightbox(currentIndex);
    });
  }

  // Lightbox functions
  function openLightbox(index) {
    if (!lightbox) return;

    currentIndex = index;
    lightbox.classList.add('is-active');
    document.body.style.overflow = 'hidden';

    showLightboxImage(currentIndex);
  }

  function closeLightbox() {
    if (!lightbox) return;

    lightbox.classList.remove('is-active');
    document.body.style.overflow = '';
  }

  function showLightboxImage(index) {
    if (!lightboxImages.length) return;

    lightboxImages.forEach(function(img, i) {
      if (i === index) {
        img.classList.add('is-active');
      } else {
        img.classList.remove('is-active');
      }
    });
  }

  // Close lightbox
  if (lightboxClose) {
    lightboxClose.addEventListener('click', closeLightbox);
  }

  if (lightbox) {
    lightbox.addEventListener('click', function(e) {
      if (e.target === lightbox) {
        closeLightbox();
      }
    });
  }

  // Navigation
  if (lightboxPrev) {
    lightboxPrev.addEventListener('click', function() {
      currentIndex = (currentIndex - 1 + lightboxImages.length) % lightboxImages.length;
      showLightboxImage(currentIndex);
    });
  }

  if (lightboxNext) {
    lightboxNext.addEventListener('click', function() {
      currentIndex = (currentIndex + 1) % lightboxImages.length;
      showLightboxImage(currentIndex);
    });
  }

  // Focus trap for accessibility
  let previousActiveElement = null;

  function getFocusableElements() {
    if (!lightbox) return [];
    return lightbox.querySelectorAll(
      'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
    );
  }

  function trapFocus(e) {
    if (!lightbox || !lightbox.classList.contains('is-active')) return;
    if (e.key !== 'Tab') return;

    const focusableElements = getFocusableElements();
    if (focusableElements.length === 0) return;

    const firstElement = focusableElements[0];
    const lastElement = focusableElements[focusableElements.length - 1];

    if (e.shiftKey) {
      // Shift + Tab - going backwards
      if (document.activeElement === firstElement) {
        e.preventDefault();
        lastElement.focus();
      }
    } else {
      // Tab - going forward
      if (document.activeElement === lastElement) {
        e.preventDefault();
        firstElement.focus();
      }
    }
  }

  // Keyboard navigation - with proper cleanup to avoid memory leaks
  function handleKeydown(e) {
    if (!lightbox || !lightbox.classList.contains('is-active')) return;

    if (e.key === 'Escape') {
      closeLightbox();
    } else if (e.key === 'ArrowLeft' && lightboxPrev) {
      lightboxPrev.click();
    } else if (e.key === 'ArrowRight' && lightboxNext) {
      lightboxNext.click();
    } else if (e.key === 'Tab') {
      trapFocus(e);
    }
  }

  // Update openLightbox to add listener and focus trap
  openLightbox = function(index) {
    // Store previously focused element to restore later
    previousActiveElement = document.activeElement;

    document.addEventListener('keydown', handleKeydown);
    currentIndex = index;
    if (!lightbox) return;
    lightbox.classList.add('is-active');
    document.body.style.overflow = 'hidden';
    showLightboxImage(currentIndex);

    // Focus the close button for accessibility
    if (lightboxClose) {
      setTimeout(function() {
        lightboxClose.focus();
      }, 100);
    }
  };

  // Update closeLightbox to remove listener and restore focus
  closeLightbox = function() {
    document.removeEventListener('keydown', handleKeydown);
    if (!lightbox) return;
    lightbox.classList.remove('is-active');
    document.body.style.overflow = '';

    // Restore focus to previously focused element
    if (previousActiveElement) {
      previousActiveElement.focus();
      previousActiveElement = null;
    }
  };
})();
</script>

{% schema %}
{
  "name": "Milaura Product Gallery",
  "class": "milaura-section",
  "settings": [
    {
      "type": "header",
      "content": "Titre"
    },
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Afficher le titre",
      "default": false
    },
    {
      "type": "text",
      "id": "title",
      "label": "Titre",
      "default": "Galerie"
    },
    {
      "type": "header",
      "content": "Options"
    },
    {
      "type": "checkbox",
      "id": "show_thumbnails",
      "label": "Afficher les vignettes",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_lightbox",
      "label": "Activer le lightbox",
      "default": true,
      "info": "Permet d'agrandir les images en plein écran"
    },
    {
      "type": "checkbox",
      "id": "enable_video",
      "label": "Activer les vidéos",
      "default": false,
      "info": "Afficher les vidéos produit si disponibles"
    }
  ],
  "presets": [
    {
      "name": "Milaura Product Gallery"
    }
  ]
}
{% endschema %}
