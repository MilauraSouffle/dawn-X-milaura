{% comment %}
  MILAURA MASTERCLASS V4 - FINAL UX
  - Layout Side-by-Side (Gain de place)
  - Prix Rituals Box
  - Urgence Bleu Nuit
  - Typographie XXL
{% endcomment %}

{%- style -%}
  /* --- 1. LAYOUT GLOBAL --- */
  .milaura-product-section {
    padding-top: {{ section.settings.padding_top | default: 180 }}px; /* Descendu encore plus */
    padding-bottom: {{ section.settings.padding_bottom | default: 60 }}px;
    background: linear-gradient(180deg, #fff 0%, #faf9f6 100%);
  }

  .milaura-product-wrapper {
    max-width: 1400px; /* Plus large pour aÃ©rer */
    margin: 0 auto;
    padding: 0 30px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 80px; /* Espace central */
    align-items: start;
  }

  /* --- 2. MEDIA (GAUCHE) & STICKER --- */
  .product-media-gallery { position: sticky; top: 150px; }
  .main-image-wrapper {
    border-radius: 30px; overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.08);
    border: 1px solid rgba(212, 175, 55, 0.2);
    position: relative; aspect-ratio: 4 / 5; background: #f4f4f4;
  }
  .main-product-image { width: 100%; height: 100%; object-fit: cover; }

  /* LE STICKER (BADGE) */
  .product-badge-sticker {
    position: absolute; top: 20px; left: 20px;
    background: #c0a062; color: #fff;
    padding: 8px 16px; border-radius: 50px;
    font-size: 0.9rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    z-index: 10;
  }

  /* --- 3. TYPOGRAPHIE (XXL) --- */
  .product-info-wrapper { color: #333; }

  .product-subtitle {
    text-transform: uppercase; letter-spacing: 2px;
    font-size: 1rem; /* + Grand */
    color: #c0a062; font-weight: 700; margin-bottom: 8px;
  }

  .product-title {
    font-family: var(--milaura-font-heading, "Playfair Display", serif);
    font-size: 4rem; /* TITRE ENORME */
    line-height: 1.1; color: #1a1a1a; margin: 0 0 10px 0;
  }

  /* --- 4. LAYOUT COMPACT (COTE A COTE) --- */
  .split-layout-container {
    display: grid;
    grid-template-columns: 1fr 1.2fr; /* IdentitÃ© Ã  gauche, BÃ©nÃ©fices Ã  droite */
    gap: 20px;
    margin: 25px 0;
    align-items: start;
  }

  /* IdentitÃ© (Compacte) */
  .identity-card-compact {
    background: rgba(255, 255, 255, 0.5);
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: 16px; padding: 15px;
    display: flex; flex-direction: column; gap: 12px;
  }
  .id-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #ddd; padding-bottom: 5px; }
  .id-row:last-child { border: none; padding: 0; }
  .id-label { font-size: 0.85rem; color: #888; text-transform: uppercase; }
  .id-val { font-weight: 700; color: #1a1a1a; font-size: 1rem; }

  /* BÃ©nÃ©fices (Compact) */
  .benefits-compact { padding-left: 10px; }
  .benefits-compact h3 { font-size: 1.1rem; font-weight: 700; margin: 0 0 10px 0; font-family: var(--milaura-font-heading, serif); }
  .benefits-item { display: flex; gap: 10px; margin-bottom: 8px; font-size: 1.1rem; line-height: 1.4; color: #444; }
  .check-icon { color: #c0a062; flex-shrink: 0; }

  /* --- 5. URGENCE (BLEU & ELEGANT) --- */
  .urgency-container {
    margin: 20px 0;
  }
  .stock-status {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;
    font-weight: 700; font-size: 1.1rem;
  }
  /* BLEU NUIT : Visible mais classe */
  .stock-text { color: #1e3a8a; display: flex; align-items: center; gap: 8px; }
  .sales-text { color: #666; font-size: 1rem; font-style: italic; }

  .progress-bar-bg { width: 100%; height: 4px; background: #e0e0e0; border-radius: 10px; overflow: hidden; }
  .progress-bar-fill {
    height: 100%;
    background: #c0a062; /* Ligne dorÃ©e */
    transition: width 1.5s ease-out;
  }

  /* --- 6. PRIX RITUALS & BOUTON --- */
  .conversion-area {
    background: #fff;
    border: 1px solid #f0f0f0;
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.05);
    margin-top: 30px;
  }

  .price-box-rituals {
    background: #fdfbf7;
    border: 1px solid #e8e0c9;
    padding: 15px;
    border-radius: 12px;
    text-align: center;
    margin-bottom: 20px;
    display: flex; justify-content: center; align-items: baseline; gap: 10px;
  }
  .final-price { font-size: 2.2rem; font-weight: 700; color: #000; font-family: var(--milaura-font-heading, serif); }
  .old-price { font-size: 1.4rem; text-decoration: line-through; color: #999; }

  .add-to-cart-btn {
    width: 100%;
    background: linear-gradient(135deg, #d4af37 0%, #c5a059 100%);
    color: #fff;
    font-size: 1.3rem; /* TrÃ¨s lisible */
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 22px;
    border: none;
    border-radius: 100px;
    cursor: pointer;
    box-shadow: 0 10px 30px rgba(197, 160, 89, 0.4);
    transition: all 0.3s;
  }
  .add-to-cart-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(197, 160, 89, 0.5); }

  /* --- 7. AVIS (Au dessus du bouton) --- */
  .reviews-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 15px; font-size: 0.95rem; color: #555;
  }
  .stars-gold { color: #c0a062; font-size: 1.2rem; }

  /* --- 8. BUNDLES (Plus gros) --- */
  .bundle-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px; }
  .bundle-option {
    border: 1px solid #ddd; border-radius: 12px; padding: 12px 5px; text-align: center; cursor: pointer;
    transition: all 0.2s; background: #fff;
  }
  .bundle-option.active { border: 2px solid #c0a062; background: #fffaf0; }
  .bundle-qty { font-size: 1.4rem; font-weight: 800; display: block; }
  .bundle-label { font-size: 0.9rem; color: #555; }

  /* --- 9. ACCORDEONS --- */
  .accordion-group { margin-top: 50px; border-top: 1px solid #eee; }
  .accordion-header {
    padding: 25px 0; font-size: 1.3rem; /* Plus gros */
    display: flex; justify-content: space-between; align-items: center;
    background: none; border: none; border-bottom: 1px solid #eee; width: 100%; cursor: pointer; text-align: left;
    font-family: var(--milaura-font-heading, serif);
  }
  .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; opacity: 0; padding: 0; font-size: 1.1rem; line-height: 1.7; }
  .accordion-content.open { opacity: 1; padding-bottom: 25px; }

  /* --- MOBILE --- */
  @media screen and (max-width: 990px) {
    .milaura-product-section { padding-top: 140px; }
    .milaura-product-wrapper { grid-template-columns: 1fr; gap: 40px; }
    .product-title { font-size: 2.8rem; }
    .split-layout-container { grid-template-columns: 1fr; gap: 20px; } /* Stack sur mobile */
    .add-to-cart-btn {
      position: sticky; bottom: 20px; z-index: 999;
      width: calc(100% - 40px); left: 20px; margin: 0 auto;
      box-shadow: 0 5px 25px rgba(0,0,0,0.3);
      padding: 18px; font-size: 1.1rem;
    }
  }
{%- endstyle -%}

{% assign random_sales = 'now' | date: '%S' | modulo: 15 | plus: 18 %}
{% assign inventory_qty = product.selected_or_first_available_variant.inventory_quantity %}
{% if inventory_qty <= 0 %}{% assign inventory_qty = 7 %}{% endif %}
{% assign progress_width = inventory_qty | times: 100 | divided_by: 20 %}
{% if progress_width > 100 %}{% assign progress_width = 100 %}{% endif %}

<section class="milaura-product-section" id="MainProduct-{{ section.id }}">
  <div class="milaura-product-wrapper">
    <div class="product-media-gallery">
      <div class="main-image-wrapper">
        {% if section.settings.sticker_text != blank %}
          <div class="product-badge-sticker">{{ section.settings.sticker_text }}</div>
        {% endif %}

        {% if product.featured_media %}
          <img
            src="{{ product.featured_media | image_url: width: 1000 }}"
            alt="{{ product.title }}"
            class="main-product-image"
            loading="eager"
          >
        {% else %}
          {{ 'product-1' | placeholder_svg_tag: 'main-product-image' }}
        {% endif %}
      </div>
    </div>

    <div class="product-info-wrapper">
      {% if product.metafields.custom.subtitle %}
        <div class="product-subtitle">{{ product.metafields.custom.subtitle }}</div>
      {% endif %}
      <h1 class="product-title">{{ product.title }}</h1>

      <div style="margin-bottom:20px; font-size:1rem; color:#666;">
        <span style="color:#c0a062">â˜…â˜…â˜…â˜…â˜…</span> 4.9/5 (120+ avis)
      </div>

      {% if product.has_only_default_variant == false %}
        <div class="variant-selector" style="margin-bottom:20px;">
          <label style="display:block; font-weight:700; margin-bottom:8px;">Variante :</label>
          {% for variant in product.variants %}
            <span style="display:inline-block; padding:8px 15px; border:1px solid #ddd; border-radius:4px; margin-right:5px; cursor:pointer; font-size:0.9rem;">
              {{ variant.title }}
            </span>
          {% endfor %}
        </div>
      {% endif %}

      <div class="urgency-container">
        <div class="stock-status">
          <span class="stock-text">ðŸ”µ Plus que {{ inventory_qty }} piÃ¨ces en stock !</span>
          <span class="sales-text">{{ random_sales }} ventes aujourd'hui</span>
        </div>
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" style="width: {{ progress_width }}%;"></div>
        </div>
      </div>

      <div class="split-layout-container">
        {% if product.metafields.custom.stone %}
          <div class="identity-card-compact">
            <div class="id-row">
              <span class="id-label">Pierre</span> <span class="id-val">{{ product.metafields.custom.stone }}</span>
            </div>
            <div class="id-row">
              <span class="id-label">QualitÃ©</span>
              <span class="id-val">{{ product.metafields.custom.quality | default: 'AA+' }}</span>
            </div>
            <div class="id-row">
              <span class="id-label">Origine</span>
              <span class="id-val">{{ product.metafields.custom.origin | default: 'Monde' }}</span>
            </div>
          </div>
        {% endif %}

        {% if product.metafields.custom.benefits %}
          <div class="benefits-compact">
            <h3>{{ section.settings.benefits_title }}</h3>
            {% assign benefits = product.metafields.custom.benefits | split: 'â€¢' %}
            {% for benefit in benefits %}
              <div class="benefits-item"><span class="check-icon">âœ”</span> {{ benefit | strip }}</div>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="conversion-area">
        <div class="reviews-header">
          <span>Excellent</span>
          <span class="stars-gold">â˜…â˜…â˜…â˜…â˜…</span>
          <span>BasÃ© sur 124 avis</span>
        </div>

        {% form 'product', product %}
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

          <div class="bundle-selector">
            <div class="bundle-option active" onclick="selectBundle(1, this)">
              <span class="bundle-qty">1</span><span class="bundle-label">UnitÃ©</span>
            </div>
            <div class="bundle-option" onclick="selectBundle(2, this)">
              <span class="bundle-qty">2</span><span class="bundle-label">Duo</span>
            </div>
            <div class="bundle-option" onclick="selectBundle(3, this)">
              <span class="bundle-qty">3</span><span class="bundle-label">Offre Cadeau</span>
            </div>
          </div>
          <input type="number" id="Quantity-{{ section.id }}" name="quantity" value="1" min="1" style="display:none;">

          <div class="price-box-rituals">
            <span class="final-price">{{ product.price | money }}</span>
            {% if product.compare_at_price > product.price %}
              <span class="old-price">{{ product.compare_at_price | money }}</span>
            {% endif %}
          </div>

          <button type="submit" name="add" class="add-to-cart-btn">Ajouter au panier</button>
        {% endform %}

        {% if section.settings.reassurance_text %}
          <div style="text-align:center; margin-top:15px; font-size:0.9rem; color:#888;">
            {{ section.settings.reassurance_text }}
          </div>
        {% endif %}
      </div>

      <div class="accordion-group">
        <button class="accordion-header" onclick="toggleAcc(this)">Description & Histoire <span>+</span></button>
        <div class="accordion-content open" style="max-height: 500px; opacity:1;">{{ product.description }}</div>

        <button class="accordion-header" onclick="toggleAcc(this)">DÃ©tails techniques <span>+</span></button>
        <div class="accordion-content">{{ section.settings.technical_details }}</div>

        <button class="accordion-header" onclick="toggleAcc(this)">Livraison & Retours <span>+</span></button>
        <div class="accordion-content">{{ section.settings.shipping_returns }}</div>
      </div>
    </div>
  </div>
</section>

<script>
  function toggleAcc(btn) {
    btn.classList.toggle('active');
    var panel = btn.nextElementSibling;
    if (panel.style.maxHeight) {
      panel.style.maxHeight = null;
      panel.classList.remove('open');
      btn.querySelector('span').innerText = '+';
    } else {
      panel.style.maxHeight = panel.scrollHeight + 'px';
      panel.classList.add('open');
      btn.querySelector('span').innerText = '-';
    }
  }

  function selectBundle(qty, element) {
    var input = document.getElementById('Quantity-{{ section.id }}');
    if (input) input.value = qty;
    var options = document.querySelectorAll('.bundle-option');
    options.forEach(function (opt) {
      opt.classList.remove('active');
    });
    element.classList.add('active');
  }
</script>

{% schema %}
{
  "name": "Milaura Masterclass V4",
  "settings": [
    {
      "type": "text",
      "id": "sticker_text",
      "label": "Texte Badge Image",
      "default": "Fait Main"
    },
    {
      "type": "text",
      "id": "benefits_title",
      "label": "Titre BÃ©nÃ©fices",
      "default": "Pourquoi elle est faite pour toi :"
    },
    {
      "type": "text",
      "id": "reassurance_text",
      "label": "Texte Rassurance",
      "default": "ðŸšš ExpÃ©dition 24/48h - Satisfait ou remboursÃ©"
    },
    {
      "type": "richtext",
      "id": "technical_details",
      "label": "Contenu DÃ©tails Techniques",
      "default": "<p>Cire de soja 100% naturelle.</p>"
    },
    {
      "type": "richtext",
      "id": "shipping_returns",
      "label": "Contenu Livraison",
      "default": "<p>Livraison offerte dÃ¨s 2 bougies.</p>"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 250,
      "step": 10,
      "unit": "px",
      "label": "Marge Haut",
      "default": 180
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Marge Bas",
      "default": 60
    }
  ],
  "presets": [{ "name": "Milaura Masterclass V4" }]
}
{% endschema %}
