{% comment %}
  MILAURA MASTERCLASS V16 - PROD READY
  - Design : V15 (Valid√©)
  - Patch A (Associ√©) : S√©curisation des listes de b√©n√©fices (ignorer lignes vides).
  - Mobile : Titre au-dessus de l'image.
  - Desktop : Layout optimis√©.
{% endcomment %}

{%- style -%}
  /* --- 1. LAYOUT GLOBAL --- */
  .milaura-product-section {
    padding-top: {{ section.settings.padding_top | default: 60 }}px;
    padding-bottom: {{ section.settings.padding_bottom | default: 60 }}px;
    background: linear-gradient(180deg, #fff 0%, #faf9f6 100%);
  }

  .milaura-product-wrapper {
    max-width: 1400px; margin: 0 auto; padding: 0 30px;
    display: grid; grid-template-columns: 1fr 1fr; gap: 60px; align-items: start;
  }

  /* --- STYLE DU TITRE BULLE DOR√âE - Application du design system milaura-pill --- */
  /* NEUTRALISATION des styles locaux pour laisser le design system global s'appliquer */
  .product-title-bubble.milaura-pill {
    background: initial !important;
    color: initial !important;
    font-family: initial !important;
    font-size: initial !important;
    line-height: initial !important;
    padding: initial !important;
    border-radius: initial !important;
    display: initial !important;
    box-shadow: initial !important;
    margin: 0 0 10px 0; /* Garde uniquement le margin-bottom */
  }

  /* Ajustement sp√©cifique pour le titre (taille de texte) */
  .product-title-bubble.milaura-pill {
    font-size: 2.2rem;
    line-height: 1.2;
  }
  .product-subtitle {
    text-transform: uppercase; letter-spacing: 2px; font-size: 0.9rem;
    color: #c0a062; font-weight: 700; margin-bottom: 5px; display: block;
  }

  /* GESTION AFFICHAGE MOBILE/DESKTOP */
  .mobile-title-wrapper { display: none; } /* Cach√© sur PC */
  .desktop-title-wrapper { display: block; } /* Visible sur PC */

  /* --- 2. COLONNE GAUCHE (MEDIA) --- */
  .product-left-col { position: sticky; top: 120px; }

  .main-image-wrapper {
    border-radius: 30px; overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.08);
    border: 1px solid rgba(212, 175, 55, 0.2);
    position: relative; aspect-ratio: 4 / 5; background: #f4f4f4; margin-bottom: 25px;
  }
  .main-product-image { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s; }

  /* NEUTRALISATION des styles locaux pour laisser le design system global s'appliquer */
  .product-badge-sticker.milaura-pill {
    position: absolute; top: 20px; left: 20px; z-index: 10; /* Garde uniquement le positionnement */
    background: initial !important;
    color: initial !important;
    padding: initial !important;
    border-radius: initial !important;
    font-size: initial !important;
    font-weight: initial !important;
    text-transform: initial !important;
    letter-spacing: initial !important;
    box-shadow: initial !important;
  }

  /* Ajustement sp√©cifique pour le sticker (taille plus petite) */
  .product-badge-sticker.milaura-pill {
    font-size: 0.8rem;
    padding: 8px 16px;
    min-width: auto;
    min-height: auto;
  }

  /* VARIANTES SOUS PHOTO */
  .variants-under-photo { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
  .variant-pill {
    display: flex; align-items: center; gap: 8px;
    border: 1px solid #ddd; border-radius: 8px; padding: 8px 15px;
    cursor: pointer; background: #fff; transition: all 0.2s;
  }
  .variant-pill:hover { border-color: #c0a062; }
  .variant-pill.active { border: 1px solid #c0a062; background: #fffaf0; box-shadow: 0 2px 10px rgba(192, 160, 98, 0.2); }
  .variant-thumb { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; background: #eee; }
  .variant-name { font-size: 0.9rem; font-weight: 600; color: #333; }

  /* --- 3. COLONNE DROITE (INFOS) --- */
  .product-info-wrapper { color: #333; font-size: 1.1rem; display: flex; flex-direction: column; gap: 20px; }

  /* --- 4. METAFIELDS COTE A COTE --- */
  .split-layout-container { display: grid; grid-template-columns: 1fr 1.2fr; gap: 25px; align-items: start; }
  .identity-card-compact { background: rgba(255, 255, 255, 0.5); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 16px; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
  .id-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #ddd; padding-bottom: 5px; }
  .id-row:last-child { border: none; padding: 0; }
  .id-label { font-size: 0.85rem; color: #888; text-transform: uppercase; }
  .id-val { font-weight: 700; color: #1a1a1a; font-size: 1rem; }
  .benefits-compact h3 { font-size: 1.2rem; font-weight: 700; margin: 0 0 10px 0; font-family: var(--milaura-font-heading, serif); }
  .benefits-item { display: flex; gap: 10px; margin-bottom: 8px; font-size: 1.1rem; line-height: 1.4; color: #444; }
  .check-icon { color: #c0a062; flex-shrink: 0; }

  /* --- 5. URGENCE (BLEU) --- */
  .urgency-container { margin: 10px 0; }
  .stock-status { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-weight: 700; font-size: 1.1rem; }
  .stock-text { color: #1e3a8a; display: flex; align-items: center; gap: 8px; }
  .sales-text { color: #666; font-size: 1rem; font-style: italic; }
  .progress-bar-bg { width: 100%; height: 4px; background: #e0e0e0; border-radius: 10px; overflow: hidden; }
  .progress-bar-fill { height: 100%; background: #c0a062; transition: width 1.5s ease-out; }

  /* --- 6. AVIS T√âMOINS --- */
  .reviews-preview-block { margin: 10px 0; padding: 20px; background: #fff; border-radius: 20px; border: 1px solid #f0f0f0; box-shadow: 0 5px 20px rgba(0,0,0,0.03); }
  .global-rating-header { text-align: center; margin-bottom: 15px; font-weight: 700; color: #c0a062; font-size: 1.1rem; }
  .review-item { display: flex; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
  .review-item:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }
  .reviewer-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #c0a062; flex-shrink: 0; }
  .review-content strong { display: block; font-size: 1rem; color: #1a1a1a; margin-bottom: 2px;}
  .review-content p { font-size: 1rem; margin: 0; color: #555; font-style: italic; line-height: 1.4; }
  .stars-gold { color: #c0a062; }

  /* --- 7. ZONE CONVERSION --- */
  .conversion-area { margin-top: 10px; background: #fff; padding: 25px; border-radius: 20px; border: 1px solid #e8e0c9; box-shadow: 0 10px 40px rgba(212, 175, 55, 0.1); }

  .price-offer-split { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; align-items: center; margin-bottom: 25px; }
  .price-box-final { background: #fdfbf7; border: 1px solid #e8e0c9; padding: 15px; border-radius: 12px; text-align: center; }
  .final-price { font-size: 2rem; font-weight: 700; color: #000; display:block; line-height:1; font-family: var(--milaura-font-heading, serif);}

  .offer-hook-container { text-align: center; }
  /* NEUTRALISATION des styles locaux pour laisser le design system global s'appliquer */
  .offer-hook-badge.milaura-pill {
    background: initial !important;
    color: initial !important;
    font-weight: initial !important;
    font-size: initial !important;
    padding: initial !important;
    border-radius: initial !important;
    display: initial !important;
    text-transform: initial !important;
    letter-spacing: initial !important;
    box-shadow: initial !important;
  }

  /* Ajustement sp√©cifique pour le badge (taille et style) */
  .offer-hook-badge.milaura-pill {
    font-size: 0.9rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 10px 20px;
    min-width: auto;
    min-height: auto;
  }

  /* BUNDLES */
  .bundle-selector-v6 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
  .bundle-option-v6 {
    border: 2px solid #eee; border-radius: 12px; padding: 15px; cursor: pointer; transition: all 0.3s; background: #fff; position: relative; overflow: hidden;
  }
  .bundle-option-v6.active { border-color: #c0a062; background: #fffaf0; box-shadow: 0 5px 15px rgba(192, 160, 98, 0.2); }
  .bundle-title-v6 { font-weight: 800; font-size: 1.1rem; color: #1a1a1a; display: block; margin-bottom: 5px; }
  .bundle-gifts-v6 { font-size: 0.95rem; color: #555; line-height: 1.4; }
  .gift-highlight { color: #d32f2f; font-weight: 700; }
  /* NEUTRALISATION des styles locaux pour laisser le design system global s'appliquer */
  .bundle-badge.milaura-pill {
    position: absolute; top: 0; right: 0; border-bottom-left-radius: 10px; /* Garde uniquement le positionnement */
    background: initial !important;
    color: initial !important;
    font-size: initial !important;
    padding: initial !important;
    font-weight: initial !important;
    border-radius: initial !important;
  }

  /* Ajustement sp√©cifique pour le badge bundle (taille tr√®s petite) */
  .bundle-badge.milaura-pill {
    font-size: 0.7rem;
    padding: 3px 8px;
    min-width: auto;
    min-height: auto;
    border-radius: 0 0 0 10px; /* Garde le border-bottom-left-radius */
  }

  /* BOUTON - Application du design system milaura-cta */
  /* NEUTRALISATION des styles locaux pour laisser le design system global s'appliquer */
  .add-to-cart-btn.milaura-cta {
    width: 100%; /* Garde uniquement le width */
    background: initial !important;
    color: initial !important;
    font-size: initial !important;
    font-weight: initial !important;
    text-transform: initial !important;
    letter-spacing: initial !important;
    padding: initial !important;
    border: initial !important;
    border-radius: initial !important;
    cursor: initial !important;
    box-shadow: initial !important;
    transition: initial !important;
  }

  /* Force le texte noir sur le CTA */
  .add-to-cart-btn.milaura-cta {
    color: #000 !important;
  }

  /* Ajustement sp√©cifique pour le bouton (taille de texte plus grande) */
  .add-to-cart-btn.milaura-cta {
    font-size: 1.3rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* --- 8. ACCORDEONS --- */
  .accordion-group { margin-top: 20px; border-top: 1px solid #eee; }
  .accordion-header { padding: 25px 0; font-size: 1.3rem; display: flex; justify-content: space-between; align-items: center; background: none; border: none; border-bottom: 1px solid #eee; width: 100%; cursor: pointer; text-align: left; font-family: var(--milaura-font-heading, serif); }
  .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; opacity: 0; padding: 0; font-size: 1.1rem; line-height: 1.7; }
  .accordion-content.open { opacity: 1; padding-bottom: 25px; }

  /* --- MOBILE SPECIFIQUE --- */
  @media screen and (max-width: 990px) {
    .milaura-product-wrapper { grid-template-columns: 1fr; gap: 30px; }

    /* ASTUCE MOBILE : ON AFFICHE LE TITRE AU DESSUS */
    .mobile-title-wrapper { display: block; text-align: center; margin-bottom: 20px; }
    .desktop-title-wrapper { display: none; }

    .product-title-bubble { font-size: 1.8rem; padding: 10px 20px; width: 100%; box-sizing: border-box; }

    .split-layout-container { grid-template-columns: 1fr; gap: 20px; }
    .price-offer-split { grid-template-columns: 1fr; text-align: center; gap: 15px;}
    .bundle-selector-v6 { grid-template-columns: 1fr; }
    .add-to-cart-btn {
      position: sticky; bottom: 20px; z-index: 999; width: calc(100% - 40px); left: 20px; margin: 0 auto; box-shadow: 0 5px 25px rgba(0,0,0,0.3); padding: 18px;
    }
  }
{%- endstyle -%}

{% assign random_sales = 'now' | date: '%S' | modulo: 15 | plus: 18 %}
{% assign inventory_qty = product.selected_or_first_available_variant.inventory_quantity %}
{% if inventory_qty <= 0 %}{% assign inventory_qty = 7 %}{% endif %}
{% assign progress_width = inventory_qty | times: 100 | divided_by: 20 %}
{% if progress_width > 100 %}{% assign progress_width = 100 %}{% endif %}

<section class="milaura-product-section" id="MainProduct-{{ section.id }}">
  <div class="milaura-product-wrapper">
    <div class="mobile-title-wrapper">
      {% if product.metafields.custom.subtitle %}
        <span class="product-subtitle">{{ product.metafields.custom.subtitle }}</span>
      {% endif %}
      <h1 class="product-title-bubble milaura-pill">{{ product.title }}</h1>
    </div>

    <div class="product-left-col">
      <div class="main-image-wrapper">
        {% if section.settings.sticker_text != blank %}
          <div class="product-badge-sticker milaura-pill">{{ section.settings.sticker_text }}</div>
        {% endif %}
        <img
          id="MainImg-{{ section.id }}"
          src="{{ product.featured_media | image_url: width: 1000 }}"
          alt="{{ product.title }}"
          class="main-product-image"
          loading="eager"
        >
      </div>

      {% unless product.has_only_default_variant %}
        <div class="variants-under-photo">
          {% for variant in product.variants %}
            <div
              class="variant-pill {% if forloop.first %}active{% endif %}"
              onclick="selectVariant('{{ variant.id }}', '{{ variant.price | money }}', '{% if variant.compare_at_price > variant.price %}{{ variant.compare_at_price | money }}{% endif %}', '{{ variant.featured_media | image_url: width: 800 }}', this)"
            >
              {% if variant.featured_media %}
                <img
                  src="{{ variant.featured_media | image_url: width: 60 }}"
                  class="variant-thumb"
                  alt="{{ variant.title }}"
                >
              {% endif %}
              <span class="variant-name">{{ variant.title }}</span>
            </div>
          {% endfor %}
        </div>
      {% endunless %}
    </div>

    <div class="product-info-wrapper">
      <div class="desktop-title-wrapper title-bubble-wrapper">
        {% if product.metafields.custom.subtitle %}
          <span class="product-subtitle">{{ product.metafields.custom.subtitle }}</span>
        {% endif %}
        <h1 class="product-title-bubble milaura-pill">{{ product.title }}</h1>
      </div>

      <div class="split-layout-container">
        {% if product.metafields.custom.stone %}
          <div class="identity-card-compact">
            <div class="id-row">
              <span class="id-label">Pierre</span> <span class="id-val">{{ product.metafields.custom.stone }}</span>
            </div>
            <div class="id-row">
              <span class="id-label">Qualit√©</span>
              <span class="id-val">{{ product.metafields.custom.quality | default: 'AA+' }}</span>
            </div>
            <div class="id-row">
              <span class="id-label">Origine</span>
              <span class="id-val">{{ product.metafields.custom.origin | default: 'Monde' }}</span>
            </div>
          </div>
        {% endif %}
        {% if product.metafields.custom.benefits %}
          <div class="benefits-compact">
            <h3>{{ section.settings.benefits_title }}</h3>
            {% assign benefits = product.metafields.custom.benefits | split: '‚Ä¢' %}
            {% for benefit in benefits %}
              {% assign b_clean = benefit | strip %}
              {% if b_clean != blank %}
                <div class="benefits-item"><span class="check-icon">‚úî</span> {{ b_clean }}</div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="urgency-container">
        <div class="stock-status">
          <span class="stock-text">üîµ Plus que {{ inventory_qty }} pi√®ces en stock !</span>
          <span class="sales-text">{{ random_sales }} ventes aujourd'hui</span>
        </div>
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" style="width: {{ progress_width }}%;"></div>
        </div>
      </div>

      <div class="reviews-preview-block">
        <div class="global-rating-header">Note globale : <span class="stars-gold">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span> 4.9/5 (120+ avis)</div>
        <div class="review-item">
          <img src="https://i.pravatar.cc/150?img=32" alt="Sophie" class="reviewer-avatar">
          <div class="review-content">
            <strong>Sophie D. <span class="stars-gold">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span></strong>
            <p>"Cette bougie a chang√© l'√©nergie de mon salon. L'am√©thyste est magnifique !"</p>
          </div>
        </div>
        <div class="review-item">
          <img src="https://i.pravatar.cc/150?img=68" alt="Marc" class="reviewer-avatar">
          <div class="review-content">
            <strong>Marc L. <span class="stars-gold">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span></strong>
            <p>"Emballage soign√©, odeur divine. Ma femme adore."</p>
          </div>
        </div>
      </div>

      <div class="conversion-area">
        {% form 'product', product %}
          <input
            type="hidden"
            id="MainVariantId"
            name="id"
            value="{{ product.selected_or_first_available_variant.id }}"
          >

          <div class="price-offer-split">
            <div class="price-box-final">
              <span class="final-price" id="PriceDisplay">{{ product.price | money }}</span>
            </div>
            <div class="offer-hook-container">
              <span class="offer-hook-badge milaura-pill">üî• Boostez votre rituel & √©conomisez</span>
            </div>
          </div>

          <div class="bundle-selector-v6">
            <div class="bundle-option-v6" onclick="selectBundle(2, this)">
              <span class="bundle-badge milaura-pill">POPULAIRE</span>
              <span class="bundle-title-v6">OFFRE DUO RITUEL (x2)</span>
              <div class="bundle-gifts-v6">
                üéÅ Sauge OFFERTE<br>
                üöö <span class="gift-highlight">Livraison OFFERTE</span>
              </div>
            </div>
            <div class="bundle-option-v6" onclick="selectBundle(3, this)">
              <span class="bundle-badge milaura-pill">MEILLEURE OFFRE</span>
              <span class="bundle-title-v6">OFFRE TRIO PRESTIGE (x3)</span>
              <div class="bundle-gifts-v6">
                üéÅ Sauge + Livraison OFFERTES<br>
                ‚ú® <span class="gift-highlight">-10% de REMISE IMM√âDIATE</span>
              </div>
            </div>
          </div>
          <input type="number" id="Quantity-{{ section.id }}" name="quantity" value="1" min="1" style="display:none;">

          <button type="submit" name="add" class="add-to-cart-btn milaura-cta">Ajouter au panier</button>
        {% endform %}
      </div>

      <div class="accordion-group">
        <button class="accordion-header" onclick="toggleAcc(this)">Description & Histoire <span>+</span></button>
        <div class="accordion-content open" style="max-height: 500px; opacity:1;">{{ product.description }}</div>
        <button class="accordion-header" onclick="toggleAcc(this)">D√©tails techniques <span>+</span></button>
        <div class="accordion-content">{{ section.settings.technical_details }}</div>
        <button class="accordion-header" onclick="toggleAcc(this)">Livraison & Retours <span>+</span></button>
        <div class="accordion-content">{{ section.settings.shipping_returns }}</div>
      </div>
    </div>
  </div>
</section>

<script>
  function toggleAcc(btn) {
    btn.classList.toggle('active');
    var panel = btn.nextElementSibling;
    if (panel.style.maxHeight) {
      panel.style.maxHeight = null;
      panel.classList.remove('open');
      btn.querySelector('span').innerText = '+';
    } else {
      panel.style.maxHeight = panel.scrollHeight + 'px';
      panel.classList.add('open');
      btn.querySelector('span').innerText = '-';
    }
  }

  function selectBundle(qty, element) {
    var input = document.getElementById('Quantity-{{ section.id }}');
    if (input) input.value = qty;
    var options = document.querySelectorAll('.bundle-option-v6');
    options.forEach(function (opt) {
      opt.classList.remove('active');
    });
    element.classList.add('active');
  }

  function selectVariant(id, price, comparePrice, image, element) {
    document.getElementById('MainVariantId').value = id;
    document.getElementById('PriceDisplay').innerHTML = price;
    if (image && image.length > 0 && image.indexOf('no-image') === -1) {
      document.getElementById('MainImg-{{ section.id }}').src = image;
    }
    var pills = document.querySelectorAll('.variant-pill');
    pills.forEach((p) => p.classList.remove('active'));
    element.classList.add('active');
  }
</script>

{% schema %}
{
  "name": "Milaura Masterclass V16",
  "settings": [
    {
      "type": "text",
      "id": "sticker_text",
      "label": "Texte Badge Image",
      "default": "Fait Main"
    },
    {
      "type": "text",
      "id": "benefits_title",
      "label": "Titre B√©n√©fices",
      "default": "Pourquoi elle est faite pour toi :"
    },
    {
      "type": "richtext",
      "id": "technical_details",
      "label": "Contenu D√©tails Techniques",
      "default": "<p>Cire de soja 100% naturelle.</p>"
    },
    {
      "type": "richtext",
      "id": "shipping_returns",
      "label": "Contenu Livraison",
      "default": "<p>Livraison offerte d√®s 2 bougies.</p>"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 300,
      "step": 10,
      "unit": "px",
      "label": "Marge Haut",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Marge Bas",
      "default": 60
    }
  ],
  "presets": [{ "name": "Milaura Masterclass V16" }]
}
{% endschema %}
