{% comment %}
  MILAURA MASTERCLASS V22
  - CTA above the fold desktop (scroll to offers)
  - Smart mobile dock with IntersectionObserver
  - Bundles can be real variants (UNITÉ / DUO / TRIO) OR fallback quantity
  - More reassurance, less friction
  - Description moved into clean accordions
{% endcomment %}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
  href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600&family=Playfair+Display:wght@400;700&family=Lato:wght@400;700&display=swap"
  rel="stylesheet"
>

{%- style -%}
  :root {
    --gold-gradient: linear-gradient(
      135deg,
      rgba(255, 240, 200, 0.92) 0%,
      rgba(214, 176, 96, 0.92) 18%,
      rgba(255, 232, 172, 0.92) 42%,
      rgba(176, 130, 48, 0.92) 70%,
      rgba(255, 240, 200, 0.92) 100%
    );
    --gold-border: rgba(214, 176, 96, 0.55);
    --gold-solid: #d6b060;
    --black-ink: #000000;
    --bg-color: #fffefa;
  }

  .milaura-section {
    background-color: var(--bg-color);
    padding-top: 130px;
    padding-bottom: 170px; /* important: laisse respirer sous le dock mobile */
    overflow-x: hidden;
  }

  .milaura-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px;
  }

  h1.product-title {
    font-family: 'Dancing Script', cursive;
    font-weight: 500;
    font-size: 38px;
    line-height: 1.1;
    color: var(--black-ink);
    margin: 10px 0;
    text-align: left;
  }

  .section-label {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--black-ink);
    margin-bottom: 10px;
    border-bottom: 2px solid #f0e6d2;
    display: inline-block;
    padding-bottom: 2px;
  }

  .gallery-wrapper {
    position: relative;
    margin-bottom: 25px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
  }

  .gallery-wrapper img {
    width: 100%;
    height: auto;
    border-radius: 20px;
    border: 1px solid rgba(214, 176, 96, 0.3);
    display: block;
  }

  .photo-badge {
    position: absolute;
    top: 15px;
    left: 15px;
    background: var(--gold-gradient);
    color: #000;
    font-family: 'Lato', sans-serif;
    font-weight: 700;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 6px 14px;
    border-radius: 20px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    z-index: 10;
  }

  .meta-grid-row {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin: 18px 0 16px;
    width: 100%;
  }

  .meta-card {
    flex: 1;
    background: #fff;
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-radius: 12px;
    padding: 10px 5px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
  }

  .meta-icon {
    font-size: 1.4rem;
    margin-bottom: 5px;
    color: var(--gold-solid);
  }
  .meta-label {
    font-size: 0.7rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .meta-value {
    font-size: 0.85rem;
    font-weight: 700;
    color: #000;
    margin-top: 2px;
    line-height: 1.2;
  }

  .reassurance-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin: 10px 0 18px;
  }
  .reassurance-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: 1px solid rgba(0, 0, 0, 0.06);
    background: rgba(255, 255, 255, 0.8);
    border-radius: 999px;
    padding: 8px 12px;
    font-family: 'Lato', sans-serif;
    font-size: 0.85rem;
    color: #333;
  }
  .reassurance-pill span {
    color: var(--gold-solid);
    font-weight: 800;
  }

  .benefits-block {
    background: linear-gradient(to right, #fffbf0, #ffffff);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 18px;
    border: 1px solid rgba(214, 176, 96, 0.2);
  }

  .benefit-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 10px;
    font-family: 'Lato', sans-serif;
    font-size: 0.95rem;
    color: #333;
  }
  .check-icon {
    color: var(--gold-solid);
    font-weight: bold;
    min-width: 18px;
  }

  .bundle-card {
    border: 1px solid #e0e0e0;
    background: #fff;
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .bundle-card.active {
    border: 2px solid var(--gold-solid);
    border-image: var(--gold-gradient) 1;
    background: #fffdf5;
    box-shadow: 0 5px 15px rgba(214, 176, 96, 0.15);
  }

  .bundle-pill {
    position: absolute;
    top: -10px;
    right: 15px;
    background: var(--gold-gradient);
    color: #000;
    font-size: 0.7rem;
    font-weight: 800;
    padding: 4px 10px;
    border-radius: 10px;
    text-transform: uppercase;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }

  .bundle-sub {
    font-size: 0.85rem;
    color: #666;
    font-family: 'Lato', sans-serif;
    margin-top: 2px;
  }

  .bundle-micro {
    font-size: 0.85rem;
    font-family: 'Lato', sans-serif;
    color: #333;
    margin-top: 10px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(214, 176, 96, 0.2);
    background: rgba(255, 253, 245, 0.7);
  }

  .btn-milaura {
    background: var(--gold-gradient);
    color: #000;
    border: none;
    font-family: 'Lato', sans-serif;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-radius: 50px;
    padding: 0 30px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(176, 130, 48, 0.25);
    transition: transform 0.2s;
    width: 100%;
  }
  .btn-milaura:active {
    transform: scale(0.98);
  }

  .btn-secondary {
    background: transparent;
    border: 1px solid rgba(214, 176, 96, 0.45);
    color: #000;
    font-family: 'Lato', sans-serif;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-radius: 50px;
    padding: 0 18px;
    height: 46px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    width: 100%;
  }

  .desktop-only-btn {
    display: block;
  }
  .mobile-sticky-dock {
    display: flex;
  }

  .accordion-wrap {
    margin-top: 18px;
    border-top: 1px solid rgba(0, 0, 0, 0.06);
  }
  .m-accordion {
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    padding: 12px 0;
  }
  .m-accordion summary {
    cursor: pointer;
    list-style: none;
    font-family: 'Playfair Display', serif;
    font-weight: 700;
    font-size: 1rem;
    color: #000;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .m-accordion summary::-webkit-details-marker {
    display: none;
  }
  .m-accordion summary:after {
    content: '+';
    font-family: 'Lato', sans-serif;
    font-weight: 800;
    color: var(--gold-solid);
  }
  .m-accordion[open] summary:after {
    content: '–';
  }
  .m-accordion .acc-content {
    margin-top: 10px;
    font-family: 'Lato', sans-serif;
    line-height: 1.6;
    color: #444;
    font-size: 0.95rem;
  }

  @media screen and (min-width: 990px) {
    .milaura-section {
      padding-top: 160px;
      padding-bottom: 120px;
    }

    .product-grid-desktop {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 60px;
      align-items: start;
    }

    .desktop-sticky-col {
      position: sticky;
      top: 160px;
      padding-right: 20px;
    }

    h1.product-title {
      font-size: 52px;
    }

    .mobile-sticky-dock {
      display: none !important;
    }
  }

  @media screen and (max-width: 989px) {
    .desktop-only-btn {
      display: none !important;
    }
  }

  .mobile-sticky-dock {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(12px);
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    padding: 12px 20px;
    padding-bottom: max(12px, env(safe-area-inset-bottom));
    z-index: 999;
    align-items: center;
    gap: 15px;
    box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05);
  }
{%- endstyle -%}

{%- comment -%}
  Optional: detect bundle variants by title contains (UNIT / DUO / TRIO)
  If you create 3 variants with correct prices, this section will switch variant ID and keep quantity=1.
  If you keep only one variant, it falls back to quantity (and you should remove any fake discount claims).
{%- endcomment -%}

{% assign v_unit_id = blank %}
{% assign v_duo_id = blank %}
{% assign v_trio_id = blank %}

{% for v in product.variants %}
  {% assign t = v.title | upcase %}
  {% if v_unit_id == blank and (t contains 'UNIT' or t contains 'UNITE' or t contains 'SINGLE') %}
    {% assign v_unit_id = v.id %}
  {% endif %}
  {% if v_duo_id == blank and (t contains 'DUO' or t contains 'X2' or t contains '2') %}
    {% assign v_duo_id = v.id %}
  {% endif %}
  {% if v_trio_id == blank and (t contains 'TRIO' or t contains 'X3' or t contains '3') %}
    {% assign v_trio_id = v.id %}
  {% endif %}
{% endfor %}

<section class="milaura-section" id="MainProduct-{{ section.id }}">
  <div class="milaura-container">
    <div class="product-grid-desktop">
      <div class="visual-col">
        <div class="gallery-wrapper">
          <span class="photo-badge">{{ section.settings.sticker_text | default: 'Fait Main' }}</span>
          <img
            src="{{ product.featured_media | image_url: width: 1200 }}"
            alt="{{ product.title | escape }}"
            loading="eager"
          >
        </div>
      </div>

      <div class="desktop-sticky-col">
        <h1 class="product-title">{{ product.title }}</h1>

        <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
          <span style="color:var(--gold-solid); font-size:1.1rem;">★★★★★</span>
          <span style="font-size:0.9rem; color:#666; font-family:'Lato', sans-serif;">4.9/5 (120 avis)</span>
        </div>

        <div
          style="font-family:'Playfair Display', serif; font-size:2rem; font-weight:700; color:#000; margin-bottom:10px;"
          id="PriceTop"
        >
          {{ product.selected_or_first_available_variant.price | money }}
        </div>

        <div class="reassurance-row">
          <div class="reassurance-pill"><span>✓</span> paiement sécurisé</div>
          <div class="reassurance-pill"><span>✓</span> fait main</div>
          <div class="reassurance-pill"><span>✓</span> support réactif</div>
        </div>

        <div class="desktop-only-btn" style="margin-bottom:14px;">
          <button class="btn-secondary" type="button" onclick="scrollToBundles()">voir les offres</button>
        </div>

        <div class="meta-grid-row">
          <div class="meta-card">
            <span class="meta-icon">✦</span>
            <span class="meta-label">Pierre</span>
            <span class="meta-value">{{ product.metafields.custom.stone | default: 'Améthyste' }}</span>
          </div>
          <div class="meta-card">
            <span class="meta-icon">♕</span>
            <span class="meta-label">Qualité</span>
            <span class="meta-value">Premium</span>
          </div>
          <div class="meta-card">
            <span class="meta-icon">⚓</span>
            <span class="meta-label">Origine</span>
            <span class="meta-value">France</span>
          </div>
        </div>

        <div class="benefits-block">
          <div class="section-label">Pourquoi elle est pour toi ?</div>
          <div style="margin-top:10px;">
            {% if product.metafields.custom.benefits %}
              {% assign benefits = product.metafields.custom.benefits | split: '•' %}
              {% for b in benefits %}
                {% if b != blank %}
                  <div class="benefit-item"><span class="check-icon">✔</span> {{ b | strip }}</div>
                {% endif %}
              {% endfor %}
            {% else %}
              <div class="benefit-item"><span class="check-icon">✔</span> Apaise le stress immédiat</div>
              <div class="benefit-item"><span class="check-icon">✔</span> Favorise un sommeil profond</div>
              <div class="benefit-item"><span class="check-icon">✔</span> Énergie positive durable</div>
            {% endif %}
          </div>
        </div>

        <div id="BundleSectionAnchor"></div>

        <div class="section-label" style="margin-bottom:12px; display:block; text-align:center;">
          choisis ton rituel
        </div>

        {% form 'product', product, id: 'ProductForm', novalidate: 'novalidate' %}
          <input
            type="hidden"
            name="id"
            id="VariantIdInput"
            value="{{ product.selected_or_first_available_variant.id }}"
            data-unit-variant="{{ v_unit_id }}"
            data-duo-variant="{{ v_duo_id }}"
            data-trio-variant="{{ v_trio_id }}"
          >
          <input type="hidden" name="quantity" id="QuantityInput" value="1">

          <div class="bundle-card" data-bundle="unit" onclick="selectBundle('unit', 1, this)">
            <div style="font-weight:700; font-family:'Lato', sans-serif;">unité</div>
            <div class="bundle-sub">découverte simple</div>
          </div>

          <div class="bundle-card active" id="DefaultBundle" data-bundle="duo" onclick="selectBundle('duo', 2, this)">
            <div class="bundle-pill">populaire</div>
            <div style="font-weight:700; font-family:'Lato', sans-serif;">duo (x2)</div>
            <div class="bundle-sub">cadeaux + livraison selon offre</div>
          </div>

          <div class="bundle-card" data-bundle="trio" onclick="selectBundle('trio', 3, this)">
            <div class="bundle-pill">best value</div>
            <div style="font-weight:700; font-family:'Lato', sans-serif;">trio (x3)</div>
            <div class="bundle-sub">cadeaux + livraison selon offre</div>
          </div>

          <div class="bundle-micro" id="BundleMicro">tu as sélectionné: duo (x2)</div>

          <div style="margin-top:14px;" class="desktop-only-btn">
            <button type="submit" class="btn-milaura" id="DesktopCTA">ajouter au panier</button>
          </div>

          <button type="submit" id="RealSubmit" style="display:none;"></button>
        {% endform %}

        <div class="accordion-wrap">
          <details class="m-accordion" open>
            <summary>description</summary>
            <div class="acc-content">
              {{ product.description }}
            </div>
          </details>

          <details class="m-accordion">
            <summary>livraison et retours</summary>
            <div class="acc-content">
              <p>
                mets ici ta promesse réelle (délais, suivi, retours). Si tu veux, on la branche à des metafields pour
                que ça soit propre et scalable.
              </p>
            </div>
          </details>

          <details class="m-accordion">
            <summary>questions fréquentes</summary>
            <div class="acc-content">
              <p>ajoute 3 à 5 réponses ultra courtes: durée, utilisation, entretien, cadeau, effets.</p>
            </div>
          </details>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="mobile-sticky-dock">
  <div style="display:flex; flex-direction:column; min-width:84px;">
    <span style="font-size:0.7rem; text-transform:uppercase; color:#666;">total</span>
    <span style="font-family:'Playfair Display', serif; font-weight:700; font-size:1.2rem;" id="DockPrice">
      {{- product.selected_or_first_available_variant.price | money -}}
    </span>
  </div>
  <button class="btn-milaura" style="flex:1;" id="DockBtn" type="button" onclick="handleDockClick()">
    choisir mon offre
  </button>
</div>

<script>
  (function () {
    const moneyFormat = {{ shop.money_format | json }};
    const productData = {{ product | json }};

    const form = document.getElementById('ProductForm');
    const anchor = document.getElementById('BundleSectionAnchor');
    const dockBtn = document.getElementById('DockBtn');
    const dockPrice = document.getElementById('DockPrice');
    const priceTop = document.getElementById('PriceTop');

    const variantInput = document.getElementById('VariantIdInput');
    const qtyInput = document.getElementById('QuantityInput');

    const micro = document.getElementById('BundleMicro');
    const desktopCTA = document.getElementById('DesktopCTA');

    let currentQty = 2;
    let currentBundleKey = 'duo';
    let bundlesInView = false;

    function formatMoney(cents) {
      // simple money formatter, relies on Shopify money_format string
      const value = (cents / 100).toFixed(2);
      // most EU formats in Shopify will be fine with replace, keeps it simple
      return moneyFormat.replace('{{amount}}', value).replace('{{ amount }}', value);
    }

    function getVariantById(id) {
      return productData.variants.find(v => String(v.id) === String(id));
    }

    function getBundleVariantId(bundleKey) {
      const unit = variantInput.dataset.unitVariant;
      const duo = variantInput.dataset.duoVariant;
      const trio = variantInput.dataset.trioVariant;
      if (bundleKey === 'unit' && unit) return unit;
      if (bundleKey === 'duo' && duo) return duo;
      if (bundleKey === 'trio' && trio) return trio;
      return null;
    }

    function updatePrices() {
      const selectedVariantId = variantInput.value;
      const v = getVariantById(selectedVariantId);

      if (v) {
        const cents = v.price;
        dockPrice.textContent = formatMoney(cents);
        if (priceTop) priceTop.textContent = formatMoney(cents);
      } else {
        // fallback: base variant price * quantity
        const base = productData.variants[0] ? productData.variants[0].price : 0;
        const cents = base * Number(qtyInput.value || 1);
        dockPrice.textContent = formatMoney(cents);
        if (priceTop) priceTop.textContent = formatMoney(productData.variants[0].price || 0);
      }
    }

    window.scrollToBundles = function () {
      if (!anchor) return;
      anchor.scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    window.handleDockClick = function () {
      if (!bundlesInView) {
        window.scrollToBundles();
        return;
      }
      if (form && form.requestSubmit) form.requestSubmit();
      else document.getElementById('RealSubmit').click();
    };

    window.selectBundle = function (bundleKey, qty, el) {
      currentQty = qty;
      currentBundleKey = bundleKey;

      document.querySelectorAll('.bundle-card').forEach(c => c.classList.remove('active'));
      if (el) el.classList.add('active');

      const bundleVariantId = getBundleVariantId(bundleKey);

      if (bundleVariantId) {
        // real bundle variant pricing, keep quantity=1
        variantInput.value = bundleVariantId;
        qtyInput.value = 1;
      } else {
        // fallback: 1 variant only, quantity changes
        qtyInput.value = qty;
      }

      const label = bundleKey === 'unit' ? 'unité' : (bundleKey === 'duo' ? 'duo (x2)' : 'trio (x3)');
      if (micro) micro.textContent = 'tu as sélectionné: ' + label;

      dockBtn.textContent = bundlesInView ? 'ajouter au panier' : 'choisir mon offre';
      if (desktopCTA) desktopCTA.textContent = 'ajouter au panier';

      updatePrices();
    };

    // IntersectionObserver: detect when offers are in view
    if ('IntersectionObserver' in window && anchor) {
      const obs = new IntersectionObserver((entries) => {
        entries.forEach((e) => {
          bundlesInView = e.isIntersecting;
          dockBtn.textContent = bundlesInView ? 'ajouter au panier' : 'choisir mon offre';
        });
      }, { root: null, threshold: 0.15 });

      obs.observe(anchor);
    }

    // init default selection
    window.selectBundle('duo', 2, document.getElementById('DefaultBundle'));
  })();
</script>

{% schema %}
{
  "name": "Milaura Master V22",
  "settings": [{ "type": "text", "id": "sticker_text", "label": "Badge Photo", "default": "Fait Main" }],
  "presets": [{ "name": "Milaura Master V22" }]
}
{% endschema %}
