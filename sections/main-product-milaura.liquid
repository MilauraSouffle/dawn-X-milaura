{% comment %}
  MILAURA MASTERCLASS V3 (CORRIG√â)
  Pixel Perfect - Compatible Cursor & Shopify
{% endcomment %}

{%- style -%}
  /* --- 1. LAYOUT & ESPACEMENT --- */
  .milaura-product-section {
    padding-top: {{ section.settings.padding_top | default: 160 }}px;
    padding-bottom: {{ section.settings.padding_bottom | default: 60 }}px;
    background: linear-gradient(180deg, #fff 0%, #faf9f6 100%);
  }

  .milaura-product-wrapper {
    max-width: 1300px;
    margin: 0 auto;
    padding: 0 20px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 60px;
    align-items: start;
  }

  /* --- 2. TYPO --- */
  .product-info-wrapper { font-size: 1.15rem; line-height: 1.6; color: #333; }

  /* --- 3. MEDIA --- */
  .product-media-gallery { position: sticky; top: 140px; }
  .main-image-wrapper {
    border-radius: 30px; overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.08);
    border: 1px solid rgba(212, 175, 55, 0.2);
    position: relative; aspect-ratio: 4 / 5; background: #f4f4f4;
  }
  .main-product-image { width: 100%; height: 100%; object-fit: cover; }

  /* --- 4. HEADER --- */
  .product-subtitle { text-transform: uppercase; letter-spacing: 2px; font-size: 0.9rem; color: #c0a062; font-weight: 700; margin-bottom: 5px; }
  .product-title { font-family: var(--milaura-font-heading, "Playfair Display", serif); font-size: 3.5rem; line-height: 1.1; color: #1a1a1a; margin: 0 0 15px 0; }
  .product-price-row { display: flex; align-items: baseline; gap: 15px; margin-bottom: 5px; }
  .product-price { font-size: 2rem; color: #c0a062; font-weight: 700; }
  .product-price-compare { text-decoration: line-through; color: #999; font-size: 1.3rem; }
  .price-tax-note { font-size: 0.9rem; color: #888; }

  /* --- 5. IDENTITE --- */
  .identity-card {
    display: flex; justify-content: space-between;
    background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px);
    border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 16px;
    padding: 15px 20px; margin: 20px 0;
  }
  .id-item { flex: 1; text-align: center; border-right: 1px solid rgba(0,0,0,0.05); }
  .id-item:last-child { border-right: none; }
  .id-label { font-size: 0.75rem; text-transform: uppercase; color: #888; letter-spacing: 1px; display: block;}
  .id-value { font-weight: 600; color: #1a1a1a; font-size: 1rem; }

  /* --- 6. URGENCE --- */
  .urgency-container { background: #fffbf0; border: 1px solid #f0e6d2; border-radius: 12px; padding: 20px; margin: 20px 0; }
  .stock-status { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: 700; font-size: 1rem; }
  .stock-text { color: #d32f2f; display: flex; align-items: center; gap: 6px; }
  .sales-text { color: #666; font-size: 0.9rem; font-weight: 500; }
  .progress-bar-bg { width: 100%; height: 8px; background: #eee; border-radius: 10px; overflow: hidden; }
  .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #d32f2f, #ff9800); border-radius: 10px; transition: width 1s ease-out; }

  /* --- 7. BENEFICES --- */
  .benefits-block { margin: 25px 0; }
  .benefits-title { font-weight: 700; font-size: 1.2rem; margin-bottom: 15px; font-family: var(--milaura-font-heading, serif); }
  .benefits-item { display: flex; gap: 12px; margin-bottom: 10px; font-size: 1.1rem; color: #444; }
  .check-icon { color: #c0a062; font-size: 1.2rem; }

  /* --- 8. AVIS --- */
  .reviews-preview-block { margin: 30px 0 10px 0; border-top: 1px dashed #ddd; padding-top: 20px; }
  .review-item { display: flex; gap: 15px; margin-bottom: 15px; background: #fff; padding: 12px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
  .reviewer-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #c0a062; flex-shrink: 0; }
  .review-content strong { display: block; font-size: 0.9rem; color: #1a1a1a; }
  .review-content p { font-size: 0.95rem; margin: 4px 0 0 0; color: #555; font-style: italic; }
  .view-all-reviews { text-align: right; font-size: 0.9rem; color: #c0a062; text-decoration: underline; cursor: pointer; display: block; margin-top: 5px; }

  /* --- 9. BUNDLES --- */
  .bundle-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
  .bundle-option { border: 1px solid #ddd; border-radius: 12px; padding: 10px 5px; text-align: center; cursor: pointer; background: #fff; transition: all 0.2s; position: relative; }
  .bundle-option.active { border-color: #c0a062; background: #fffaf0; box-shadow: 0 0 0 1px #c0a062; }
  .bundle-option:nth-child(3)::after { content: "BEST SELLER"; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #c0a062; color: #fff; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; }
  .bundle-qty { font-weight: 700; font-size: 1.2rem; display: block; color: #1a1a1a; }
  .bundle-label { font-size: 0.75rem; color: #666; display: block; margin-top: 2px;}
  .bundle-gift { font-size: 0.7rem; color: #d32f2f; font-weight: 700; display: block; margin-top: 2px; }

  /* --- 10. BOUTON --- */
  .add-to-cart-btn { width: 100%; background: linear-gradient(135deg, #d4af37 0%, #c5a059 100%); color: #fff; font-size: 1.2rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; padding: 20px; border: none; border-radius: 100px; cursor: pointer; box-shadow: 0 10px 30px rgba(197, 160, 89, 0.4); transition: all 0.3s; }
  .add-to-cart-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(197, 160, 89, 0.5); }

  /* --- 11. ACCORDEONS --- */
  .accordion-group { margin-top: 40px; border-top: 1px solid #eaeaea; }
  .accordion-header { padding: 25px 0; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; background: none; border: none; border-bottom: 1px solid #eaeaea; width: 100%; cursor: pointer; text-align: left; font-family: var(--milaura-font-heading, serif); }
  .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; opacity: 0; padding: 0; }
  .accordion-content.open { opacity: 1; padding-bottom: 25px; font-size: 1.05rem; }

  /* MOBILE */
  @media screen and (max-width: 990px) {
    .milaura-product-section { padding-top: 120px; }
    .milaura-product-wrapper { grid-template-columns: 1fr; gap: 30px; }
    .product-title { font-size: 2.5rem; }
    .add-to-cart-btn { position: sticky; bottom: 20px; z-index: 999; width: calc(100% - 40px); left: 20px; margin: 0 auto; box-shadow: 0 5px 20px rgba(0,0,0,0.3);}
  }
{%- endstyle -%}

{% assign random_sales = 'now' | date: '%S' | modulo: 15 | plus: 18 %}
{% assign inventory_qty = product.selected_or_first_available_variant.inventory_quantity %}
{% if inventory_qty <= 0 %}{% assign inventory_qty = 7 %}{% endif %}
{% assign progress_width = inventory_qty | times: 100 | divided_by: 20 %}
{% if progress_width > 100 %}{% assign progress_width = 100 %}{% endif %}

<section class="milaura-product-section" id="MainProduct-{{ section.id }}">
  <div class="milaura-product-wrapper">
    <div class="product-media-gallery">
      <div class="main-image-wrapper">
        {% if product.featured_media %}
          <img
            src="{{ product.featured_media | image_url: width: 1000 }}"
            alt="{{ product.title | escape }}"
            class="main-product-image"
            loading="eager"
            width="1000"
            height="1250"
          >
        {% else %}
          {{ 'product-1' | placeholder_svg_tag: 'main-product-image' }}
        {% endif %}
      </div>
    </div>

    <div class="product-info-wrapper">
      {% if product.metafields.custom.subtitle %}
        <div class="product-subtitle">{{ product.metafields.custom.subtitle }}</div>
      {% endif %}
      <h1 class="product-title">{{ product.title }}</h1>

      <div class="product-price-row">
        <span class="product-price">{{ product.price | money }}</span>
        {% if product.compare_at_price > product.price %}
          <span class="product-price-compare">{{ product.compare_at_price | money }}</span>
        {% endif %}
      </div>
      <div class="price-tax-note">Taxes incluses.</div>

      {% if product.metafields.custom.stone %}
        <div class="identity-card">
          <div class="id-item">
            <span class="id-label">Pierre</span><span class="id-value">üíé {{ product.metafields.custom.stone }}</span>
          </div>
          <div class="id-item">
            <span class="id-label">Qualit√©</span
            ><span class="id-value">‚ú® {{ product.metafields.custom.quality | default: 'Grade AA+' }}</span>
          </div>
          <div class="id-item">
            <span class="id-label">Origine</span
            ><span class="id-value">üåç {{ product.metafields.custom.origin | default: 'Monde' }}</span>
          </div>
        </div>
      {% endif %}

      {% if product.metafields.custom.benefits %}
        <div class="benefits-block">
          <div class="benefits-title">{{ section.settings.benefits_title }}</div>
          {% assign benefits = product.metafields.custom.benefits | split: '‚Ä¢' %}
          {% for benefit in benefits %}
            <div class="benefits-item"><span class="check-icon">‚úî</span> {{ benefit | strip }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="urgency-container">
        <div class="stock-status">
          <span class="stock-text">üî• Plus que {{ inventory_qty }} pi√®ces en stock !</span>
          <span class="sales-text">{{ random_sales }} ventes aujourd'hui</span>
        </div>
        <div class="progress-bar-bg">
          <div
            class="progress-bar-fill"
            style="width: {{ progress_width }}%; background: {% if inventory_qty < 5 %}#d32f2f{% else %}#ff9800{% endif %};"
          ></div>
        </div>
      </div>

      <div class="reviews-preview-block">
        <div class="review-item">
          <img src="https://i.pravatar.cc/150?img=32" alt="Sophie D." class="reviewer-avatar" width="50" height="50">
          <div class="review-content">
            <strong>Sophie D. <span style="color:#c0a062">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span></strong>
            <p>"Cette bougie a chang√© l'√©nergie de mon salon. L'am√©thyste est magnifique !"</p>
          </div>
        </div>
        <div class="review-item">
          <img src="https://i.pravatar.cc/150?img=5" alt="Marc L." class="reviewer-avatar" width="50" height="50">
          <div class="review-content">
            <strong>Marc L. <span style="color:#c0a062">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span></strong>
            <p>"Emballage soign√©, odeur divine. Ma femme adore."</p>
          </div>
        </div>
        <a href="#looxReviews" class="view-all-reviews">Voir les 124 avis v√©rifi√©s ‚Üì</a>
      </div>

      {% form 'product', product %}
        <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

        <label style="font-weight:700; margin-bottom:10px; display:block;">Choisir votre offre :</label>
        <div class="bundle-selector">
          <div class="bundle-option active" onclick="selectBundle(1, this)">
            <span class="bundle-qty">1</span>
            <span class="bundle-label">D√©couverte</span>
          </div>
          <div class="bundle-option" onclick="selectBundle(2, this)">
            <span class="bundle-qty">2</span>
            <span class="bundle-label">Rituel Duo</span>
            <span class="bundle-gift">Livraison Offerte</span>
          </div>
          <div class="bundle-option" onclick="selectBundle(3, this)">
            <span class="bundle-qty">3</span>
            <span class="bundle-label">Rituel Complet</span>
            <span class="bundle-gift">+ CADEAU & LIVRAISON</span>
          </div>
        </div>

        <input type="number" id="Quantity-{{ section.id }}" name="quantity" value="1" min="1" style="display:none;">

        <button type="submit" name="add" class="add-to-cart-btn">
          Ajouter au panier ‚Ä¢ {{ product.price | money }}
        </button>

        {% if section.settings.reassurance_text %}
          <div style="text-align:center; font-size:0.9rem; color:#666; margin-top:10px;">
            {{ section.settings.reassurance_text }}
          </div>
        {% endif %}
      {% endform %}

      <div class="accordion-group">
        <button class="accordion-header" onclick="toggleAcc(this)">Description & Histoire <span>+</span></button>
        <div class="accordion-content open" style="max-height: 500px; opacity:1;">
          {{ product.description }}
        </div>

        <button class="accordion-header" onclick="toggleAcc(this)">D√©tails techniques <span>+</span></button>
        <div class="accordion-content">{{ section.settings.technical_details }}</div>

        <button class="accordion-header" onclick="toggleAcc(this)">Livraison & Retours <span>+</span></button>
        <div class="accordion-content">{{ section.settings.shipping_returns }}</div>
      </div>
    </div>
  </div>
</section>

<script>
  function toggleAcc(btn) {
    btn.classList.toggle('active');
    var panel = btn.nextElementSibling;
    if (panel.style.maxHeight) {
      panel.style.maxHeight = null;
      panel.classList.remove('open');
      btn.querySelector('span').innerText = '+';
    } else {
      panel.style.maxHeight = panel.scrollHeight + 'px';
      panel.classList.add('open');
      btn.querySelector('span').innerText = '-';
    }
  }

  function selectBundle(qty, element) {
    var input = document.getElementById('Quantity-{{ section.id }}');
    if (input) input.value = qty;

    var options = document.querySelectorAll('.bundle-option');
    options.forEach(function (opt) {
      opt.classList.remove('active');
    });
    element.classList.add('active');
  }
</script>

{% schema %}
{
  "name": "Milaura Masterclass V3",
  "settings": [
    {
      "type": "text",
      "id": "benefits_title",
      "label": "Titre B√©n√©fices",
      "default": "Pourquoi elle est faite pour toi :"
    },
    {
      "type": "text",
      "id": "reassurance_text",
      "label": "Texte Rassurance",
      "default": "üöö Exp√©dition 24/48h - Satisfait ou rembours√©"
    },
    {
      "type": "richtext",
      "id": "technical_details",
      "label": "Contenu D√©tails Techniques",
      "default": "<p>Cire de soja 100% naturelle, m√®che en bois cr√©pitant.</p>"
    },
    {
      "type": "richtext",
      "id": "shipping_returns",
      "label": "Contenu Livraison",
      "default": "<p>Livraison offerte d√®s 2 bougies.</p>"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 200,
      "step": 10,
      "unit": "px",
      "label": "Marge Haut (Menu)",
      "default": 160
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Marge Bas",
      "default": 60
    }
  ],
  "presets": [{ "name": "Milaura Masterclass V3" }]
}
{% endschema %}
