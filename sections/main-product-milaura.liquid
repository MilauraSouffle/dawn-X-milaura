{% comment %}
  MILAURA MASTERCLASS V5 - FINAL FIX
  - Marge Haut corrigÃ©e (220px)
  - Layout Prix/Avis cÃ´te Ã  cÃ´te
  - Retour des Avis TÃ©moins (Avatars)
{% endcomment %}

{%- style -%}
  /* --- 1. LAYOUT GLOBAL --- */
  .milaura-product-section {
    padding-top: {{ section.settings.padding_top | default: 220 }}px; /* MARGE HAUTE AUGMENTÃ‰E */
    padding-bottom: {{ section.settings.padding_bottom | default: 60 }}px;
    background: linear-gradient(180deg, #fff 0%, #faf9f6 100%);
  }

  .milaura-product-wrapper {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 30px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 80px;
    align-items: start;
  }

  /* --- 2. MEDIA (GAUCHE) & STICKER --- */
  .product-media-gallery { position: sticky; top: 150px; }
  .main-image-wrapper {
    border-radius: 30px; overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.08);
    border: 1px solid rgba(212, 175, 55, 0.2);
    position: relative; aspect-ratio: 4 / 5; background: #f4f4f4;
  }
  .main-product-image { width: 100%; height: 100%; object-fit: cover; }

  .product-badge-sticker {
    position: absolute; top: 20px; left: 20px;
    background: #c0a062; color: #fff;
    padding: 8px 16px; border-radius: 50px;
    font-size: 0.9rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    z-index: 10;
  }

  /* --- 3. TYPOGRAPHIE --- */
  .product-info-wrapper { color: #333; font-size: 1.1rem; }
  .product-subtitle { text-transform: uppercase; letter-spacing: 2px; font-size: 1rem; color: #c0a062; font-weight: 700; margin-bottom: 5px; }
  .product-title {
    font-family: var(--milaura-font-heading, "Playfair Display", serif);
    font-size: 3.8rem; line-height: 1.1; color: #1a1a1a; margin: 0 0 20px 0;
  }

  /* --- 4. METAFIELDS COTE A COTE --- */
  .split-layout-container {
    display: grid; grid-template-columns: 1fr 1.2fr; gap: 25px; margin: 25px 0; align-items: start;
  }
  /* IdentitÃ© */
  .identity-card-compact {
    background: rgba(255, 255, 255, 0.5);
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: 16px; padding: 15px;
    display: flex; flex-direction: column; gap: 12px;
  }
  .id-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #ddd; padding-bottom: 5px; }
  .id-row:last-child { border: none; padding: 0; }
  .id-label { font-size: 0.85rem; color: #888; text-transform: uppercase; }
  .id-val { font-weight: 700; color: #1a1a1a; font-size: 1rem; }
  /* BÃ©nÃ©fices */
  .benefits-compact h3 { font-size: 1.2rem; font-weight: 700; margin: 0 0 10px 0; font-family: var(--milaura-font-heading, serif); }
  .benefits-item { display: flex; gap: 10px; margin-bottom: 8px; font-size: 1.1rem; line-height: 1.4; color: #444; }
  .check-icon { color: #c0a062; flex-shrink: 0; }

  /* --- 5. URGENCE (BLEU) --- */
  .urgency-container { margin: 30px 0; }
  .stock-status { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-weight: 700; font-size: 1.1rem; }
  .stock-text { color: #1e3a8a; display: flex; align-items: center; gap: 8px; } /* BLEU */
  .sales-text { color: #666; font-size: 1rem; font-style: italic; }
  .progress-bar-bg { width: 100%; height: 4px; background: #e0e0e0; border-radius: 10px; overflow: hidden; }
  .progress-bar-fill { height: 100%; background: #c0a062; transition: width 1.5s ease-out; }

  /* --- 6. AVIS TÃ‰MOINS (AVATARS) --- */
  .reviews-preview-block {
    margin: 30px 0; padding: 20px;
    background: #fff; border-radius: 20px; border: 1px solid #f0f0f0;
    box-shadow: 0 5px 20px rgba(0,0,0,0.03);
  }
  .review-item { display: flex; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
  .review-item:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }
  .reviewer-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #c0a062; flex-shrink: 0; }
  .review-content strong { display: block; font-size: 1rem; color: #1a1a1a; margin-bottom: 2px;}
  .review-content p { font-size: 1rem; margin: 0; color: #555; font-style: italic; line-height: 1.4; }
  .stars-gold { color: #c0a062; }

  /* --- 7. ZONE ACHAT & PRIX --- */
  .conversion-area {
    margin-top: 30px;
    background: #fff; padding: 20px; border-radius: 20px;
    border: 1px solid #e8e0c9;
  }

  /* LAYOUT PRIX + AVIS LIGNE */
  .price-review-split {
    display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: center; margin-bottom: 20px;
  }

  .price-box-compact {
    background: #fdfbf7; border: 1px solid #e8e0c9; padding: 10px; border-radius: 10px; text-align: center;
  }
  .final-price { font-size: 1.8rem; font-weight: 700; color: #000; display:block; line-height:1; }
  .old-price { font-size: 1rem; text-decoration: line-through; color: #999; }

  .mini-review-stat { text-align: center; font-size: 0.9rem; color: #666; }
  .stars-large { font-size: 1.4rem; color: #c0a062; letter-spacing: 2px; display: block; margin-bottom: 4px; }

  /* BUNDLES */
  .bundle-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
  .bundle-option {
    border: 1px solid #ddd; border-radius: 10px; padding: 10px 2px; text-align: center; cursor: pointer;
    transition: all 0.2s; background: #fff;
  }
  .bundle-option.active { border: 2px solid #c0a062; background: #fffaf0; }
  .bundle-qty { font-size: 1.3rem; font-weight: 800; display: block; }
  .bundle-label { font-size: 0.8rem; color: #555; }
  .bundle-gift { font-size: 0.7rem; color: #d32f2f; font-weight: 700; display: block; }

  /* BOUTON */
  .add-to-cart-btn {
    width: 100%;
    background: linear-gradient(135deg, #d4af37 0%, #c5a059 100%);
    color: #fff; font-size: 1.2rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
    padding: 20px; border: none; border-radius: 100px; cursor: pointer;
    box-shadow: 0 10px 30px rgba(197, 160, 89, 0.4); transition: all 0.3s;
  }
  .add-to-cart-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(197, 160, 89, 0.5); }

  /* --- 8. ACCORDEONS --- */
  .accordion-group { margin-top: 50px; border-top: 1px solid #eee; }
  .accordion-header {
    padding: 25px 0; font-size: 1.3rem; display: flex; justify-content: space-between; align-items: center;
    background: none; border: none; border-bottom: 1px solid #eee; width: 100%; cursor: pointer; text-align: left;
    font-family: var(--milaura-font-heading, serif);
  }
  .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; opacity: 0; padding: 0; font-size: 1.1rem; line-height: 1.7; }
  .accordion-content.open { opacity: 1; padding-bottom: 25px; }

  /* --- MOBILE --- */
  @media screen and (max-width: 990px) {
    .milaura-product-section { padding-top: 130px; } /* AjustÃ© mobile */
    .milaura-product-wrapper { grid-template-columns: 1fr; gap: 40px; }
    .product-title { font-size: 2.8rem; }
    .split-layout-container { grid-template-columns: 1fr; gap: 20px; }
    .add-to-cart-btn {
      position: sticky; bottom: 20px; z-index: 999;
      width: calc(100% - 40px); left: 20px; margin: 0 auto;
      box-shadow: 0 5px 25px rgba(0,0,0,0.3); padding: 18px;
    }
  }
{%- endstyle -%}

{% assign random_sales = 'now' | date: '%S' | modulo: 15 | plus: 18 %}
{% assign inventory_qty = product.selected_or_first_available_variant.inventory_quantity %}
{% if inventory_qty <= 0 %}{% assign inventory_qty = 7 %}{% endif %}
{% assign progress_width = inventory_qty | times: 100 | divided_by: 20 %}
{% if progress_width > 100 %}{% assign progress_width = 100 %}{% endif %}

<section class="milaura-product-section" id="MainProduct-{{ section.id }}">
  <div class="milaura-product-wrapper">
    <div class="product-media-gallery">
      <div class="main-image-wrapper">
        {% if section.settings.sticker_text != blank %}
          <div class="product-badge-sticker">{{ section.settings.sticker_text }}</div>
        {% endif %}

        {% if product.featured_media %}
          <img
            src="{{ product.featured_media | image_url: width: 1000 }}"
            alt="{{ product.title }}"
            class="main-product-image"
            loading="eager"
          >
        {% else %}
          {{ 'product-1' | placeholder_svg_tag: 'main-product-image' }}
        {% endif %}
      </div>
    </div>

    <div class="product-info-wrapper">
      {% if product.metafields.custom.subtitle %}
        <div class="product-subtitle">{{ product.metafields.custom.subtitle }}</div>
      {% endif %}
      <h1 class="product-title">{{ product.title }}</h1>

      <div class="split-layout-container">
        {% if product.metafields.custom.stone %}
          <div class="identity-card-compact">
            <div class="id-row">
              <span class="id-label">Pierre</span> <span class="id-val">{{ product.metafields.custom.stone }}</span>
            </div>
            <div class="id-row">
              <span class="id-label">QualitÃ©</span>
              <span class="id-val">{{ product.metafields.custom.quality | default: 'AA+' }}</span>
            </div>
            <div class="id-row">
              <span class="id-label">Origine</span>
              <span class="id-val">{{ product.metafields.custom.origin | default: 'Monde' }}</span>
            </div>
          </div>
        {% endif %}
        {% if product.metafields.custom.benefits %}
          <div class="benefits-compact">
            <h3>{{ section.settings.benefits_title }}</h3>
            {% assign benefits = product.metafields.custom.benefits | split: 'â€¢' %}
            {% for benefit in benefits %}
              <div class="benefits-item"><span class="check-icon">âœ”</span> {{ benefit | strip }}</div>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="urgency-container">
        <div class="stock-status">
          <span class="stock-text">ðŸ”µ Plus que {{ inventory_qty }} piÃ¨ces en stock !</span>
          <span class="sales-text">{{ random_sales }} ventes aujourd'hui</span>
        </div>
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" style="width: {{ progress_width }}%;"></div>
        </div>
      </div>

      <div class="reviews-preview-block">
        <div class="review-item">
          <img src="https://i.pravatar.cc/150?img=32" alt="Sophie" class="reviewer-avatar">
          <div class="review-content">
            <strong>Sophie D. <span class="stars-gold">â˜…â˜…â˜…â˜…â˜…</span></strong>
            <p>"Cette bougie a changÃ© l'Ã©nergie de mon salon. L'amÃ©thyste est magnifique !"</p>
          </div>
        </div>
        <div class="review-item">
          <img src="https://i.pravatar.cc/150?img=5" alt="Marc" class="reviewer-avatar">
          <div class="review-content">
            <strong>Marc L. <span class="stars-gold">â˜…â˜…â˜…â˜…â˜…</span></strong>
            <p>"Emballage soignÃ©, odeur divine. Ma femme adore."</p>
          </div>
        </div>
      </div>

      <div class="conversion-area">
        {% form 'product', product %}
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

          <div class="price-review-split">
            <div class="price-box-compact">
              <span class="final-price">{{ product.price | money }}</span>
              {% if product.compare_at_price > product.price %}
                <span class="old-price">{{ product.compare_at_price | money }}</span>
              {% endif %}
            </div>
            <div class="mini-review-stat">
              <span class="stars-large">â˜…â˜…â˜…â˜…â˜…</span>
              <span>4.9/5 (120+ avis)</span>
            </div>
          </div>

          <label style="font-weight:700; margin-bottom:8px; display:block;">Choisir votre offre :</label>
          <div class="bundle-selector">
            <div class="bundle-option active" onclick="selectBundle(1, this)">
              <span class="bundle-qty">1</span><span class="bundle-label">UnitÃ©</span>
            </div>
            <div class="bundle-option" onclick="selectBundle(2, this)">
              <span class="bundle-qty">2</span><span class="bundle-label">Duo</span>
            </div>
            <div class="bundle-option" onclick="selectBundle(3, this)">
              <span class="bundle-qty">3</span><span class="bundle-gift">CADEAU + LIVRAISON</span>
            </div>
          </div>
          <input type="number" id="Quantity-{{ section.id }}" name="quantity" value="1" min="1" style="display:none;">

          <button type="submit" name="add" class="add-to-cart-btn">Ajouter au panier</button>
        {% endform %}

        {% if section.settings.reassurance_text %}
          <div style="text-align:center; margin-top:15px; font-size:0.9rem; color:#888;">
            {{ section.settings.reassurance_text }}
          </div>
        {% endif %}
      </div>

      <div class="accordion-group">
        <button class="accordion-header" onclick="toggleAcc(this)">Description & Histoire <span>+</span></button>
        <div class="accordion-content open" style="max-height: 500px; opacity:1;">{{ product.description }}</div>

        <button class="accordion-header" onclick="toggleAcc(this)">DÃ©tails techniques <span>+</span></button>
        <div class="accordion-content">{{ section.settings.technical_details }}</div>

        <button class="accordion-header" onclick="toggleAcc(this)">Livraison & Retours <span>+</span></button>
        <div class="accordion-content">{{ section.settings.shipping_returns }}</div>
      </div>
    </div>
  </div>
</section>

<script>
  function toggleAcc(btn) {
    btn.classList.toggle('active');
    var panel = btn.nextElementSibling;
    if (panel.style.maxHeight) {
      panel.style.maxHeight = null;
      panel.classList.remove('open');
      btn.querySelector('span').innerText = '+';
    } else {
      panel.style.maxHeight = panel.scrollHeight + 'px';
      panel.classList.add('open');
      btn.querySelector('span').innerText = '-';
    }
  }

  function selectBundle(qty, element) {
    var input = document.getElementById('Quantity-{{ section.id }}');
    if (input) input.value = qty;
    var options = document.querySelectorAll('.bundle-option');
    options.forEach(function (opt) {
      opt.classList.remove('active');
    });
    element.classList.add('active');
  }
</script>

{% schema %}
{
  "name": "Milaura Masterclass V5",
  "settings": [
    {
      "type": "text",
      "id": "sticker_text",
      "label": "Texte Badge Image",
      "default": "Fait Main"
    },
    {
      "type": "text",
      "id": "benefits_title",
      "label": "Titre BÃ©nÃ©fices",
      "default": "Pourquoi elle est faite pour toi :"
    },
    {
      "type": "text",
      "id": "reassurance_text",
      "label": "Texte Rassurance",
      "default": "ðŸšš ExpÃ©dition 24/48h - Satisfait ou remboursÃ©"
    },
    {
      "type": "richtext",
      "id": "technical_details",
      "label": "Contenu DÃ©tails Techniques",
      "default": "<p>Cire de soja 100% naturelle.</p>"
    },
    {
      "type": "richtext",
      "id": "shipping_returns",
      "label": "Contenu Livraison",
      "default": "<p>Livraison offerte dÃ¨s 2 bougies.</p>"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 300,
      "step": 10,
      "unit": "px",
      "label": "Marge Haut",
      "default": 220
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Marge Bas",
      "default": 60
    }
  ],
  "presets": [{ "name": "Milaura Masterclass V5" }]
}
{% endschema %}
