{%- comment -%}
  MILAURA COLLECTION FILTERS
  Barre de filtres ultra-fine style chips
  Optimisée bijoux & bougies
  @version 2.0.0
{%- endcomment -%}

{%- style -%}
  #MilauraFilters-{{ section.id }} {
    padding: 0;
    border-bottom: 1px solid rgba(192, 160, 98, 0.15);
    background: rgba(253, 251, 247, 0.6);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    position: sticky;
    top: 0;
    z-index: 50;
  }

  #MilauraFilters-{{ section.id }} .filters__bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
    min-height: 44px;
  }

  /* Compteur à gauche */
  #MilauraFilters-{{ section.id }} .filters__count {
    flex-shrink: 0;
    font-size: 12px;
    font-weight: 500;
    color: var(--milaura-text-light, #888);
    white-space: nowrap;
  }

  #MilauraFilters-{{ section.id }} .filters__count strong {
    color: var(--milaura-gold, #C0A062);
    font-weight: 700;
  }

  /* Séparateur */
  #MilauraFilters-{{ section.id }} .filters__sep {
    width: 1px;
    height: 20px;
    background: rgba(192, 160, 98, 0.25);
    flex-shrink: 0;
  }

  /* Container scrollable des chips */
  #MilauraFilters-{{ section.id }} .filters__chips {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    overflow-x: auto;
    overflow-y: hidden;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: 2px 0;
    margin: -2px 0;
  }

  #MilauraFilters-{{ section.id }} .filters__chips::-webkit-scrollbar {
    display: none;
  }

  /* Chip de filtre (dropdown) */
  #MilauraFilters-{{ section.id }} .filters__chip {
    position: relative;
    flex-shrink: 0;
  }

  #MilauraFilters-{{ section.id }} .filters__chip-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 6px 12px;
    background: #ffffff;
    border: 1px solid rgba(192, 160, 98, 0.3);
    border-radius: 50px;
    font-size: 12px;
    font-weight: 500;
    color: var(--milaura-text, #333);
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  #MilauraFilters-{{ section.id }} .filters__chip-btn:hover {
    border-color: var(--milaura-gold, #C0A062);
    box-shadow: 0 2px 8px rgba(192, 160, 98, 0.15);
  }

  #MilauraFilters-{{ section.id }} .filters__chip-btn.is-active {
    background: var(--milaura-gold, #C0A062);
    border-color: var(--milaura-gold, #C0A062);
    color: #ffffff;
  }

  #MilauraFilters-{{ section.id }} .filters__chip-btn svg {
    width: 10px;
    height: 10px;
    transition: transform 0.2s ease;
  }

  #MilauraFilters-{{ section.id }} .filters__chip.is-open .filters__chip-btn svg {
    transform: rotate(180deg);
  }

  #MilauraFilters-{{ section.id }} .filters__chip-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 16px;
    height: 16px;
    padding: 0 4px;
    background: var(--milaura-gold, #C0A062);
    border-radius: 50px;
    font-size: 10px;
    font-weight: 700;
    color: #ffffff;
  }

  #MilauraFilters-{{ section.id }} .filters__chip-btn.is-active .filters__chip-count {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Dropdown */
  #MilauraFilters-{{ section.id }} .filters__dropdown {
    position: absolute;
    top: calc(100% + 6px);
    left: 0;
    min-width: 180px;
    max-height: 280px;
    overflow-y: auto;
    background: #ffffff;
    border: 1px solid rgba(192, 160, 98, 0.2);
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    padding: 6px;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all 0.2s ease;
  }

  #MilauraFilters-{{ section.id }} .filters__chip.is-open .filters__dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  #MilauraFilters-{{ section.id }} .filters__option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.15s ease;
  }

  #MilauraFilters-{{ section.id }} .filters__option:hover {
    background: rgba(192, 160, 98, 0.08);
  }

  #MilauraFilters-{{ section.id }} .filters__option input {
    width: 14px;
    height: 14px;
    accent-color: var(--milaura-gold, #C0A062);
    cursor: pointer;
    flex-shrink: 0;
  }

  #MilauraFilters-{{ section.id }} .filters__option-label {
    font-size: 13px;
    color: var(--milaura-text, #333);
    flex: 1;
  }

  #MilauraFilters-{{ section.id }} .filters__option-num {
    font-size: 11px;
    color: var(--milaura-text-light, #999);
  }

  #MilauraFilters-{{ section.id }} .filters__option.is-disabled {
    opacity: 0.4;
    pointer-events: none;
  }

  /* Filtres actifs (pills) */
  #MilauraFilters-{{ section.id }} .filters__active-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 5px 8px 5px 10px;
    background: linear-gradient(135deg, rgba(192, 160, 98, 0.15), rgba(192, 160, 98, 0.08));
    border: 1px solid rgba(192, 160, 98, 0.3);
    border-radius: 50px;
    font-size: 11px;
    font-weight: 500;
    color: var(--milaura-text, #333);
    white-space: nowrap;
    flex-shrink: 0;
  }

  #MilauraFilters-{{ section.id }} .filters__active-pill-remove {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 14px;
    height: 14px;
    background: rgba(192, 160, 98, 0.2);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    padding: 0;
    transition: background 0.15s ease;
    color: var(--milaura-text, #333);
  }

  #MilauraFilters-{{ section.id }} .filters__active-pill-remove:hover {
    background: var(--milaura-gold, #C0A062);
    color: #ffffff;
  }

  #MilauraFilters-{{ section.id }} .filters__active-pill-remove svg {
    width: 8px;
    height: 8px;
  }

  /* Clear all */
  #MilauraFilters-{{ section.id }} .filters__clear {
    flex-shrink: 0;
    padding: 5px 10px;
    background: none;
    border: none;
    font-size: 11px;
    font-weight: 500;
    color: var(--milaura-text-light, #888);
    cursor: pointer;
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: color 0.2s ease;
    white-space: nowrap;
  }

  #MilauraFilters-{{ section.id }} .filters__clear:hover {
    color: var(--milaura-gold, #C0A062);
  }

  /* Sort (à droite) */
  #MilauraFilters-{{ section.id }} .filters__sort {
    flex-shrink: 0;
    position: relative;
  }

  #MilauraFilters-{{ section.id }} .filters__sort-select {
    appearance: none;
    padding: 6px 28px 6px 10px;
    background: transparent;
    border: 1px solid rgba(192, 160, 98, 0.25);
    border-radius: 50px;
    font-size: 12px;
    font-weight: 500;
    color: var(--milaura-text, #333);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  #MilauraFilters-{{ section.id }} .filters__sort-select:hover,
  #MilauraFilters-{{ section.id }} .filters__sort-select:focus {
    border-color: var(--milaura-gold, #C0A062);
    outline: none;
  }

  #MilauraFilters-{{ section.id }} .filters__sort-icon {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 10px;
    height: 10px;
    pointer-events: none;
    color: var(--milaura-text-light, #888);
  }

  /* Mobile */
  @media screen and (max-width: 768px) {
    #MilauraFilters-{{ section.id }} {
      position: relative;
      top: auto;
    }

    #MilauraFilters-{{ section.id }} .filters__bar {
      padding: 8px 0;
      gap: 8px;
    }

    #MilauraFilters-{{ section.id }} .filters__count {
      display: none;
    }

    #MilauraFilters-{{ section.id }} .filters__sep:first-of-type {
      display: none;
    }

    #MilauraFilters-{{ section.id }} .filters__chips {
      gap: 6px;
      padding-right: 8px;
    }

    #MilauraFilters-{{ section.id }} .filters__chip-btn {
      padding: 5px 10px;
      font-size: 11px;
    }

    #MilauraFilters-{{ section.id }} .filters__dropdown {
      position: fixed;
      top: auto;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 50vh;
      border-radius: 16px 16px 0 0;
      transform: translateY(100%);
    }

    #MilauraFilters-{{ section.id }} .filters__chip.is-open .filters__dropdown {
      transform: translateY(0);
    }

    #MilauraFilters-{{ section.id }} .filters__overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 99;
    }

    #MilauraFilters-{{ section.id }} .filters__chip.is-open ~ .filters__overlay {
      display: block;
    }

    #MilauraFilters-{{ section.id }} .filters__sort-select {
      padding: 5px 24px 5px 8px;
      font-size: 11px;
    }

    #MilauraFilters-{{ section.id }} .filters__active-pill {
      font-size: 10px;
      padding: 4px 6px 4px 8px;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    #MilauraFilters-{{ section.id }} .filters__dropdown,
    #MilauraFilters-{{ section.id }} .filters__chip-btn,
    #MilauraFilters-{{ section.id }} .filters__chip-btn svg {
      transition: none;
    }
  }
{%- endstyle -%}

<section
  id="MilauraFilters-{{ section.id }}"
  class="milaura-filters"
  data-section-id="{{ section.id }}"
>
  <div class="page-width">
    <div class="filters__bar">

      {%- comment -%} Compteur {%- endcomment -%}
      <span class="filters__count">
        <strong>{{ collection.products_count }}</strong> {{ collection.products_count | pluralize: 'création', 'créations' }}
      </span>

      <span class="filters__sep"></span>

      {%- comment -%} Chips scrollables {%- endcomment -%}
      <div class="filters__chips">

        {%- comment -%} Filtres actifs d'abord {%- endcomment -%}
        {%- for filter in collection.filters -%}
          {%- for value in filter.active_values -%}
            <a href="{{ value.url_to_remove }}" class="filters__active-pill">
              {{ value.label }}
              <span class="filters__active-pill-remove" aria-label="Supprimer {{ value.label }}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </span>
            </a>
          {%- endfor -%}
        {%- endfor -%}

        {%- comment -%} Chips de filtres {%- endcomment -%}
        {%- if section.settings.enable_filtering -%}
          {%- for filter in collection.filters -%}
            {%- if filter.type == 'list' and filter.values.size > 0 -%}
              <div class="filters__chip" data-filter-chip>
                <button
                  type="button"
                  class="filters__chip-btn{% if filter.active_values.size > 0 %} is-active{% endif %}"
                  aria-expanded="false"
                  data-chip-toggle
                >
                  <span>{{ filter.label }}</span>
                  {%- if filter.active_values.size > 0 -%}
                    <span class="filters__chip-count">{{ filter.active_values.size }}</span>
                  {%- endif -%}
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </button>

                <div class="filters__dropdown">
                  {%- for value in filter.values -%}
                    <label class="filters__option{% if value.count == 0 and value.active == false %} is-disabled{% endif %}">
                      <input
                        type="checkbox"
                        name="{{ filter.param_name }}"
                        value="{{ value.value }}"
                        {% if value.active %}checked{% endif %}
                        {% if value.count == 0 and value.active == false %}disabled{% endif %}
                        data-filter-input
                      >
                      <span class="filters__option-label">{{ value.label }}</span>
                      <span class="filters__option-num">{{ value.count }}</span>
                    </label>
                  {%- endfor -%}
                </div>
              </div>
            {%- endif -%}

            {%- comment -%} Price range filter {%- endcomment -%}
            {%- if filter.type == 'price_range' -%}
              <div class="filters__chip" data-filter-chip>
                <button
                  type="button"
                  class="filters__chip-btn{% if filter.min_value.value != nil or filter.max_value.value != nil %} is-active{% endif %}"
                  aria-expanded="false"
                  data-chip-toggle
                >
                  <span>Prix</span>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </button>

                <div class="filters__dropdown" style="min-width: 200px; padding: 12px;">
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <input
                      type="number"
                      name="{{ filter.min_value.param_name }}"
                      value="{{ filter.min_value.value | money_without_currency | replace: ',', '' }}"
                      placeholder="{{ filter.range_min | money_without_currency }}"
                      min="{{ filter.range_min | money_without_currency | replace: ',', '' }}"
                      max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                      style="flex: 1; padding: 8px; border: 1px solid rgba(192,160,98,0.3); border-radius: 8px; font-size: 13px; width: 70px;"
                      data-price-input
                    >
                    <span style="color: #999; font-size: 12px;">à</span>
                    <input
                      type="number"
                      name="{{ filter.max_value.param_name }}"
                      value="{{ filter.max_value.value | money_without_currency | replace: ',', '' }}"
                      placeholder="{{ filter.range_max | money_without_currency }}"
                      min="{{ filter.range_min | money_without_currency | replace: ',', '' }}"
                      max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                      style="flex: 1; padding: 8px; border: 1px solid rgba(192,160,98,0.3); border-radius: 8px; font-size: 13px; width: 70px;"
                      data-price-input
                    >
                    <span style="color: #999; font-size: 12px;">€</span>
                  </div>
                  <button
                    type="button"
                    data-apply-price
                    style="width: 100%; margin-top: 10px; padding: 8px; background: var(--milaura-gold, #C0A062); color: #fff; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;"
                  >
                    Appliquer
                  </button>
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}

        {%- comment -%} Clear all {%- endcomment -%}
        {%- assign has_active = false -%}
        {%- for filter in collection.filters -%}
          {%- if filter.active_values.size > 0 or filter.min_value.value != nil or filter.max_value.value != nil -%}
            {%- assign has_active = true -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}

        {%- if has_active -%}
          <a href="{{ collection.url }}" class="filters__clear">Effacer tout</a>
        {%- endif -%}

      </div>

      <span class="filters__sep"></span>

      {%- comment -%} Tri {%- endcomment -%}
      {%- if section.settings.enable_sorting -%}
        <div class="filters__sort">
          <select
            class="filters__sort-select"
            name="sort_by"
            aria-label="Trier"
            data-sort-select
          >
            {%- for option in collection.sort_options -%}
              <option value="{{ option.value }}" {% if collection.sort_by == option.value %}selected{% endif %}>
                {{ option.name }}
              </option>
            {%- endfor -%}
          </select>
          <svg class="filters__sort-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </div>
      {%- endif -%}

    </div>

    {%- comment -%} Overlay mobile {%- endcomment -%}
    <div class="filters__overlay" data-filters-overlay></div>

  </div>
</section>

<script>
(function() {
  const section = document.getElementById('MilauraFilters-{{ section.id }}');
  if (!section) return;

  // Chip toggles
  const chips = section.querySelectorAll('[data-filter-chip]');
  const overlay = section.querySelector('[data-filters-overlay]');

  chips.forEach(chip => {
    const btn = chip.querySelector('[data-chip-toggle]');
    if (!btn) return;

    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = chip.classList.contains('is-open');

      // Close all
      chips.forEach(c => {
        c.classList.remove('is-open');
        c.querySelector('[data-chip-toggle]')?.setAttribute('aria-expanded', 'false');
      });

      // Open this one if it was closed
      if (!isOpen) {
        chip.classList.add('is-open');
        btn.setAttribute('aria-expanded', 'true');
      }
    });
  });

  // Close on click outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('[data-filter-chip]')) {
      chips.forEach(chip => {
        chip.classList.remove('is-open');
        chip.querySelector('[data-chip-toggle]')?.setAttribute('aria-expanded', 'false');
      });
    }
  });

  // Close on overlay click (mobile)
  if (overlay) {
    overlay.addEventListener('click', () => {
      chips.forEach(chip => {
        chip.classList.remove('is-open');
        chip.querySelector('[data-chip-toggle]')?.setAttribute('aria-expanded', 'false');
      });
    });
  }

  // Sort select
  const sortSelect = section.querySelector('[data-sort-select]');
  if (sortSelect) {
    sortSelect.addEventListener('change', function() {
      const url = new URL(window.location.href);
      url.searchParams.set('sort_by', this.value);
      window.location.href = url.toString();
    });
  }

  // Filter checkboxes
  const filterInputs = section.querySelectorAll('[data-filter-input]');
  filterInputs.forEach(input => {
    input.addEventListener('change', applyFilters);
  });

  // Price filter
  const priceApplyBtns = section.querySelectorAll('[data-apply-price]');
  priceApplyBtns.forEach(btn => {
    btn.addEventListener('click', applyFilters);
  });

  function applyFilters() {
    const url = new URL(window.location.href);

    // Clear existing filter params
    for (const key of [...url.searchParams.keys()]) {
      if (key.startsWith('filter.')) {
        url.searchParams.delete(key);
      }
    }

    // Add checked filters
    const checkedInputs = section.querySelectorAll('[data-filter-input]:checked');
    checkedInputs.forEach(input => {
      url.searchParams.append(input.name, input.value);
    });

    // Add price filters
    const priceInputs = section.querySelectorAll('[data-price-input]');
    priceInputs.forEach(input => {
      if (input.value) {
        url.searchParams.set(input.name, input.value * 100); // Convert to cents
      }
    });

    window.location.href = url.toString();
  }

  // ESC to close
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      chips.forEach(chip => {
        chip.classList.remove('is-open');
        chip.querySelector('[data-chip-toggle]')?.setAttribute('aria-expanded', 'false');
      });
    }
  });
})();
</script>

{% schema %}
{
  "name": "Filtres Collection",
  "tag": "section",
  "class": "milaura-section",
  "settings": [
    {
      "type": "header",
      "content": "⚙️ Options"
    },
    {
      "type": "checkbox",
      "id": "enable_filtering",
      "label": "Activer les filtres",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_sorting",
      "label": "Activer le tri",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Filtres Collection"
    }
  ]
}
{% endschema %}
