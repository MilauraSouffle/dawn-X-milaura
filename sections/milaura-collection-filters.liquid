{%- comment -%}
  MILAURA COLLECTION FILTERS
  Ultra-minimal: just filter button + sort dropdown
  @version 3.0.0
{%- endcomment -%}

{%- style -%}
  #MilauraFilters-{{ section.id }} {
    padding: 0;
  }

  #MilauraFilters-{{ section.id }} .filters__bar {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 8px 0;
  }

  /* Bouton Filtres - CACHÉ */
  #MilauraFilters-{{ section.id }} .filters__trigger {
    display: none !important;
  }

  /* Sort dropdown - avec rectangle arrondi */
  #MilauraFilters-{{ section.id }} .filters__sort {
    position: relative;
    display: inline-flex;
    align-items: center;
    padding: 8px 14px;
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 25px;
    transition: all 0.2s ease;
  }

  #MilauraFilters-{{ section.id }} .filters__sort:hover {
    border-color: var(--milaura-gold, #C0A062);
    box-shadow: 0 2px 8px rgba(192, 160, 98, 0.15);
  }

  #MilauraFilters-{{ section.id }} .filters__sort-select {
    appearance: none;
    padding: 0 20px 0 0;
    background: transparent;
    border: none;
    font-size: 13px;
    font-weight: 500;
    color: var(--milaura-text, #333);
    cursor: pointer;
    transition: color 0.2s ease;
  }

  #MilauraFilters-{{ section.id }} .filters__sort-select:hover,
  #MilauraFilters-{{ section.id }} .filters__sort-select:focus {
    color: var(--milaura-gold, #C0A062);
    outline: none;
  }

  #MilauraFilters-{{ section.id }} .filters__sort-icon {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    width: 12px;
    height: 12px;
    pointer-events: none;
    color: var(--milaura-text-light, #888);
  }

  /* =============================================
     DRAWER PANEL - Filtres
     ============================================= */
  #MilauraFilters-{{ section.id }} .filters__drawer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    max-width: 320px;
    height: 100vh;
    background: #ffffff;
    z-index: 1000;
    transform: translateX(-100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
  }

  #MilauraFilters-{{ section.id }} .filters__drawer.is-open {
    transform: translateX(0);
  }

  #MilauraFilters-{{ section.id }} .filters__drawer-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
  }

  #MilauraFilters-{{ section.id }} .filters__drawer-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--milaura-text, #333);
    margin: 0;
  }

  #MilauraFilters-{{ section.id }} .filters__drawer-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--milaura-text-light, #888);
    transition: color 0.2s ease;
  }

  #MilauraFilters-{{ section.id }} .filters__drawer-close:hover {
    color: var(--milaura-text, #333);
  }

  #MilauraFilters-{{ section.id }} .filters__drawer-close svg {
    width: 20px;
    height: 20px;
  }

  #MilauraFilters-{{ section.id }} .filters__drawer-body {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
  }

  /* Filter groups */
  #MilauraFilters-{{ section.id }} .filters__group {
    margin-bottom: 20px;
  }

  #MilauraFilters-{{ section.id }} .filters__group-title {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--milaura-text-light, #888);
    margin: 0 0 10px 0;
  }

  #MilauraFilters-{{ section.id }} .filters__option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    cursor: pointer;
  }

  #MilauraFilters-{{ section.id }} .filters__option input {
    width: 16px;
    height: 16px;
    accent-color: var(--milaura-gold, #C0A062);
    cursor: pointer;
    flex-shrink: 0;
  }

  #MilauraFilters-{{ section.id }} .filters__option-label {
    font-size: 14px;
    color: var(--milaura-text, #333);
    flex: 1;
  }

  #MilauraFilters-{{ section.id }} .filters__option-count {
    font-size: 12px;
    color: var(--milaura-text-light, #999);
  }

  #MilauraFilters-{{ section.id }} .filters__option.is-disabled {
    opacity: 0.4;
    pointer-events: none;
  }

  /* Price range */
  #MilauraFilters-{{ section.id }} .filters__price-inputs {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  #MilauraFilters-{{ section.id }} .filters__price-input {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid rgba(0, 0, 0, 0.12);
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s ease;
  }

  #MilauraFilters-{{ section.id }} .filters__price-input:focus {
    border-color: var(--milaura-gold, #C0A062);
    outline: none;
  }

  #MilauraFilters-{{ section.id }} .filters__price-sep {
    color: var(--milaura-text-light, #999);
    font-size: 13px;
  }

  /* Drawer footer */
  #MilauraFilters-{{ section.id }} .filters__drawer-footer {
    padding: 16px 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.08);
    display: flex;
    gap: 10px;
  }

  #MilauraFilters-{{ section.id }} .filters__btn-clear {
    flex: 1;
    padding: 12px;
    background: transparent;
    border: 1px solid rgba(0, 0, 0, 0.15);
    border-radius: 50px;
    font-size: 13px;
    font-weight: 600;
    color: var(--milaura-text, #333);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  #MilauraFilters-{{ section.id }} .filters__btn-clear:hover {
    border-color: var(--milaura-gold, #C0A062);
  }

  #MilauraFilters-{{ section.id }} .filters__btn-apply {
    flex: 1;
    padding: 12px;
    background: var(--milaura-gold, #C0A062);
    border: none;
    border-radius: 50px;
    font-size: 13px;
    font-weight: 600;
    color: #ffffff;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  #MilauraFilters-{{ section.id }} .filters__btn-apply:hover {
    background: var(--milaura-gold-dark, #A8894F);
  }

  /* Overlay */
  #MilauraFilters-{{ section.id }} .filters__overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  #MilauraFilters-{{ section.id }} .filters__overlay.is-open {
    opacity: 1;
    visibility: visible;
  }

  /* Active filters pills - CACHÉ (filtres désactivés) */
  #MilauraFilters-{{ section.id }} .filters__active {
    display: none !important;
  }

  /* Mobile adjustments */
  @media screen and (max-width: 768px) {
    #MilauraFilters-{{ section.id }} .filters__bar {
      padding: 6px 0;
    }

    #MilauraFilters-{{ section.id }} .filters__sort {
      padding: 6px 12px;
    }

    #MilauraFilters-{{ section.id }} .filters__sort-select {
      font-size: 12px;
    }

    #MilauraFilters-{{ section.id }} .filters__sort-icon {
      right: 12px;
    }

    #MilauraFilters-{{ section.id }} .filters__drawer {
      max-width: 100%;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    #MilauraFilters-{{ section.id }} .filters__drawer,
    #MilauraFilters-{{ section.id }} .filters__overlay {
      transition: none;
    }
  }
{%- endstyle -%}

<section
  id="MilauraFilters-{{ section.id }}"
  class="milaura-filters"
  data-section-id="{{ section.id }}"
>
  <div class="page-width">
    <div class="filters__bar">

      {%- comment -%} Bouton Filtres {%- endcomment -%}
      {%- if section.settings.enable_filtering -%}
        {%- assign active_count = 0 -%}
        {%- for filter in collection.filters -%}
          {%- assign active_count = active_count | plus: filter.active_values.size -%}
          {%- if filter.min_value.value != nil or filter.max_value.value != nil -%}
            {%- assign active_count = active_count | plus: 1 -%}
          {%- endif -%}
        {%- endfor -%}

        <button type="button" class="filters__trigger" data-open-drawer>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="4" y1="6" x2="20" y2="6"></line>
            <line x1="4" y1="12" x2="14" y2="12"></line>
            <line x1="4" y1="18" x2="10" y2="18"></line>
          </svg>
          <span>Filtres</span>
          {%- if active_count > 0 -%}
            <span class="filters__trigger-count">{{ active_count }}</span>
          {%- endif -%}
        </button>
      {%- endif -%}

      {%- comment -%} Filtres actifs inline {%- endcomment -%}
      <div class="filters__active">
        {%- for filter in collection.filters -%}
          {%- for value in filter.active_values -%}
            <a href="{{ value.url_to_remove }}" class="filters__active-pill">
              {{ value.label }}
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </a>
          {%- endfor -%}
        {%- endfor -%}
      </div>

      {%- comment -%} Tri + Disponibilité {%- endcomment -%}
      {%- if section.settings.enable_sorting -%}
        {%- comment -%} Détecte si un filtre de disponibilité est actif {%- endcomment -%}
        {%- assign current_availability = '' -%}
        {%- if request.url contains 'filter.v.availability=1' -%}
          {%- assign current_availability = 'in_stock' -%}
        {%- elsif request.url contains 'filter.v.availability=0' -%}
          {%- assign current_availability = 'out_of_stock' -%}
        {%- endif -%}

        <div class="filters__sort">
          <select
            class="filters__sort-select"
            name="sort_by"
            aria-label="Trier et filtrer"
            data-sort-select
          >
            <optgroup label="Trier par">
              {%- for option in collection.sort_options -%}
                <option value="sort:{{ option.value }}" {% if collection.sort_by == option.value and current_availability == '' %}selected{% endif %}>
                  {{ option.name }}
                </option>
              {%- endfor -%}
            </optgroup>
            <optgroup label="Disponibilité">
              <option value="availability:in_stock" {% if current_availability == 'in_stock' %}selected{% endif %}>
                ✓ En stock
              </option>
              <option value="availability:out_of_stock" {% if current_availability == 'out_of_stock' %}selected{% endif %}>
                ✗ Rupture de stock
              </option>
            </optgroup>
          </select>
          <svg class="filters__sort-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </div>
      {%- endif -%}

    </div>
  </div>

  {%- comment -%} Drawer Panel {%- endcomment -%}
  {%- if section.settings.enable_filtering -%}
    <div class="filters__overlay" data-drawer-overlay></div>
    <aside class="filters__drawer" data-drawer aria-label="Filtres">
      <header class="filters__drawer-header">
        <h2 class="filters__drawer-title">Filtres</h2>
        <button type="button" class="filters__drawer-close" data-close-drawer aria-label="Fermer">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </header>

      <div class="filters__drawer-body">
        {%- for filter in collection.filters -%}
          <div class="filters__group">
            <h3 class="filters__group-title">{{ filter.label }}</h3>

            {%- if filter.type == 'list' -%}
              {%- for value in filter.values -%}
                <label class="filters__option{% if value.count == 0 and value.active == false %} is-disabled{% endif %}">
                  <input
                    type="checkbox"
                    name="{{ filter.param_name }}"
                    value="{{ value.value }}"
                    {% if value.active %}checked{% endif %}
                    {% if value.count == 0 and value.active == false %}disabled{% endif %}
                    data-filter-input
                  >
                  <span class="filters__option-label">{{ value.label }}</span>
                  <span class="filters__option-count">{{ value.count }}</span>
                </label>
              {%- endfor -%}
            {%- endif -%}

            {%- if filter.type == 'price_range' -%}
              <div class="filters__price-inputs">
                <input
                  type="number"
                  class="filters__price-input"
                  name="{{ filter.min_value.param_name }}"
                  value="{{ filter.min_value.value | money_without_currency | replace: ',', '' }}"
                  placeholder="{{ filter.range_min | money_without_currency }}"
                  min="{{ filter.range_min | money_without_currency | replace: ',', '' }}"
                  data-price-input
                >
                <span class="filters__price-sep">à</span>
                <input
                  type="number"
                  class="filters__price-input"
                  name="{{ filter.max_value.param_name }}"
                  value="{{ filter.max_value.value | money_without_currency | replace: ',', '' }}"
                  placeholder="{{ filter.range_max | money_without_currency }}"
                  max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                  data-price-input
                >
                <span class="filters__price-sep">€</span>
              </div>
            {%- endif -%}
          </div>
        {%- endfor -%}
      </div>

      <footer class="filters__drawer-footer">
        <a href="{{ collection.url }}" class="filters__btn-clear">Effacer</a>
        <button type="button" class="filters__btn-apply" data-apply-filters>Appliquer</button>
      </footer>
    </aside>
  {%- endif -%}
</section>

<script>
(function() {
  const section = document.getElementById('MilauraFilters-{{ section.id }}');
  if (!section) return;

  const drawer = section.querySelector('[data-drawer]');
  const overlay = section.querySelector('[data-drawer-overlay]');
  const openBtn = section.querySelector('[data-open-drawer]');
  const closeBtn = section.querySelector('[data-close-drawer]');
  const applyBtn = section.querySelector('[data-apply-filters]');

  // Open drawer
  if (openBtn && drawer && overlay) {
    openBtn.addEventListener('click', () => {
      drawer.classList.add('is-open');
      overlay.classList.add('is-open');
      document.body.style.overflow = 'hidden';
    });
  }

  // Close drawer
  function closeDrawer() {
    if (drawer && overlay) {
      drawer.classList.remove('is-open');
      overlay.classList.remove('is-open');
      document.body.style.overflow = '';
    }
  }

  if (closeBtn) closeBtn.addEventListener('click', closeDrawer);
  if (overlay) overlay.addEventListener('click', closeDrawer);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeDrawer();
  });

  // Apply filters
  if (applyBtn) {
    applyBtn.addEventListener('click', applyFilters);
  }

  // Sort & Availability select
  const sortSelect = section.querySelector('[data-sort-select]');
  if (sortSelect) {
    sortSelect.addEventListener('change', function() {
      const url = new URL(window.location.href);
      const value = this.value;

      if (value.startsWith('sort:')) {
        // C'est une option de tri
        const sortValue = value.replace('sort:', '');
        url.searchParams.set('sort_by', sortValue);
        // Supprime le filtre de disponibilité si présent
        url.searchParams.delete('filter.v.availability');
      } else if (value.startsWith('availability:')) {
        // C'est un filtre de disponibilité
        const availabilityValue = value.replace('availability:', '');
        // Supprime l'ancien filtre de disponibilité
        url.searchParams.delete('filter.v.availability');

        if (availabilityValue === 'in_stock') {
          url.searchParams.set('filter.v.availability', '1');
        } else if (availabilityValue === 'out_of_stock') {
          url.searchParams.set('filter.v.availability', '0');
        }
      }

      window.location.href = url.toString();
    });
  }

  function applyFilters() {
    const url = new URL(window.location.href);

    // Clear existing filter params
    for (const key of [...url.searchParams.keys()]) {
      if (key.startsWith('filter.')) {
        url.searchParams.delete(key);
      }
    }

    // Add checked filters
    const checkedInputs = section.querySelectorAll('[data-filter-input]:checked');
    checkedInputs.forEach(input => {
      url.searchParams.append(input.name, input.value);
    });

    // Add price filters
    const priceInputs = section.querySelectorAll('[data-price-input]');
    priceInputs.forEach(input => {
      if (input.value) {
        url.searchParams.set(input.name, input.value * 100);
      }
    });

    window.location.href = url.toString();
  }
})();
</script>

{% schema %}
{
  "name": "Filtres Collection",
  "tag": "section",
  "class": "milaura-section milaura-section--no-padding",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_filtering",
      "label": "Activer les filtres",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_sorting",
      "label": "Activer le tri",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Filtres Collection"
    }
  ]
}
{% endschema %}
