{% comment %}
  MILAURA PRODUCT RITUAL
  4 √©tapes max (num√©ro + ic√¥ne + texte)
  Apparition s√©quentielle au scroll
  Rituels diff√©rents par type produit (bijou/bougie/sauge/coffret)
{% endcomment %}

{%- liquid
  assign product_type_meta = product.metafields.milaura.product_type_handle.value
  if product_type_meta != blank
    assign product_type = product_type_meta | downcase
  else
    assign product_type = product.type | handleize
  endif

  case product_type
    when 'bijou', 'bracelet', 'collier', 'bague', 'pendentif', 'fil-de-perles'
      assign template_type = 'bijou'
    when 'bougie'
      assign template_type = 'bougie'
    when 'sauge', 'encens'
      assign template_type = 'sauge'
    when 'coffret', 'bundle'
      assign template_type = 'coffret'
    when 'pierre-roulee', 'cabochon', 'mineral', 'pierre'
      assign template_type = 'pierre'
    when 'bol-chantant', 'cymbales'
      assign template_type = 'rituel'
    when 'coussin', 'maillet'
      assign template_type = 'accessoire'
    else
      assign template_type = 'bijou'
  endcase

  assign ritual_steps = product.metafields.milaura.ritual_steps.value

  assign show_ritual = true
  if template_type == 'accessoire'
    if ritual_steps == blank or ritual_steps.size == 0
      assign show_ritual = false
    endif
  endif
-%}

{%- if show_ritual -%}
<section
  id="MilauraProductRitual-{{ section.id }}"
  class="milaura-product-ritual"
  data-section-id="{{ section.id }}"
>
  <div class="milaura-product-ritual__container milaura-section-card">

    {%- if section.settings.show_title -%}
      <h2 class="milaura-product-ritual__title">
        {{ section.settings.title }}
      </h2>
    {%- endif -%}

    {%- if section.settings.show_subtitle and section.settings.subtitle != blank -%}
      <p class="milaura-product-ritual__subtitle">
        {{ section.settings.subtitle }}
      </p>
    {%- endif -%}

    <div class="milaura-product-ritual__steps">

      {%- comment -%} Si metafield ritual_steps existe (JSON) {%- endcomment -%}
      {%- if ritual_steps and ritual_steps.size > 0 -%}
        {%- for step in ritual_steps limit: 4 -%}
          <div
            class="milaura-product-ritual__step"
            data-step-index="{{ forloop.index }}"
          >
            <div class="milaura-product-ritual__step-number">
              {{ forloop.index }}
            </div>
            <div class="milaura-product-ritual__step-content">
              {%- if step.icon != blank -%}
                <div class="milaura-product-ritual__step-icon">
                  {{ step.icon }}
                </div>
              {%- endif -%}
              <p class="milaura-product-ritual__step-text">
                {{ step.text }}
              </p>
            </div>
          </div>
        {%- endfor -%}

      {%- comment -%} Sinon fallback sur blocks {%- endcomment -%}
      {%- elsif section.blocks.size > 0 -%}
        {%- for block in section.blocks limit: 4 -%}
          {%- if block.type == 'step' -%}
            <div
              class="milaura-product-ritual__step"
              data-step-index="{{ forloop.index }}"
              {{ block.shopify_attributes }}
            >
              <div class="milaura-product-ritual__step-number">
                {{ forloop.index }}
              </div>
              <div class="milaura-product-ritual__step-content">
                {%- if block.settings.icon != blank -%}
                  <div class="milaura-product-ritual__step-icon">
                    {{ block.settings.icon }}
                  </div>
                {%- endif -%}
                <p class="milaura-product-ritual__step-text">
                  {{ block.settings.text }}
                </p>
              </div>
            </div>
          {%- endif -%}
        {%- endfor -%}

      {%- comment -%} Sinon rituels par d√©faut selon type {%- endcomment -%}
      {%- else -%}
        {%- case template_type -%}

          {%- when 'bijou' -%}
            <div class="milaura-product-ritual__step" data-step-index="1">
              <div class="milaura-product-ritual__step-number">1</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üåÖ</div>
                <p class="milaura-product-ritual__step-text">Choisissez un moment calme, le matin ou avant de dormir</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="2">
              <div class="milaura-product-ritual__step-number">2</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üí≠</div>
                <p class="milaura-product-ritual__step-text">Posez une intention claire : que souhaitez-vous aujourd'hui ?</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="3">
              <div class="milaura-product-ritual__step-number">3</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üíé</div>
                <p class="milaura-product-ritual__step-text">Portez le bijou contre votre peau pour sentir son energie</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="4">
              <div class="milaura-product-ritual__step-number">4</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">‚ú®</div>
                <p class="milaura-product-ritual__step-text">Touchez-le pour vous reconnecter a votre intention</p>
              </div>
            </div>

          {%- when 'bougie' -%}
            <div class="milaura-product-ritual__step" data-step-index="1">
              <div class="milaura-product-ritual__step-number">1</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üïØÔ∏è</div>
                <p class="milaura-product-ritual__step-text">Allumez votre bougie dans un espace calme</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="2">
              <div class="milaura-product-ritual__step-number">2</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üå¨Ô∏è</div>
                <p class="milaura-product-ritual__step-text">Respirez profondement, laissez le parfum vous envelopper</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="3">
              <div class="milaura-product-ritual__step-number">3</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üå∏</div>
                <p class="milaura-product-ritual__step-text">Observez la flamme, sentez la senteur evoluer</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="4">
              <div class="milaura-product-ritual__step-number">4</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üíé</div>
                <p class="milaura-product-ritual__step-text">Recuperez la pierre talisman et gardez-la pres de vous</p>
              </div>
            </div>

          {%- when 'sauge' -%}
            <div class="milaura-product-ritual__step" data-step-index="1">
              <div class="milaura-product-ritual__step-number">1</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">ü™ü</div>
                <p class="milaura-product-ritual__step-text">Ouvrez une fenetre pour laisser circuler l'energie</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="2">
              <div class="milaura-product-ritual__step-number">2</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üî•</div>
                <p class="milaura-product-ritual__step-text">Allumez la sauge et laissez-la se consumer legerement</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="3">
              <div class="milaura-product-ritual__step-number">3</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üåÄ</div>
                <p class="milaura-product-ritual__step-text">Diffusez la fumee dans chaque piece avec intention</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="4">
              <div class="milaura-product-ritual__step-number">4</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üí≠</div>
                <p class="milaura-product-ritual__step-text">Visualisez l'espace purifie, pret pour un nouveau depart</p>
              </div>
            </div>

          {%- when 'coffret' -%}
            <div class="milaura-product-ritual__step" data-step-index="1">
              <div class="milaura-product-ritual__step-number">1</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üéÅ</div>
                <p class="milaura-product-ritual__step-text">Decouvrez chaque element, prenez le temps de les observer</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="2">
              <div class="milaura-product-ritual__step-number">2</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üíé</div>
                <p class="milaura-product-ritual__step-text">Ressentez l'energie de la pierre, laissez-la vous guider</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="3">
              <div class="milaura-product-ritual__step-number">3</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üïØÔ∏è</div>
                <p class="milaura-product-ritual__step-text">Composez votre rituel : bougie, bijou, moment sacre</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="4">
              <div class="milaura-product-ritual__step-number">4</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üåô</div>
                <p class="milaura-product-ritual__step-text">Alternez selon vos besoins : jour, soir, energie, calme</p>
              </div>
            </div>

          {%- when 'pierre' -%}
            <div class="milaura-product-ritual__step" data-step-index="1">
              <div class="milaura-product-ritual__step-number">1</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üíß</div>
                <p class="milaura-product-ritual__step-text">Purifiez votre pierre sous l'eau claire ou avec de la fumee de sauge</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="2">
              <div class="milaura-product-ritual__step-number">2</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">ü§≤</div>
                <p class="milaura-product-ritual__step-text">Tenez-la dans vos mains et formulez votre intention</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="3">
              <div class="milaura-product-ritual__step-number">3</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üßò</div>
                <p class="milaura-product-ritual__step-text">Meditez quelques minutes en vous connectant a son energie</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="4">
              <div class="milaura-product-ritual__step-number">4</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">‚ú®</div>
                <p class="milaura-product-ritual__step-text">Placez-la pres de vous ou dans votre espace de vie</p>
              </div>
            </div>

          {%- when 'rituel' -%}
            <div class="milaura-product-ritual__step" data-step-index="1">
              <div class="milaura-product-ritual__step-number">1</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üïäÔ∏è</div>
                <p class="milaura-product-ritual__step-text">Preparez votre espace : un endroit calme, a l'abri des distractions</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="2">
              <div class="milaura-product-ritual__step-number">2</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üîî</div>
                <p class="milaura-product-ritual__step-text">Frappez ou frottez doucement le bord pour produire le son</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="3">
              <div class="milaura-product-ritual__step-number">3</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üåä</div>
                <p class="milaura-product-ritual__step-text">Ecoutez la vibration se propager et laissez-la vous envelopper</p>
              </div>
            </div>
            <div class="milaura-product-ritual__step" data-step-index="4">
              <div class="milaura-product-ritual__step-number">4</div>
              <div class="milaura-product-ritual__step-content">
                <div class="milaura-product-ritual__step-icon">üåô</div>
                <p class="milaura-product-ritual__step-text">Pratiquez regulierement pour approfondir votre connexion</p>
              </div>
            </div>

        {%- endcase -%}
      {%- endif -%}

    </div>

  </div>
</section>

<style>
  .milaura-product-ritual {
    padding: 20px 0;
    background: transparent;
  }

  .milaura-product-ritual__container {
    max-width: 900px;
    /* padding handled by milaura-section-card */
  }

  .milaura-product-ritual__title {
    font-family: {{ section.settings.title_font }};
    font-size: {{ section.settings.title_size_mobile }}px;
    font-weight: 600;
    text-align: center;
    color: {{ section.settings.title_color }};
    margin: 0 0 var(--milaura-spacing-sm, 12px) 0;
  }

  .milaura-product-ritual__subtitle {
    font-family: {{ section.settings.subtitle_font }};
    font-size: {{ section.settings.subtitle_size_mobile }}px;
    line-height: 1.6;
    text-align: center;
    color: {{ section.settings.subtitle_color }};
    opacity: 0.8;
    margin: 0 0 var(--milaura-spacing-lg, 36px) 0;
  }

  .milaura-product-ritual__steps {
    display: flex;
    flex-direction: column;
    gap: var(--milaura-spacing-lg, 36px);
  }

  .milaura-product-ritual__step {
    display: grid;
    grid-template-columns: 48px 1fr;
    gap: var(--milaura-spacing-md, 24px);
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.6s ease, transform 0.6s ease;
  }

  .milaura-product-ritual__step.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .milaura-product-ritual__step-number {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--milaura-gold, #C0A062), var(--milaura-gold-light, #E6C88B));
    color: #FFFFFF;
    font-size: 20px;
    font-weight: 600;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(192, 160, 98, 0.3);
    flex-shrink: 0;
  }

  .milaura-product-ritual__step-content {
    display: flex;
    flex-direction: column;
    gap: var(--milaura-spacing-xs, 6px);
  }

  .milaura-product-ritual__step-icon {
    font-size: {{ section.settings.icon_size_mobile }}px;
    line-height: 1;
  }

  .milaura-product-ritual__step-text {
    font-family: {{ section.settings.step_text_font }};
    font-size: {{ section.settings.step_text_size_mobile }}px;
    line-height: 1.6;
    color: {{ section.settings.step_text_color }};
    margin: 0;
  }

  /* Desktop */
  @media screen and (min-width: 1024px) {
    .milaura-product-ritual__title {
      font-size: {{ section.settings.title_size_desktop }}px;
    }

    .milaura-product-ritual__subtitle {
      font-size: {{ section.settings.subtitle_size_desktop }}px;
    }

    .milaura-product-ritual__steps {
      gap: var(--milaura-spacing-xl, 48px);
    }

    .milaura-product-ritual__step {
      grid-template-columns: 64px 1fr;
      gap: var(--milaura-spacing-lg, 36px);
    }

    .milaura-product-ritual__step-number {
      width: 64px;
      height: 64px;
      font-size: 24px;
    }

    .milaura-product-ritual__step-icon {
      font-size: {{ section.settings.icon_size_desktop }}px;
    }

    .milaura-product-ritual__step-text {
      font-size: {{ section.settings.step_text_size_desktop }}px;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .milaura-product-ritual__step {
      transition: none;
      opacity: 1;
      transform: none;
    }
  }
</style>

<script>
(function() {
  const sectionId = '{{ section.id }}';
  const section = document.getElementById('MilauraProductRitual-' + sectionId);
  if (!section) return;

  const steps = section.querySelectorAll('.milaura-product-ritual__step');
  const reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  if (reducedMotion) {
    // Show all steps immediately if reduced motion
    steps.forEach(function(step) {
      step.classList.add('is-visible');
    });
    return;
  }

  // Apparition s√©quentielle au scroll
  const observer = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        const stepIndex = parseInt(entry.target.getAttribute('data-step-index'));

        // Delay based on step index (200ms between each)
        setTimeout(function() {
          entry.target.classList.add('is-visible');
        }, (stepIndex - 1) * 200);

        observer.unobserve(entry.target);
      }
    });
  }, {
    threshold: 0.3
  });

  steps.forEach(function(step) {
    observer.observe(step);
  });
})();
</script>

{%- endif -%}

{% schema %}
{
  "name": "Milaura Product Ritual",
  "class": "milaura-section",
  "settings": [
    {
      "type": "header",
      "content": "üìù Titre"
    },
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Afficher le titre",
      "default": true
    },
    {
      "type": "text",
      "id": "title",
      "label": "Titre",
      "default": "Comment l'utiliser"
    },
    {
      "type": "checkbox",
      "id": "show_subtitle",
      "label": "Afficher le sous-titre",
      "default": true
    },
    {
      "type": "textarea",
      "id": "subtitle",
      "label": "Sous-titre",
      "default": "Un rituel simple pour integrer cette creation dans votre quotidien"
    },
    {
      "type": "header",
      "content": "‚úèÔ∏è Style Titre"
    },
    {
      "type": "select",
      "id": "title_font",
      "label": "Typographie titre",
      "options": [
        { "value": "var(--milaura-font-heading)", "label": "Playfair Display" },
        { "value": "var(--milaura-font-body)", "label": "Lato" },
        { "value": "var(--milaura-font-script)", "label": "Dancing Script" }
      ],
      "default": "var(--milaura-font-heading)"
    },
    {
      "type": "range",
      "id": "title_size_desktop",
      "label": "Taille titre (desktop)",
      "min": 22,
      "max": 48,
      "step": 1,
      "unit": "px",
      "default": 36
    },
    {
      "type": "range",
      "id": "title_size_mobile",
      "label": "Taille titre (mobile)",
      "min": 20,
      "max": 36,
      "step": 1,
      "unit": "px",
      "default": 26
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Couleur du titre",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "‚úèÔ∏è Style Sous-titre"
    },
    {
      "type": "select",
      "id": "subtitle_font",
      "label": "Typographie sous-titre",
      "options": [
        { "value": "var(--milaura-font-heading)", "label": "Playfair Display" },
        { "value": "var(--milaura-font-body)", "label": "Lato" },
        { "value": "var(--milaura-font-script)", "label": "Dancing Script" }
      ],
      "default": "var(--milaura-font-body)"
    },
    {
      "type": "range",
      "id": "subtitle_size_desktop",
      "label": "Taille sous-titre (desktop)",
      "min": 14,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 18
    },
    {
      "type": "range",
      "id": "subtitle_size_mobile",
      "label": "Taille sous-titre (mobile)",
      "min": 13,
      "max": 20,
      "step": 1,
      "unit": "px",
      "default": 15
    },
    {
      "type": "color",
      "id": "subtitle_color",
      "label": "Couleur sous-titre",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "‚úèÔ∏è Style Texte √âtapes"
    },
    {
      "type": "select",
      "id": "step_text_font",
      "label": "Typographie texte √©tape",
      "options": [
        { "value": "var(--milaura-font-heading)", "label": "Playfair Display" },
        { "value": "var(--milaura-font-body)", "label": "Lato" },
        { "value": "var(--milaura-font-script)", "label": "Dancing Script" }
      ],
      "default": "var(--milaura-font-body)"
    },
    {
      "type": "range",
      "id": "step_text_size_desktop",
      "label": "Taille texte √©tape (desktop)",
      "min": 14,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 18
    },
    {
      "type": "range",
      "id": "step_text_size_mobile",
      "label": "Taille texte √©tape (mobile)",
      "min": 13,
      "max": 20,
      "step": 1,
      "unit": "px",
      "default": 15
    },
    {
      "type": "color",
      "id": "step_text_color",
      "label": "Couleur texte √©tape",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "‚úèÔ∏è Style Ic√¥nes"
    },
    {
      "type": "range",
      "id": "icon_size_desktop",
      "label": "Taille ic√¥nes (desktop)",
      "min": 28,
      "max": 56,
      "step": 2,
      "unit": "px",
      "default": 40
    },
    {
      "type": "range",
      "id": "icon_size_mobile",
      "label": "Taille ic√¥nes (mobile)",
      "min": 24,
      "max": 44,
      "step": 2,
      "unit": "px",
      "default": 32
    }
  ],
  "blocks": [
    {
      "type": "step",
      "name": "√âtape",
      "limit": 4,
      "settings": [
        {
          "type": "text",
          "id": "icon",
          "label": "Ic√¥ne (emoji)",
          "default": "‚ú®",
          "info": "Utilise un emoji simple"
        },
        {
          "type": "textarea",
          "id": "text",
          "label": "Texte de l'√©tape",
          "default": "D√©cris cette √©tape du rituel"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Milaura Product Ritual",
      "blocks": [
        {
          "type": "step",
          "settings": {
            "icon": "üåÖ",
            "text": "Choisissez un moment calme, le matin ou avant de dormir"
          }
        },
        {
          "type": "step",
          "settings": {
            "icon": "üí≠",
            "text": "Posez une intention claire : que souhaitez-vous aujourd'hui ?"
          }
        },
        {
          "type": "step",
          "settings": {
            "icon": "üíé",
            "text": "Portez le bijou contre votre peau pour sentir son energie"
          }
        },
        {
          "type": "step",
          "settings": {
            "icon": "‚ú®",
            "text": "Touchez-le pour vous reconnecter a votre intention"
          }
        }
      ]
    }
  ]
}
{% endschema %}
