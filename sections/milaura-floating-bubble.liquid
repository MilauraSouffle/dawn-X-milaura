{% comment %}
  MILAURA FLOATING BUBBLE
  Bulle flottante globale avec 2 onglets : Mon Rituel + Contact
  Presente sur toutes les pages via footer-group.json
{% endcomment %}

{% style %}
  /* ============================================
     MILAURA FLOATING BUBBLE
     ============================================ */

  /* --- BOUTON TRIGGER --- */
  .milaura-bubble-trigger {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    z-index: 100000;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--milaura-gold, #C0A062) 0%, #D4B678 50%, var(--milaura-gold-light, #E6C88B) 100%);
    background-size: 200% 200%;
    box-shadow: 0 4px 20px rgba(192, 160, 98, 0.5);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    animation: milaura-bubble-shimmer 3s ease-in-out infinite;
    padding: 0;
  }

  .milaura-bubble-trigger::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 50%;
    box-shadow: 0 0 0 0 rgba(192, 160, 98, 0.6);
    animation: milaura-bubble-pulse 2.5s ease-out infinite;
    pointer-events: none;
  }

  .milaura-bubble-trigger:hover {
    transform: scale(1.08);
    box-shadow: 0 8px 30px rgba(192, 160, 98, 0.6);
  }

  .milaura-bubble-trigger:hover::before {
    animation: none;
  }

  .milaura-bubble-trigger[aria-expanded="true"]::before {
    animation: none;
  }

  @keyframes milaura-bubble-shimmer {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }

  @keyframes milaura-bubble-pulse {
    0% { box-shadow: 0 0 0 0 rgba(192, 160, 98, 0.5); }
    50% { box-shadow: 0 0 0 14px rgba(192, 160, 98, 0); }
    100% { box-shadow: 0 0 0 0 rgba(192, 160, 98, 0); }
  }

  /* Icone SVG dans le trigger */
  .milaura-bubble-trigger svg {
    width: 26px;
    height: 26px;
    color: #fff;
    transition: transform 0.3s ease, opacity 0.3s ease;
    position: absolute;
  }

  .milaura-bubble-trigger .bubble-icon-gift {
    opacity: 1;
    transform: rotate(0deg);
  }

  .milaura-bubble-trigger .bubble-icon-close {
    opacity: 0;
    transform: rotate(-90deg);
  }

  .milaura-bubble-trigger[aria-expanded="true"] .bubble-icon-gift {
    opacity: 0;
    transform: rotate(90deg);
  }

  .milaura-bubble-trigger[aria-expanded="true"] .bubble-icon-close {
    opacity: 1;
    transform: rotate(0deg);
  }

  /* --- MICRO-LABEL --- */
  .milaura-bubble-label {
    position: fixed;
    bottom: 32px;
    right: 92px;
    background: rgba(253, 251, 247, 0.97);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(192, 160, 98, 0.3);
    border-radius: 12px;
    padding: 8px 14px;
    font-family: 'Lato', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--milaura-gold-dark, #8F723A);
    white-space: nowrap;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    opacity: 0;
    transform: translateX(8px);
    transition: opacity 0.4s ease, transform 0.4s ease;
    pointer-events: none;
    z-index: 99999;
  }

  .milaura-bubble-label::after {
    content: '';
    position: absolute;
    right: -6px;
    top: 50%;
    transform: translateY(-50%) rotate(45deg);
    width: 10px;
    height: 10px;
    background: rgba(253, 251, 247, 0.97);
    border-right: 1px solid rgba(192, 160, 98, 0.3);
    border-top: 1px solid rgba(192, 160, 98, 0.3);
  }

  .milaura-bubble-label.visible {
    opacity: 1;
    transform: translateX(0);
  }

  @media screen and (max-width: 768px) {
    .milaura-bubble-label {
      bottom: 28px;
      right: 80px;
      font-size: 0.75rem;
      padding: 6px 12px;
    }
  }

  /* --- OVERLAY MOBILE --- */
  .milaura-bubble-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 99999;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    display: none;
  }

  .milaura-bubble-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  /* --- PANNEAU --- */
  .milaura-bubble-panel {
    position: fixed;
    bottom: 96px;
    right: 24px;
    width: 380px;
    max-height: 520px;
    z-index: 100000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(16px) scale(0.95);
    transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    display: flex;
    flex-direction: column;
    /* Glassmorphism */
    background: rgba(253, 251, 247, 0.95);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border-radius: 20px;
    border: 1px solid rgba(192, 160, 98, 0.25);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(192, 160, 98, 0.1);
    overflow: hidden;
  }

  .milaura-bubble-panel.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
  }

  /* --- ONGLETS --- */
  .milaura-bubble-tabs {
    display: flex;
    border-bottom: 1px solid rgba(192, 160, 98, 0.15);
    flex-shrink: 0;
  }

  .milaura-bubble-tab {
    flex: 1;
    padding: 14px 16px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-family: 'Lato', sans-serif;
    font-size: 0.85rem;
    font-weight: 600;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: color 0.3s ease, background 0.3s ease;
    position: relative;
  }

  .milaura-bubble-tab::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 16px;
    right: 16px;
    height: 2px;
    background: var(--milaura-gold, #C0A062);
    border-radius: 2px 2px 0 0;
    transform: scaleX(0);
    transition: transform 0.3s ease;
  }

  .milaura-bubble-tab.active {
    color: var(--milaura-gold-dark, #8F723A);
  }

  .milaura-bubble-tab.active::after {
    transform: scaleX(1);
  }

  .milaura-bubble-tab:hover:not(.active) {
    color: #666;
    background: rgba(192, 160, 98, 0.05);
  }

  /* --- CONTENU DES ONGLETS --- */
  .milaura-bubble-content {
    flex: 1;
    overflow-y: auto;
    padding: 24px 20px;
  }

  .milaura-bubble-pane {
    display: none;
  }

  .milaura-bubble-pane.active {
    display: block;
  }

  /* --- ONGLET RITUEL --- */
  .milaura-bubble-ritual-kicker {
    font-family: 'Dancing Script', cursive;
    color: var(--milaura-gold, #C0A062);
    font-size: 1rem;
    margin: 0 0 6px 0;
  }

  .milaura-bubble-ritual-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.15rem;
    font-weight: 600;
    color: #000;
    margin: 0 0 10px 0;
    line-height: 1.3;
  }

  .milaura-bubble-ritual-text {
    font-family: 'Lato', sans-serif;
    font-size: 0.875rem;
    color: #555;
    line-height: 1.5;
    margin: 0 0 16px 0;
  }

  .milaura-bubble-ritual-profile {
    display: inline-block;
    padding: 4px 12px;
    background: linear-gradient(135deg, rgba(192, 160, 98, 0.15), rgba(192, 160, 98, 0.08));
    border: 1px solid rgba(192, 160, 98, 0.3);
    border-radius: 20px;
    font-family: 'Playfair Display', serif;
    font-size: 0.85rem;
    color: var(--milaura-gold-dark, #8F723A);
    font-weight: 600;
    margin-bottom: 14px;
  }

  /* Teaser list (Parcours A) */
  .milaura-bubble-teaser-list {
    list-style: none;
    padding: 0;
    margin: 0 0 14px 0;
  }

  .milaura-bubble-teaser-list li {
    font-family: 'Lato', sans-serif;
    font-size: 0.82rem;
    color: #444;
    padding: 4px 0 4px 20px;
    position: relative;
    line-height: 1.4;
  }

  .milaura-bubble-teaser-list li::before {
    content: '';
    position: absolute;
    left: 0;
    top: 9px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--milaura-gold, #C0A062), var(--milaura-gold-light, #E6C88B));
  }

  /* Bullets visuels (Parcours B) */
  .milaura-bubble-benefits {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 14px;
    text-align: left;
  }

  .milaura-bubble-benefit {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .milaura-bubble-benefit-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: linear-gradient(135deg, rgba(192, 160, 98, 0.15), rgba(192, 160, 98, 0.05));
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .milaura-bubble-benefit-icon svg {
    width: 16px;
    height: 16px;
    color: var(--milaura-gold-dark, #8F723A);
  }

  .milaura-bubble-benefit-text {
    font-family: 'Lato', sans-serif;
    font-size: 0.8rem;
    color: #333;
    line-height: 1.3;
  }

  /* Lien quiz (Parcours B2) */
  .milaura-bubble-quiz-link {
    display: block;
    text-align: center;
    margin-top: 14px;
    font-family: 'Lato', sans-serif;
    font-size: 0.78rem;
    color: var(--milaura-gold-dark, #8F723A);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .milaura-bubble-quiz-link:hover {
    color: var(--milaura-gold, #C0A062);
    text-decoration: underline;
  }

  /* Micro-quiz dans la bulle (Parcours B2) */
  .milaura-bubble-microquiz {
    margin-bottom: 16px;
  }

  .milaura-bubble-microquiz-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .milaura-bubble-microquiz-btn {
    padding: 10px 8px;
    border: 1px solid rgba(192, 160, 98, 0.25);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    font-family: 'Lato', sans-serif;
    font-size: 0.8rem;
    font-weight: 500;
    color: #333;
    transition: all 0.2s ease;
    text-align: center;
  }

  .milaura-bubble-microquiz-btn:last-child:nth-child(odd) {
    grid-column: 1 / -1;
  }

  .milaura-bubble-microquiz-btn:hover {
    border-color: var(--milaura-gold, #C0A062);
    background: rgba(192, 160, 98, 0.08);
    color: var(--milaura-gold-dark, #8F723A);
    transform: translateY(-1px);
  }

  .milaura-bubble-microquiz-btn.selected {
    border-color: var(--milaura-gold, #C0A062);
    background: linear-gradient(135deg, rgba(192, 160, 98, 0.15), rgba(192, 160, 98, 0.08));
    color: var(--milaura-gold-dark, #8F723A);
    font-weight: 600;
  }

  /* Formulaire email */
  .milaura-bubble-form {
    display: flex;
    gap: 8px;
  }

  .milaura-bubble-email {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid rgba(192, 160, 98, 0.25);
    border-radius: 50px;
    background: rgba(255, 255, 255, 0.8);
    font-family: 'Lato', sans-serif;
    font-size: 0.85rem;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }

  .milaura-bubble-email:focus {
    outline: none;
    border-color: var(--milaura-gold, #C0A062);
    box-shadow: 0 0 0 3px rgba(192, 160, 98, 0.12);
  }

  .milaura-bubble-submit {
    padding: 10px 18px;
    background: linear-gradient(135deg, var(--milaura-gold, #C0A062), var(--milaura-gold-light, #E6C88B));
    color: #fff;
    border: none;
    border-radius: 50px;
    font-family: 'Lato', sans-serif;
    font-size: 0.8rem;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    white-space: nowrap;
  }

  .milaura-bubble-submit:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(192, 160, 98, 0.35);
  }

  /* Etat inscrit (Parcours C) */
  .milaura-bubble-subscribed {
    text-align: center;
    padding: 12px 0;
  }

  .milaura-bubble-subscribed-greeting {
    font-family: 'Dancing Script', cursive;
    color: var(--milaura-gold, #C0A062);
    font-size: 1.05rem;
    margin: 0 0 8px 0;
  }

  .milaura-bubble-subscribed-profile {
    display: inline-block;
    padding: 4px 12px;
    background: linear-gradient(135deg, rgba(192, 160, 98, 0.15), rgba(192, 160, 98, 0.08));
    border: 1px solid rgba(192, 160, 98, 0.3);
    border-radius: 20px;
    font-family: 'Playfair Display', serif;
    font-size: 0.85rem;
    color: var(--milaura-gold-dark, #8F723A);
    font-weight: 600;
    margin-bottom: 12px;
  }

  .milaura-bubble-subscribed-text {
    font-family: 'Lato', sans-serif;
    font-size: 0.85rem;
    color: #555;
    line-height: 1.5;
    margin: 0 0 12px 0;
  }

  .milaura-bubble-subscribed-retention {
    font-family: 'Lato', sans-serif;
    font-size: 0.8rem;
    color: var(--milaura-gold-dark, #8F723A);
    font-style: italic;
    line-height: 1.4;
    margin: 0 0 14px 0;
  }

  .milaura-bubble-dashboard-link {
    display: inline-block;
    padding: 10px 20px;
    border: 1px solid rgba(192, 160, 98, 0.3);
    border-radius: 50px;
    background: transparent;
    font-family: 'Lato', sans-serif;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--milaura-gold-dark, #8F723A);
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .milaura-bubble-dashboard-link:hover {
    background: rgba(192, 160, 98, 0.08);
    border-color: var(--milaura-gold, #C0A062);
    transform: translateY(-1px);
  }

  /* Message de succes */
  .milaura-bubble-success {
    display: none;
    text-align: center;
    padding: 20px 0;
  }

  .milaura-bubble-success.active {
    display: block;
  }

  .milaura-bubble-success-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
  }

  .milaura-bubble-success-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 600;
    color: #000;
    margin: 0 0 6px 0;
  }

  .milaura-bubble-success-text {
    font-family: 'Lato', sans-serif;
    font-size: 0.85rem;
    color: #555;
    margin: 0;
  }

  .milaura-bubble-promo {
    margin-top: 14px;
    padding: 12px 16px;
    background: linear-gradient(135deg, rgba(192, 160, 98, 0.12), rgba(192, 160, 98, 0.05));
    border: 1px dashed rgba(192, 160, 98, 0.4);
    border-radius: 12px;
  }

  .milaura-bubble-promo-label {
    font-family: 'Lato', sans-serif;
    font-size: 0.72rem;
    color: #666;
    margin: 0 0 4px 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .milaura-bubble-promo-code {
    font-family: 'Playfair Display', serif;
    font-size: 1.15rem;
    font-weight: 700;
    color: var(--milaura-gold-dark, #8F723A);
    letter-spacing: 2px;
    margin: 0;
    user-select: all;
    cursor: pointer;
  }

  /* --- ONGLET CONTACT --- */
  .milaura-bubble-contact-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    font-weight: 600;
    color: #000;
    margin: 0 0 20px 0;
  }

  .milaura-bubble-contact-methods {
    display: flex;
    flex-direction: column;
    gap: 14px;
    margin-bottom: 24px;
  }

  .milaura-bubble-contact-method {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 18px;
    background: rgba(255, 255, 255, 0.6);
    border: 1px solid rgba(192, 160, 98, 0.15);
    border-radius: 16px;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
  }

  .milaura-bubble-contact-method:hover {
    border-color: var(--milaura-gold, #C0A062);
    background: rgba(192, 160, 98, 0.05);
    transform: translateY(-1px);
  }

  .milaura-bubble-contact-method-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(192, 160, 98, 0.15), rgba(192, 160, 98, 0.08));
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .milaura-bubble-contact-method-icon svg {
    width: 24px;
    height: 24px;
    color: var(--milaura-gold-dark, #8F723A);
  }

  .milaura-bubble-contact-method-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .milaura-bubble-contact-method-label {
    font-family: 'Lato', sans-serif;
    font-size: 1.15rem;
    font-weight: 600;
    color: #000;
  }

  .milaura-bubble-contact-method-detail {
    font-family: 'Lato', sans-serif;
    font-size: 0.95rem;
    color: #888;
  }

  /* WhatsApp */
  .milaura-bubble-whatsapp-icon {
    background: rgba(37, 211, 102, 0.15) !important;
  }

  .milaura-bubble-whatsapp-icon svg {
    color: #25D366 !important;
  }

  .milaura-bubble-whatsapp:hover {
    background: rgba(37, 211, 102, 0.08);
  }

  /* Mini formulaire contact rapide */
  .milaura-bubble-quick-form {
    margin-top: 4px;
  }

  .milaura-bubble-quick-form-title {
    font-family: 'Lato', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #999;
    margin: 0 0 10px 0;
  }

  .milaura-bubble-quick-field {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid rgba(192, 160, 98, 0.2);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.7);
    font-family: 'Lato', sans-serif;
    font-size: 0.85rem;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    margin-bottom: 8px;
    box-sizing: border-box;
  }

  .milaura-bubble-quick-field:focus {
    outline: none;
    border-color: var(--milaura-gold, #C0A062);
    box-shadow: 0 0 0 3px rgba(192, 160, 98, 0.1);
  }

  textarea.milaura-bubble-quick-field {
    resize: vertical;
    min-height: 72px;
  }

  .milaura-bubble-quick-submit {
    width: 100%;
    padding: 11px 16px;
    background: linear-gradient(135deg, var(--milaura-gold, #C0A062), var(--milaura-gold-light, #E6C88B));
    color: #fff;
    border: none;
    border-radius: 50px;
    font-family: 'Lato', sans-serif;
    font-size: 0.85rem;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    margin-top: 4px;
  }

  .milaura-bubble-quick-submit:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(192, 160, 98, 0.35);
  }

  .milaura-bubble-contact-page-link {
    display: block;
    text-align: center;
    margin-top: 16px;
    font-family: 'Lato', sans-serif;
    font-size: 0.8rem;
    color: var(--milaura-gold-dark, #8F723A);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .milaura-bubble-contact-page-link:hover {
    color: var(--milaura-gold, #C0A062);
    text-decoration: underline;
  }

  /* --- MOBILE --- */
  @media screen and (max-width: 768px) {
    .milaura-bubble-trigger {
      width: 56px;
      height: 56px;
      bottom: 20px;
      right: 16px;
    }

    .milaura-bubble-trigger svg {
      width: 24px;
      height: 24px;
    }

    .milaura-bubble-overlay {
      display: block;
    }

    .milaura-bubble-panel {
      bottom: 0;
      right: 0;
      left: 0;
      width: 100%;
      max-height: 85vh;
      border-radius: 20px 20px 0 0;
      transform: translateY(100%);
      transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .milaura-bubble-panel.active {
      transform: translateY(0);
    }
  }

  /* --- REDUCED MOTION --- */
  @media (prefers-reduced-motion: reduce) {
    .milaura-bubble-trigger,
    .milaura-bubble-trigger::before,
    .milaura-bubble-trigger svg,
    .milaura-bubble-panel,
    .milaura-bubble-overlay,
    .milaura-bubble-tab,
    .milaura-bubble-tab::after,
    .milaura-bubble-microquiz-btn,
    .milaura-bubble-submit,
    .milaura-bubble-contact-method,
    .milaura-bubble-quick-submit {
      animation: none !important;
      transition: none !important;
    }
  }
{% endstyle %}

<!-- Overlay mobile -->
<div class="milaura-bubble-overlay" id="milaura-bubble-overlay"></div>

<!-- Panneau -->
<div
  class="milaura-bubble-panel"
  id="milaura-bubble-panel"
  role="dialog"
  aria-modal="true"
  aria-label="{{ section.settings.panel_aria_label | default: 'Assistance et rituel personnalise' }}"
>
  <!-- Onglets -->
  <div class="milaura-bubble-tabs" role="tablist">
    <button
      class="milaura-bubble-tab active"
      role="tab"
      id="milaura-tab-ritual"
      aria-selected="true"
      aria-controls="milaura-pane-ritual"
      data-tab="ritual"
    >{{ section.settings.tab_ritual_label | default: 'Mon Rituel' }}</button>
    <button
      class="milaura-bubble-tab"
      role="tab"
      id="milaura-tab-contact"
      aria-selected="false"
      aria-controls="milaura-pane-contact"
      data-tab="contact"
    >{{ section.settings.tab_contact_label | default: 'Contact' }}</button>
  </div>

  <!-- Contenu -->
  <div class="milaura-bubble-content">

    <!-- ONGLET RITUEL -->
    <div
      class="milaura-bubble-pane active"
      role="tabpanel"
      id="milaura-pane-ritual"
      aria-labelledby="milaura-tab-ritual"
    >
      <!-- Parcours A : a fait le quiz -->
      <div id="milaura-bubble-ritual-a" style="display:none;">
        <p class="milaura-bubble-ritual-kicker">{{ section.settings.ritual_kicker_a | default: 'Ton profil' }}</p>
        <div class="milaura-bubble-ritual-profile" id="milaura-bubble-profile-name"></div>
        <h3 class="milaura-bubble-ritual-title">{{ section.settings.ritual_title_a | default: 'Ton rituel sur-mesure t attend' }}</h3>
        <p class="milaura-bubble-ritual-text">{{ section.settings.ritual_text_a | default: 'Chaque mois dans ta boite mail :' }}</p>
        <ul class="milaura-bubble-teaser-list">
          <li>{{ section.settings.teaser_1 | default: 'Guide pierre & intention du mois' }}</li>
          <li>{{ section.settings.teaser_2 | default: 'Conseil rituel personnalise' }}</li>
          <li>{{ section.settings.teaser_3 | default: 'Offre exclusive membre' }}</li>
        </ul>
        <form class="milaura-bubble-form" id="milaura-bubble-form-a" method="post" action="/contact#contact_form" accept-charset="UTF-8">
          <input type="hidden" name="form_type" value="customer">
          <input type="hidden" name="utf8" value="âœ“">
          <input type="hidden" name="contact[tags]" value="newsletter,rituel,source:bubble">
          <input type="hidden" name="contact[note]" id="milaura-bubble-note-a" value="">
          <label for="milaura-bubble-email-a" class="visually-hidden">Email</label>
          <input type="email" id="milaura-bubble-email-a" name="contact[email]" class="milaura-bubble-email" placeholder="{{ section.settings.email_placeholder | default: 'ton@email.com' }}" required autocomplete="email">
          <button type="submit" class="milaura-bubble-submit">{{ section.settings.ritual_btn_a | default: 'Recevoir mon rituel gratuit' }}</button>
        </form>
      </div>

      <!-- Parcours B : pas de quiz â€” Etape 1 : email d'abord -->
      <div id="milaura-bubble-ritual-b" style="display:none;">
        <p class="milaura-bubble-ritual-kicker">{{ section.settings.ritual_kicker_b | default: 'Rien que pour toi' }}</p>
        <h3 class="milaura-bubble-ritual-title">{{ section.settings.ritual_title_b | default: 'Recois ton premier rituel bien-etre offert' }}</h3>
        <div class="milaura-bubble-benefits">
          <div class="milaura-bubble-benefit">
            <div class="milaura-bubble-benefit-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
            </div>
            <span class="milaura-bubble-benefit-text">{{ section.settings.benefit_1 | default: 'Guide pierres & intention du mois' }}</span>
          </div>
          <div class="milaura-bubble-benefit">
            <div class="milaura-bubble-benefit-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            </div>
            <span class="milaura-bubble-benefit-text">{{ section.settings.benefit_2 | default: 'Conseil rituel personnalise' }}</span>
          </div>
          <div class="milaura-bubble-benefit">
            <div class="milaura-bubble-benefit-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            </div>
            <span class="milaura-bubble-benefit-text">{{ section.settings.benefit_3 | default: 'Offres exclusives membres' }}</span>
          </div>
        </div>
        <p class="milaura-bubble-subscribed-retention">{{ section.settings.retention_text | default: "Et dans 30 jours, un rappel pour rafraichir ton quiz et decouvrir ta nouvelle pierre du moment." }}</p>
        <form class="milaura-bubble-form" id="milaura-bubble-form-b" method="post" action="/contact#contact_form" accept-charset="UTF-8">
          <input type="hidden" name="form_type" value="customer">
          <input type="hidden" name="utf8" value="âœ“">
          <input type="hidden" name="contact[tags]" value="newsletter,rituel,source:bubble">
          <input type="hidden" name="contact[note]" id="milaura-bubble-note-b" value="">
          <label for="milaura-bubble-email-b" class="visually-hidden">Email</label>
          <input type="email" id="milaura-bubble-email-b" name="contact[email]" class="milaura-bubble-email" placeholder="{{ section.settings.email_placeholder | default: 'ton@email.com' }}" required autocomplete="email">
          <button type="submit" class="milaura-bubble-submit">{{ section.settings.ritual_btn_b | default: 'Recevoir mon rituel' }}</button>
        </form>
      </div>

      <!-- Parcours B2 : preferences post-email (optionnel) -->
      <div id="milaura-bubble-ritual-b2" style="display:none;">
        <p class="milaura-bubble-ritual-kicker">{{ section.settings.b2_kicker | default: 'Merci !' }}</p>
        <h3 class="milaura-bubble-ritual-title">{{ section.settings.b2_title | default: 'Personnalise ton experience' }}</h3>
        <p class="milaura-bubble-ritual-text">{{ section.settings.b2_text | default: "Choisis l'energie qui te parle â€” c'est optionnel mais ca nous aide a te proposer le meilleur." }}</p>
        <div class="milaura-bubble-microquiz" id="milaura-bubble-microquiz">
          <div class="milaura-bubble-microquiz-grid">
            <button class="milaura-bubble-microquiz-btn" data-energy="apaisement">{{ section.settings.energy_1 | default: 'Apaisement' }}</button>
            <button class="milaura-bubble-microquiz-btn" data-energy="protection">{{ section.settings.energy_2 | default: 'Protection' }}</button>
            <button class="milaura-bubble-microquiz-btn" data-energy="serenite">{{ section.settings.energy_3 | default: 'Serenite' }}</button>
            <button class="milaura-bubble-microquiz-btn" data-energy="amour">{{ section.settings.energy_4 | default: 'Amour' }}</button>
            <button class="milaura-bubble-microquiz-btn" data-energy="chance">{{ section.settings.energy_5 | default: 'Chance' }}</button>
          </div>
        </div>
        <a href="{{ section.settings.quiz_url | default: '/pages/quiz' }}" class="milaura-bubble-quiz-link" id="milaura-bubble-skip-prefs">
          {{ section.settings.b2_quiz_cta | default: 'Ou decouvre ton profil complet avec le quiz â†’' }}
        </a>
      </div>

      <!-- Parcours C : deja inscrit -->
      <div id="milaura-bubble-ritual-c" style="display:none;">
        <div class="milaura-bubble-subscribed">
          <p class="milaura-bubble-subscribed-greeting" id="milaura-bubble-subscribed-greeting">
            {{ section.settings.subscribed_greeting | default: 'Bonjour' }}{% if customer %} {{ customer.first_name }}{% endif %}
          </p>
          <div class="milaura-bubble-subscribed-profile" id="milaura-bubble-subscribed-profile" style="display:none;"></div>
          <p class="milaura-bubble-subscribed-text">{{ section.settings.subscribed_text | default: 'Tu fais deja partie de la communaute Milaura.' }}</p>
          <p class="milaura-bubble-subscribed-retention">{{ section.settings.subscribed_retention | default: 'Ton prochain rappel quiz arrive bientot pour decouvrir ta nouvelle pierre du moment.' }}</p>
          {% if section.settings.promo_code != blank %}
            <div class="milaura-bubble-promo">
              <p class="milaura-bubble-promo-label">{{ section.settings.promo_label | default: 'Ton code -10% premiere commande' }}</p>
              <p class="milaura-bubble-promo-code">{{ section.settings.promo_code | default: 'BIENVENUE10' }}</p>
            </div>
          {% endif %}
          <a href="/account" class="milaura-bubble-dashboard-link" style="margin-top:14px;">{{ section.settings.subscribed_dashboard_label | default: 'Mon espace Milaura' }}</a>
        </div>
      </div>

      <!-- Message de succes (apres soumission) -->
      <div class="milaura-bubble-success" id="milaura-bubble-success">
        <div class="milaura-bubble-success-icon">âœ¨</div>
        <h4 class="milaura-bubble-success-title">{{ section.settings.success_title | default: 'Bienvenue dans la communaute !' }}</h4>
        <p class="milaura-bubble-success-text">{{ section.settings.success_text | default: 'Ton premier rituel arrive bientot. Dans 30 jours, tu recevras un rappel pour rafraichir ton quiz et choisir la pierre qui t accompagnera.' }}</p>
        {% if section.settings.promo_code != blank %}
          <div class="milaura-bubble-promo">
            <p class="milaura-bubble-promo-label">{{ section.settings.promo_label | default: 'Ton code -10% premiere commande' }}</p>
            <p class="milaura-bubble-promo-code">{{ section.settings.promo_code | default: 'BIENVENUE10' }}</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- ONGLET CONTACT -->
    <div
      class="milaura-bubble-pane"
      role="tabpanel"
      id="milaura-pane-contact"
      aria-labelledby="milaura-tab-contact"
    >
      <h3 class="milaura-bubble-contact-title">{{ section.settings.contact_title | default: "Comment pouvons-nous t'aider ?" }}</h3>

      <div class="milaura-bubble-contact-methods">
        {% assign bubble_phone = section.settings.contact_phone | default: "03 72 39 64 73" %}
        {% assign bubble_email = section.settings.contact_email %}
        {% if bubble_email == blank or bubble_email == "hello@milaura.fr" %}
          {% assign bubble_email = "contact@milaura.fr" %}
        {% endif %}

          <a href="tel:{{ bubble_phone | replace: ' ', '' }}" class="milaura-bubble-contact-method">
            <div class="milaura-bubble-contact-method-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
            </div>
            <div class="milaura-bubble-contact-method-info">
              <span class="milaura-bubble-contact-method-label">{{ bubble_phone }}</span>
              <span class="milaura-bubble-contact-method-detail">{{ section.settings.contact_phone_hours | default: 'Lun-Ven 9h-18h' }}</span>
            </div>
          </a>

        {% if section.settings.contact_whatsapp != blank %}
          <a href="https://wa.me/{{ section.settings.contact_whatsapp }}?text={{ section.settings.contact_whatsapp_prefill | default: 'Bonjour, j ai une question...' | url_encode }}" target="_blank" rel="noopener" class="milaura-bubble-contact-method milaura-bubble-whatsapp">
            <div class="milaura-bubble-contact-method-icon milaura-bubble-whatsapp-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
            </div>
            <div class="milaura-bubble-contact-method-info">
              <span class="milaura-bubble-contact-method-label">WhatsApp</span>
              <span class="milaura-bubble-contact-method-detail">{{ section.settings.contact_whatsapp_delay | default: 'Reponse sous 2h' }}</span>
            </div>
          </a>
        {% endif %}

          <a href="mailto:{{ bubble_email }}" class="milaura-bubble-contact-method">
            <div class="milaura-bubble-contact-method-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            </div>
            <div class="milaura-bubble-contact-method-info">
              <span class="milaura-bubble-contact-method-label">{{ bubble_email }}</span>
              <span class="milaura-bubble-contact-method-detail">{{ section.settings.contact_email_delay | default: 'Reponse sous 24h' }}</span>
            </div>
          </a>
      </div>

      <!-- Formulaire rapide -->
      <div class="milaura-bubble-quick-form">
        <p class="milaura-bubble-quick-form-title">{{ section.settings.quick_form_title | default: 'Ou ecris-nous directement' }}</p>
        <form id="milaura-bubble-contact-form" method="post" action="/contact#contact_form" accept-charset="UTF-8">
          <input type="hidden" name="form_type" value="contact">
          <input type="hidden" name="utf8" value="âœ“">
          <label for="milaura-bubble-contact-email" class="visually-hidden">Email</label>
          <input type="email" id="milaura-bubble-contact-email" name="contact[email]" class="milaura-bubble-quick-field" placeholder="{{ section.settings.email_placeholder | default: 'ton@email.com' }}" required autocomplete="email">
          <label for="milaura-bubble-contact-message" class="visually-hidden">Message</label>
          <textarea id="milaura-bubble-contact-message" name="contact[body]" class="milaura-bubble-quick-field" placeholder="{{ section.settings.contact_message_placeholder | default: 'Ton message...' }}" required rows="3"></textarea>
          <button type="submit" class="milaura-bubble-quick-submit">{{ section.settings.contact_submit_label | default: 'Envoyer' }}</button>
        </form>
        <!-- Succes contact -->
        <div class="milaura-bubble-success" id="milaura-bubble-contact-success">
          <div class="milaura-bubble-success-icon">ðŸ’Œ</div>
          <h4 class="milaura-bubble-success-title">{{ section.settings.contact_success_title | default: 'Message envoye !' }}</h4>
          <p class="milaura-bubble-success-text">{{ section.settings.contact_success_text | default: 'Nous te repondons sous 24h.' }}</p>
        </div>
      </div>

      {% if section.settings.contact_page_url != blank %}
        <a href="{{ section.settings.contact_page_url }}" class="milaura-bubble-contact-page-link">
          {{ section.settings.contact_page_label | default: 'Voir la page contact complete â†’' }}
        </a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Micro-label -->
<div class="milaura-bubble-label" id="milaura-bubble-label">
  {{ section.settings.bubble_label | default: 'Un cadeau pour toi' }}
</div>

<!-- Bouton trigger -->
<button
  class="milaura-bubble-trigger"
  id="milaura-bubble-trigger"
  aria-label="{{ section.settings.trigger_aria_label | default: "Ouvrir l'assistance" }}"
  aria-expanded="false"
  aria-controls="milaura-bubble-panel"
>
  <!-- Cadeau luxe -->
  <svg class="bubble-icon-gift" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
    <!-- Boite -->
    <rect x="3" y="11" width="18" height="10" rx="1.5" stroke-width="1.4"/>
    <!-- Couvercle -->
    <rect x="2" y="8" width="20" height="3.5" rx="1" stroke-width="1.4"/>
    <!-- Ruban vertical -->
    <line x1="12" y1="8" x2="12" y2="21" stroke-width="1.2"/>
    <!-- Noeud gauche -->
    <path d="M12 8.5C10.5 8.5 8 7.5 7.5 5.5C7 3.5 9 2.5 10.5 3.5C11.5 4.2 12 6 12 8.5z" stroke-width="1.2"/>
    <!-- Noeud droit -->
    <path d="M12 8.5C13.5 8.5 16 7.5 16.5 5.5C17 3.5 15 2.5 13.5 3.5C12.5 4.2 12 6 12 8.5z" stroke-width="1.2"/>
  </svg>
  <!-- X -->
  <svg class="bubble-icon-close" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <line x1="18" y1="6" x2="6" y2="18"/>
    <line x1="6" y1="6" x2="18" y2="18"/>
  </svg>
</button>

<script>
(function() {
  'use strict';

  var trigger = document.getElementById('milaura-bubble-trigger');
  var panel = document.getElementById('milaura-bubble-panel');
  var overlay = document.getElementById('milaura-bubble-overlay');
  var labelEl = document.getElementById('milaura-bubble-label');
  var isOpen = false;

  var profileLabels = {
    apaisement: 'Apaisement',
    protection: 'Protection',
    serenite: 'Serenite',
    amour: 'Amour',
    chance: 'Chance'
  };

  /* --- Determine state --- */
  function isSubscribed() {
    try { return localStorage.getItem('milauraNewsletterSubscribed') === 'true'; } catch(e) { return false; }
  }

  function getQuizResult() {
    try {
      var raw = localStorage.getItem('milauraLastResult');
      if (raw) return JSON.parse(raw);
    } catch(e) {}
    return null;
  }

  /* --- Micro-label animation --- */
  function showMicroLabel() {
    if (isSubscribed() || isOpen) return;
    try { if (sessionStorage.getItem('milauraLabelShown')) return; } catch(e) {}

    setTimeout(function() {
      if (isOpen) return;
      labelEl.classList.add('visible');
      setTimeout(function() {
        labelEl.classList.remove('visible');
        /* Deuxieme pulse apres 3s */
        setTimeout(function() {
          if (isOpen) return;
          labelEl.classList.add('visible');
          setTimeout(function() {
            labelEl.classList.remove('visible');
            try { sessionStorage.setItem('milauraLabelShown', 'true'); } catch(e) {}
          }, 3000);
        }, 3000);
      }, 4000);
    }, 2000);
  }

  showMicroLabel();

  /* --- Render ritual pane based on state --- */
  function renderRitualPane() {
    var paneA = document.getElementById('milaura-bubble-ritual-a');
    var paneB = document.getElementById('milaura-bubble-ritual-b');
    var paneB2 = document.getElementById('milaura-bubble-ritual-b2');
    var paneC = document.getElementById('milaura-bubble-ritual-c');
    var successEl = document.getElementById('milaura-bubble-success');

    paneA.style.display = 'none';
    paneB.style.display = 'none';
    paneB2.style.display = 'none';
    paneC.style.display = 'none';
    successEl.classList.remove('active');

    if (isSubscribed()) {
      paneC.style.display = 'block';
      /* Show quiz profile badge if available */
      var result = getQuizResult();
      var profileBadge = document.getElementById('milaura-bubble-subscribed-profile');
      if (result && result.profile && profileBadge) {
        var label = profileLabels[result.profile] || result.profile;
        profileBadge.textContent = label;
        profileBadge.style.display = 'inline-block';
      }
      return;
    }

    var result = getQuizResult();
    if (result && result.profile) {
      paneA.style.display = 'block';
      var profileName = document.getElementById('milaura-bubble-profile-name');
      var noteField = document.getElementById('milaura-bubble-note-a');
      var label = profileLabels[result.profile] || result.profile;
      if (profileName) profileName.textContent = label;
      if (noteField) noteField.value = 'Profil: ' + label;
    } else {
      paneB.style.display = 'block';
    }
  }

  /* --- Tabs --- */
  var tabs = panel.querySelectorAll('.milaura-bubble-tab');
  var panes = panel.querySelectorAll('.milaura-bubble-pane');

  function switchTab(tabName) {
    tabs.forEach(function(t) {
      var isTarget = t.getAttribute('data-tab') === tabName;
      t.classList.toggle('active', isTarget);
      t.setAttribute('aria-selected', isTarget ? 'true' : 'false');
    });
    panes.forEach(function(p) {
      p.classList.toggle('active', p.id === 'milaura-pane-' + tabName);
    });
  }

  tabs.forEach(function(tab) {
    tab.addEventListener('click', function() {
      switchTab(this.getAttribute('data-tab'));
    });
  });

  /* --- Open / Close --- */
  function openBubble(tabName) {
    /* Hide label when opening */
    labelEl.classList.remove('visible');

    if (isOpen) {
      if (tabName) switchTab(tabName);
      return;
    }
    renderRitualPane();
    if (tabName) switchTab(tabName);
    panel.classList.add('active');
    overlay.classList.add('active');
    trigger.setAttribute('aria-expanded', 'true');
    isOpen = true;
    trapFocus();
  }

  function closeBubble() {
    if (!isOpen) return;
    panel.classList.remove('active');
    overlay.classList.remove('active');
    trigger.setAttribute('aria-expanded', 'false');
    isOpen = false;
    trigger.focus();
  }

  /* Public API */
  window.milauraOpenBubble = function(tab) { openBubble(tab || 'ritual'); };
  window.milauraCloseBubble = closeBubble;

  /* Trigger click */
  trigger.addEventListener('click', function() {
    if (isOpen) { closeBubble(); } else { openBubble('ritual'); }
  });

  /* Overlay click */
  overlay.addEventListener('click', closeBubble);

  /* Escape */
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && isOpen) closeBubble();
  });

  /* --- Focus trap --- */
  function trapFocus() {
    var focusable = panel.querySelectorAll('button, [href], input, textarea, select, [tabindex]:not([tabindex="-1"])');
    if (focusable.length === 0) return;
    var first = focusable[0];
    var last = focusable[focusable.length - 1];
    first.focus();

    panel.addEventListener('keydown', function handler(e) {
      if (e.key !== 'Tab') return;
      if (!isOpen) { panel.removeEventListener('keydown', handler); return; }
      if (e.shiftKey) {
        if (document.activeElement === first) { e.preventDefault(); last.focus(); }
      } else {
        if (document.activeElement === last) { e.preventDefault(); first.focus(); }
      }
    });
  }

  /* --- Micro-quiz (Parcours B2 â€” post-email) --- */
  var microquizBtns = document.querySelectorAll('.milaura-bubble-microquiz-btn');
  microquizBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      microquizBtns.forEach(function(b) { b.classList.remove('selected'); });
      btn.classList.add('selected');
      var energy = btn.getAttribute('data-energy');
      /* Update stored note with energy preference */
      try {
        var existing = localStorage.getItem('milauraNewsletterNote') || '';
        localStorage.setItem('milauraNewsletterNote', existing + ' | Energie: ' + (profileLabels[energy] || energy));
      } catch(e) {}
    });
  });

  /* --- Form submissions (newsletter) --- */
  function handleNewsletterSubmit(formEl, e, isPathA) {
    e.preventDefault();
    var emailInput = formEl.querySelector('input[type="email"]');
    if (!emailInput || !emailInput.value) return;

    var formData = new FormData(formEl);

    fetch('/contact#contact_form', {
      method: 'POST',
      body: formData,
      headers: { 'Accept': 'text/html' }
    }).then(function() {
      try {
        localStorage.setItem('milauraNewsletterSubscribed', 'true');
        localStorage.setItem('milauraNewsletterNote', formEl.querySelector('[name="contact[note]"]').value || '');
      } catch(e) {}
      /* Dispatch event for popup sync */
      document.dispatchEvent(new CustomEvent('milaura:newsletter-subscribed'));

      if (isPathA) {
        /* Parcours A: show success directly */
        document.getElementById('milaura-bubble-ritual-a').style.display = 'none';
        document.getElementById('milaura-bubble-success').classList.add('active');
      } else {
        /* Parcours B: transition to B2 (preferences) */
        document.getElementById('milaura-bubble-ritual-b').style.display = 'none';
        document.getElementById('milaura-bubble-ritual-b2').style.display = 'block';
      }
    }).catch(function() {
      formEl.submit();
    });
  }

  var formA = document.getElementById('milaura-bubble-form-a');
  var formB = document.getElementById('milaura-bubble-form-b');
  if (formA) formA.addEventListener('submit', function(e) { handleNewsletterSubmit(this, e, true); });
  if (formB) formB.addEventListener('submit', function(e) { handleNewsletterSubmit(this, e, false); });

  /* --- Contact form submission --- */
  var contactForm = document.getElementById('milaura-bubble-contact-form');
  if (contactForm) {
    contactForm.addEventListener('submit', function(e) {
      e.preventDefault();
      var formData = new FormData(contactForm);

      fetch('/contact#contact_form', {
        method: 'POST',
        body: formData,
        headers: { 'Accept': 'text/html' }
      }).then(function() {
        contactForm.style.display = 'none';
        var successEl = document.getElementById('milaura-bubble-contact-success');
        if (successEl) successEl.classList.add('active');
      }).catch(function() {
        contactForm.submit();
      });
    });
  }

  /* --- Listen for quiz result event --- */
  document.addEventListener('milaura:quiz-result', function() {
    renderRitualPane();
  });

  /* --- Listen for external subscription --- */
  document.addEventListener('milaura:newsletter-subscribed', function() {
    renderRitualPane();
  });

})();
</script>

{% schema %}
{
  "name": "Milaura Bulle Flottante",
  "settings": [
    {
      "type": "header",
      "content": "Onglets"
    },
    {
      "type": "text",
      "id": "tab_ritual_label",
      "label": "Label onglet Rituel",
      "default": "Mon Rituel"
    },
    {
      "type": "text",
      "id": "tab_contact_label",
      "label": "Label onglet Contact",
      "default": "Contact"
    },
    {
      "type": "header",
      "content": "Rituel - Parcours A (quiz fait)"
    },
    {
      "type": "text",
      "id": "ritual_kicker_a",
      "label": "Kicker",
      "default": "Votre profil emotionnel"
    },
    {
      "type": "textarea",
      "id": "ritual_text_a",
      "label": "Texte",
      "default": "Recevez chaque mois un rituel personnalise adapte a votre profil emotionnel."
    },
    {
      "type": "text",
      "id": "ritual_title_a",
      "label": "Titre parcours A",
      "default": "Ton rituel sur-mesure t attend"
    },
    {
      "type": "text",
      "id": "ritual_btn_a",
      "label": "Bouton",
      "default": "Recevoir mon rituel gratuit"
    },
    {
      "type": "text",
      "id": "teaser_1",
      "label": "Teaser ligne 1",
      "default": "Guide pierre & intention du mois"
    },
    {
      "type": "text",
      "id": "teaser_2",
      "label": "Teaser ligne 2",
      "default": "Conseil rituel personnalise"
    },
    {
      "type": "text",
      "id": "teaser_3",
      "label": "Teaser ligne 3",
      "default": "Offre exclusive membre"
    },
    {
      "type": "header",
      "content": "Rituel - Parcours B (pas de quiz)"
    },
    {
      "type": "text",
      "id": "ritual_kicker_b",
      "label": "Kicker",
      "default": "Rien que pour toi"
    },
    {
      "type": "text",
      "id": "ritual_title_b",
      "label": "Titre",
      "default": "Recois ton premier rituel bien-etre offert"
    },
    {
      "type": "text",
      "id": "benefit_1",
      "label": "Benefice 1",
      "default": "Guide pierres & intention du mois"
    },
    {
      "type": "text",
      "id": "benefit_2",
      "label": "Benefice 2",
      "default": "Conseil rituel personnalise"
    },
    {
      "type": "text",
      "id": "benefit_3",
      "label": "Benefice 3",
      "default": "Offres exclusives membres"
    },
    {
      "type": "textarea",
      "id": "retention_text",
      "label": "Texte de retention",
      "default": "Et dans 30 jours, un rappel pour rafraichir ton quiz et decouvrir ta nouvelle pierre du moment."
    },
    {
      "type": "text",
      "id": "ritual_btn_b",
      "label": "Bouton",
      "default": "Recevoir mon rituel"
    },
    {
      "type": "header",
      "content": "Rituel - Parcours B2 (preferences post-email)"
    },
    {
      "type": "text",
      "id": "b2_kicker",
      "label": "Kicker B2",
      "default": "Merci !"
    },
    {
      "type": "text",
      "id": "b2_title",
      "label": "Titre B2",
      "default": "Personnalise ton experience"
    },
    {
      "type": "textarea",
      "id": "b2_text",
      "label": "Texte B2",
      "default": "Choisis l'energie qui te parle â€” c'est optionnel mais ca nous aide a te proposer le meilleur."
    },
    {
      "type": "text",
      "id": "b2_quiz_cta",
      "label": "Lien quiz B2",
      "default": "Ou decouvre ton profil complet avec le quiz â†’"
    },
    {
      "type": "url",
      "id": "quiz_url",
      "label": "URL page quiz"
    },
    {
      "type": "text",
      "id": "energy_1",
      "label": "Energie 1",
      "default": "Apaisement"
    },
    {
      "type": "text",
      "id": "energy_2",
      "label": "Energie 2",
      "default": "Protection"
    },
    {
      "type": "text",
      "id": "energy_3",
      "label": "Energie 3",
      "default": "Serenite"
    },
    {
      "type": "text",
      "id": "energy_4",
      "label": "Energie 4",
      "default": "Amour"
    },
    {
      "type": "text",
      "id": "energy_5",
      "label": "Energie 5",
      "default": "Chance"
    },
    {
      "type": "header",
      "content": "Messages par energie"
    },
    {
      "type": "text",
      "id": "msg_apaisement",
      "label": "Message Apaisement",
      "default": "L'apaisement que tu cherches est a portee de main."
    },
    {
      "type": "text",
      "id": "msg_protection",
      "label": "Message Protection",
      "default": "Ta protection interieure commence ici."
    },
    {
      "type": "text",
      "id": "msg_serenite",
      "label": "Message Serenite",
      "default": "La serenite t'attend, laisse-la entrer."
    },
    {
      "type": "text",
      "id": "msg_amour",
      "label": "Message Amour",
      "default": "L'amour commence par un geste envers toi-meme."
    },
    {
      "type": "text",
      "id": "msg_chance",
      "label": "Message Chance",
      "default": "La chance sourit a celles qui osent."
    },
    {
      "type": "header",
      "content": "Parcours C (inscrit)"
    },
    {
      "type": "text",
      "id": "subscribed_greeting",
      "label": "Salutation",
      "default": "Bonjour"
    },
    {
      "type": "textarea",
      "id": "subscribed_text",
      "label": "Texte inscrit",
      "default": "Tu fais deja partie de la communaute Milaura."
    },
    {
      "type": "textarea",
      "id": "subscribed_retention",
      "label": "Message retention",
      "default": "Ton prochain rappel quiz arrive bientot pour decouvrir ta nouvelle pierre du moment."
    },
    {
      "type": "text",
      "id": "subscribed_dashboard_label",
      "label": "Label lien dashboard",
      "default": "Mon espace Milaura"
    },
    {
      "type": "header",
      "content": "Succes inscription & Code promo"
    },
    {
      "type": "text",
      "id": "promo_code",
      "label": "Code promo",
      "default": "BIENVENUE10",
      "info": "Laisser vide pour masquer le bloc promo"
    },
    {
      "type": "text",
      "id": "promo_label",
      "label": "Label au-dessus du code",
      "default": "Ton code -10% premiere commande"
    },
    {
      "type": "text",
      "id": "success_title",
      "label": "Titre succes",
      "default": "Bienvenue dans la communaute !"
    },
    {
      "type": "textarea",
      "id": "success_text",
      "label": "Texte succes",
      "default": "Ton premier rituel arrive bientot. Dans 30 jours, tu recevras un rappel pour rafraichir ton quiz et choisir la pierre qui t accompagnera."
    },
    {
      "type": "header",
      "content": "Onglet Contact"
    },
    {
      "type": "text",
      "id": "contact_title",
      "label": "Titre contact",
      "default": "Comment pouvons-nous t'aider ?"
    },
    {
      "type": "text",
      "id": "contact_phone",
      "label": "Telephone"
    },
    {
      "type": "text",
      "id": "contact_phone_hours",
      "label": "Horaires telephone",
      "default": "Lun-Ven 9h-18h"
    },
    {
      "type": "text",
      "id": "contact_email",
      "label": "Email",
      "default": "hello@milaura.fr"
    },
    {
      "type": "text",
      "id": "contact_email_delay",
      "label": "Delai de reponse",
      "default": "Reponse sous 24h"
    },
    {
      "type": "text",
      "id": "contact_whatsapp",
      "label": "Numero WhatsApp (sans +, ex: 33612345678)"
    },
    {
      "type": "text",
      "id": "contact_whatsapp_delay",
      "label": "Delai reponse WhatsApp",
      "default": "Reponse sous 2h"
    },
    {
      "type": "text",
      "id": "contact_whatsapp_prefill",
      "label": "Message pre-rempli WhatsApp",
      "default": "Bonjour, j'ai une question..."
    },
    {
      "type": "text",
      "id": "contact_message_placeholder",
      "label": "Placeholder message",
      "default": "Ton message..."
    },
    {
      "type": "text",
      "id": "contact_submit_label",
      "label": "Bouton envoyer",
      "default": "Envoyer"
    },
    {
      "type": "text",
      "id": "contact_success_title",
      "label": "Titre succes contact",
      "default": "Message envoye !"
    },
    {
      "type": "text",
      "id": "contact_success_text",
      "label": "Texte succes contact",
      "default": "Nous te repondons sous 24h."
    },
    {
      "type": "text",
      "id": "quick_form_title",
      "label": "Titre formulaire rapide",
      "default": "Ou ecris-nous directement"
    },
    {
      "type": "url",
      "id": "contact_page_url",
      "label": "Lien page contact"
    },
    {
      "type": "text",
      "id": "contact_page_label",
      "label": "Label lien page contact",
      "default": "Voir la page contact complete â†’"
    },
    {
      "type": "header",
      "content": "General"
    },
    {
      "type": "text",
      "id": "email_placeholder",
      "label": "Placeholder email",
      "default": "ton@email.com"
    },
    {
      "type": "text",
      "id": "bubble_label",
      "label": "Micro-label de la bulle",
      "default": "Un cadeau pour toi"
    },
    {
      "type": "text",
      "id": "trigger_aria_label",
      "label": "Aria label du bouton",
      "default": "Ouvrir l'assistance"
    },
    {
      "type": "text",
      "id": "panel_aria_label",
      "label": "Aria label du panneau",
      "default": "Assistance et rituel personnalise"
    }
  ],
  "presets": [
    {
      "name": "Milaura Bulle Flottante"
    }
  ]
}
{% endschema %}
