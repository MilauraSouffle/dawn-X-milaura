{% comment %}
  MILAURA PRODUCT STORY
  Texte √©motionnel 3-5 phrases style Aesop
  Sobre, po√©tique, respirant
  Lien quiz si produit li√© √† profil √©motionnel
  Fade-in au scroll
{% endcomment %}

{%- liquid
  assign story_text = product.metafields.milaura.story_text | default: section.settings.default_story

  assign product_type_meta = product.metafields.milaura.product_type_handle.value
  if product_type_meta != blank
    assign product_type = product_type_meta | downcase
  else
    assign product_type = product.type | handleize
  endif

  case product_type
    when 'bijou', 'bracelet', 'collier', 'bague', 'pendentif', 'fil-de-perles'
      assign default_quiz_cta = 'Decouvrez votre bijou ideal'
    when 'bougie'
      assign default_quiz_cta = 'Decouvrez votre bougie emotionnelle'
    when 'sauge', 'encens'
      assign default_quiz_cta = 'Trouvez votre rituel de purification'
    when 'coffret', 'bundle'
      assign default_quiz_cta = 'Decouvrez votre coffret sur-mesure'
    when 'pierre-roulee', 'cabochon', 'mineral', 'pierre'
      assign default_quiz_cta = 'Decouvrez votre pierre ideale'
    when 'bol-chantant', 'cymbales'
      assign default_quiz_cta = 'Decouvrez votre rituel sonore'
    when 'coussin', 'maillet'
      assign default_quiz_cta = 'Decouvrez votre profil emotionnel'
    else
      assign default_quiz_cta = 'Decouvrez votre profil emotionnel'
  endcase

  assign quiz_cta = section.settings.quiz_cta_text
  if quiz_cta == blank
    assign quiz_cta = default_quiz_cta
  endif

  assign has_story = false
  if story_text != blank
    assign has_story = true
  endif
-%}

{%- if has_story -%}
<section
  id="MilauraProductStory-{{ section.id }}"
  class="milaura-product-story"
  data-section-id="{{ section.id }}"
>
  <div class="milaura-product-story__container milaura-section-card">

    <div class="milaura-product-story__content">

      {%- if section.settings.show_label -%}
        <p class="milaura-product-story__label">
          {{ section.settings.label_text }}
        </p>
      {%- endif -%}

      {%- if story_text != blank -%}
        <div class="milaura-product-story__text">
          {{ story_text }}
        </div>
      {%- endif -%}

      {%- if section.settings.show_quiz_link -%}
        <div class="milaura-product-story__quiz">
          <a
            href="{{ section.settings.quiz_url | default: '/pages/diagnostic-emotionnel' }}"
            class="milaura-product-story__quiz-link"
          >
            {{ quiz_cta }}
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </div>
      {%- endif -%}

    </div>

  </div>
</section>

<style>
  .milaura-product-story {
    padding: 20px 0;
    background: transparent;
    opacity: 0;
    transform: translateY(40px);
    transition: opacity 0.8s ease, transform 0.8s ease;
  }

  .milaura-product-story.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .milaura-product-story__container {
    max-width: 900px;
    text-align: center;
    /* padding handled by milaura-section-card */
  }

  .milaura-product-story__content {
    display: flex;
    flex-direction: column;
    gap: var(--milaura-spacing-md, 24px);
    align-items: center;
  }

  .milaura-product-story__label {
    font-family: {{ section.settings.label_font }};
    font-size: {{ section.settings.label_size_mobile }}px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: {{ section.settings.label_transform }};
    color: {{ section.settings.label_color }};
    margin: 0;
  }

  .milaura-product-story__text {
    font-family: {{ section.settings.text_font }};
    font-size: {{ section.settings.text_size_mobile }}px;
    line-height: 1.8;
    color: {{ section.settings.text_color }};
    font-style: italic;
    opacity: 0.9;
  }

  .milaura-product-story__text p {
    margin: 0 0 1.2em 0;
  }

  .milaura-product-story__text p:last-child {
    margin-bottom: 0;
  }

  .milaura-product-story__quiz {
    margin-top: var(--milaura-spacing-sm, 12px);
  }

  .milaura-product-story__quiz-link {
    display: inline-flex;
    align-items: center;
    gap: var(--milaura-spacing-xs, 6px);
    padding: 12px 24px;
    background: rgba(192, 160, 98, 0.1);
    border: 1px solid rgba(192, 160, 98, 0.3);
    border-radius: 12px;
    font-family: {{ section.settings.quiz_link_font }};
    color: {{ section.settings.quiz_link_color }};
    font-size: {{ section.settings.quiz_link_size_mobile }}px;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .milaura-product-story__quiz-link:hover {
    background: rgba(192, 160, 98, 0.2);
    border-color: var(--milaura-gold, #C0A062);
    transform: translateY(-2px);
  }

  .milaura-product-story__quiz-link svg {
    transition: transform 0.3s ease;
  }

  .milaura-product-story__quiz-link:hover svg {
    transform: translateX(4px);
  }

  /* Desktop */
  @media screen and (min-width: 1024px) {
    .milaura-product-story {
      padding: 20px 0;
    }

    .milaura-product-story__label {
      font-size: {{ section.settings.label_size_desktop }}px;
    }

    .milaura-product-story__text {
      font-size: {{ section.settings.text_size_desktop }}px;
      line-height: 1.9;
    }

    .milaura-product-story__quiz-link {
      font-size: {{ section.settings.quiz_link_size_desktop }}px;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .milaura-product-story {
      transition: none;
    }

    .milaura-product-story__quiz-link,
    .milaura-product-story__quiz-link svg {
      transition: none;
    }
  }
</style>

<script>
(function() {
  const sectionId = '{{ section.id }}';
  const section = document.getElementById('MilauraProductStory-' + sectionId);
  if (!section) return;

  const reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  // Fade-in au scroll
  if (!reducedMotion) {
    const observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
          observer.unobserve(entry.target);
        }
      });
    }, {
      threshold: 0.2
    });

    observer.observe(section);
  } else {
    section.classList.add('is-visible');
  }
})();
</script>

{%- endif -%}

{% schema %}
{
  "name": "Milaura Product Story",
  "class": "milaura-section",
  "settings": [
    {
      "type": "header",
      "content": "üìù Label"
    },
    {
      "type": "checkbox",
      "id": "show_label",
      "label": "Afficher le label",
      "default": true
    },
    {
      "type": "text",
      "id": "label_text",
      "label": "Texte du label",
      "default": "L'histoire"
    },
    {
      "type": "header",
      "content": "üìù Texte par d√©faut"
    },
    {
      "type": "richtext",
      "id": "default_story",
      "label": "Histoire par d√©faut",
      "default": "<p>Chaque creation Milaura nait d'une intention : celle de vous offrir un refuge. Un objet qui vous accompagne, qui vous rappelle que vous meritez de prendre soin de vous.</p><p>Les pierres sont choisies pour leur energie, leur beaute naturelle, leur capacite a apaiser ou a reveiller. Elles ne sont pas magiques. Elles sont authentiques. Comme vous.</p>",
      "info": "Utilis√© si metafield milaura.story_text est vide. Style Aesop : sobre, po√©tique, 3-5 phrases max."
    },
    {
      "type": "header",
      "content": "‚úèÔ∏è Style Label"
    },
    {
      "type": "select",
      "id": "label_font",
      "label": "Typographie du label",
      "options": [
        { "value": "var(--milaura-font-heading)", "label": "Playfair Display" },
        { "value": "var(--milaura-font-body)", "label": "Lato" },
        { "value": "var(--milaura-font-script)", "label": "Dancing Script" }
      ],
      "default": "var(--milaura-font-body)"
    },
    {
      "type": "range",
      "id": "label_size_desktop",
      "label": "Taille label (desktop)",
      "min": 10,
      "max": 28,
      "step": 1,
      "unit": "px",
      "default": 14
    },
    {
      "type": "range",
      "id": "label_size_mobile",
      "label": "Taille label (mobile)",
      "min": 10,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "color",
      "id": "label_color",
      "label": "Couleur du label",
      "default": "#C0A062"
    },
    {
      "type": "select",
      "id": "label_transform",
      "label": "Casse du label",
      "options": [
        { "value": "uppercase", "label": "MAJUSCULES" },
        { "value": "capitalize", "label": "Premi√®re Lettre" },
        { "value": "none", "label": "Normal" }
      ],
      "default": "uppercase"
    },
    {
      "type": "header",
      "content": "‚úèÔ∏è Style Texte"
    },
    {
      "type": "select",
      "id": "text_font",
      "label": "Typographie du texte",
      "options": [
        { "value": "var(--milaura-font-heading)", "label": "Playfair Display" },
        { "value": "var(--milaura-font-body)", "label": "Lato" },
        { "value": "var(--milaura-font-script)", "label": "Dancing Script" }
      ],
      "default": "var(--milaura-font-body)"
    },
    {
      "type": "range",
      "id": "text_size_desktop",
      "label": "Taille texte (desktop)",
      "min": 16,
      "max": 28,
      "step": 1,
      "unit": "px",
      "default": 22
    },
    {
      "type": "range",
      "id": "text_size_mobile",
      "label": "Taille texte (mobile)",
      "min": 14,
      "max": 22,
      "step": 1,
      "unit": "px",
      "default": 17
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Couleur du texte",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "üîó Lien quiz"
    },
    {
      "type": "checkbox",
      "id": "show_quiz_link",
      "label": "Afficher le lien vers le quiz",
      "default": true,
      "info": "Recommand√© si produit li√© √† profil √©motionnel"
    },
    {
      "type": "url",
      "id": "quiz_url",
      "label": "URL du quiz"
    },
    {
      "type": "text",
      "id": "quiz_cta_text",
      "label": "Texte du lien quiz",
      "info": "Laisse vide pour texte automatique selon type produit"
    },
    {
      "type": "header",
      "content": "‚úèÔ∏è Style Lien Quiz"
    },
    {
      "type": "select",
      "id": "quiz_link_font",
      "label": "Typographie lien quiz",
      "options": [
        { "value": "var(--milaura-font-heading)", "label": "Playfair Display" },
        { "value": "var(--milaura-font-body)", "label": "Lato" },
        { "value": "var(--milaura-font-script)", "label": "Dancing Script" }
      ],
      "default": "var(--milaura-font-body)"
    },
    {
      "type": "range",
      "id": "quiz_link_size_desktop",
      "label": "Taille lien quiz (desktop)",
      "min": 13,
      "max": 20,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "range",
      "id": "quiz_link_size_mobile",
      "label": "Taille lien quiz (mobile)",
      "min": 12,
      "max": 18,
      "step": 1,
      "unit": "px",
      "default": 14
    },
    {
      "type": "color",
      "id": "quiz_link_color",
      "label": "Couleur lien quiz",
      "default": "#8F723A"
    }
  ],
  "presets": [
    {
      "name": "Milaura Product Story"
    }
  ]
}
{% endschema %}
