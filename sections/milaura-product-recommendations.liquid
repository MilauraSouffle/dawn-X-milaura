{% comment %}
  Milaura – Recommandations produits
  Logique simple : afficher d'autres produits de la même collection que le produit actuel.
  - Si le produit n'a pas de collection, on ne montre rien.
  - Si la collection n'a qu'un seul produit (celui-ci), on ne montre rien.
{% endcomment %}

{% assign reco_collection = product.collections | first %}

{% if reco_collection and reco_collection.products_count > 1 %}
  {% style %}
    #milaura-recos-{{ section.id }} {
      padding-top: {{ section.settings.padding_top | default: 36 }}px;
      padding-bottom: {{ section.settings.padding_bottom | default: 36 }}px;
    }
  {% endstyle %}

  <section id="milaura-recos-{{ section.id }}" class="milaura-section milaura-recos">
    <div class="page-width">
      {% if section.settings.heading != blank %}
        <h2 class="milaura-section-title">
          {{ section.settings.heading }}
        </h2>
      {% endif %}

      <div class="milaura-recos-grid">
        {% assign max = section.settings.max_products | default: 4 %}
        {% assign shown = 0 %}

        {% for reco_product in reco_collection.products %}
          {% if reco_product.id == product.id %}
            {% continue %}
          {% endif %}

          <a
            href="{{ reco_product.url }}"
            class="milaura-recos-card"
          >
            <div class="milaura-recos-image-wrapper">
              {% if reco_product.featured_media %}
                <img
                  src="{{ reco_product.featured_media | image_url: width: 500 }}"
                  alt="{{ reco_product.featured_media.alt | escape }}"
                  loading="lazy"
                  width="500"
                  height="500"
                  class="milaura-recos-image"
                >
              {% endif %}
            </div>

            <div class="milaura-recos-content">
              <h3 class="milaura-recos-title">
                {{ reco_product.title }}
              </h3>

              {% assign price = reco_product.price %}
              {% assign compare_at = reco_product.compare_at_price %}

              <div class="milaura-recos-price-row">
                <span class="milaura-recos-price">
                  {{ price | money }}
                </span>

                {% if compare_at > price %}
                  <span class="milaura-recos-compare">
                    {{ compare_at | money }}
                  </span>
                  {% assign reduction = 100 | times: price | divided_by: compare_at | round %}
                  <span class="milaura-recos-badge"> -{{ 100 | minus: reduction }}% </span>
                {% endif %}
              </div>

              {% if reco_product.metafields.custom.stone %}
                <div class="milaura-recos-meta">
                  <span class="milaura-recos-meta-label">Pierre :</span>
                  <span class="milaura-recos-meta-value">
                    {{ reco_product.metafields.custom.stone }}
                  </span>
                </div>
              {% endif %}
            </div>
          </a>

          {% assign shown = shown | plus: 1 %}
          {% if shown >= max %}
            {% break %}
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </section>
{% endif %}

{% schema %}
{
  "name": "Milaura recos",
  "tag": "section",
  "class": "milaura-recos-section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Titre",
      "default": "Tu pourrais aussi aimer"
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "Nombre de produits",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Espacement haut",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Espacement bas",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Milaura recos"
    }
  ]
}
{% endschema %}
