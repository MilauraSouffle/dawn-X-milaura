{% comment %}
  MILAURA PRODUCT SCENT - "L'Essence"
  Version 2.0 - Refonte compl√®te

  Design √©motionnel inspir√© Aesop/Diptyque
  - Description po√©tique de la fragrance
  - Notes olfactives en pills (blocks)
  - Suggestion d'usage
  - Image de fond avec overlay fonctionnel
  - Conditionnel : uniquement pour bougies
{% endcomment %}

{%- liquid
  assign product_type = product.type | downcase
  assign is_candle = false

  if product_type == 'bougie'
    assign is_candle = true
  endif

  assign mood_statement = section.settings.mood_statement | default: section.settings.default_mood
  assign usage_suggestion = section.settings.usage_suggestion
  assign note_blocks = section.blocks | where: 'type', 'note'
-%}

{%- if is_candle -%}
<section
  id="MilauraProductScent-{{ section.id }}"
  class="milaura-scent"
  data-section-id="{{ section.id }}"
>
  <div class="milaura-scent__card milaura-section-card{% if section.settings.background_image != blank %} has-bg{% endif %}">

    {%- comment -%} Background Image + Overlay {%- endcomment -%}
    {%- if section.settings.background_image != blank -%}
      {%- comment -%} Force float calculation: multiply by 1.0 first, then divide {%- endcomment -%}
      {%- assign opacity_float = section.settings.overlay_opacity | times: 1.0 -%}
      {%- assign overlay_decimal = opacity_float | divided_by: 100 -%}
      <div class="milaura-scent__bg">
        {{ section.settings.background_image
          | image_url: width: 1200
          | image_tag:
            loading: 'lazy',
            class: 'milaura-scent__bg-img',
            sizes: '(min-width: 768px) 800px, 100vw'
        }}
        <div class="milaura-scent__overlay" style="background: {{ section.settings.overlay_color }}; opacity: {{ overlay_decimal }};"></div>
      </div>
    {%- endif -%}

    {%- comment -%} Content {%- endcomment -%}
    <div class="milaura-scent__content">

      {%- if section.settings.show_title -%}
        <p class="milaura-scent__label">{{ section.settings.title }}</p>
      {%- endif -%}

      {%- if mood_statement != blank -%}
        <div class="milaura-scent__mood">
          {{ mood_statement }}
        </div>
      {%- endif -%}

      {%- if note_blocks.size > 0 -%}
        <div class="milaura-scent__notes">
          {%- for block in note_blocks -%}
            <span class="milaura-scent__note" {{ block.shopify_attributes }}>
              {{ block.settings.note_text }}
            </span>
          {%- endfor -%}
        </div>
      {%- endif -%}

      {%- if usage_suggestion != blank -%}
        <p class="milaura-scent__usage">
          <span class="milaura-scent__usage-icon">&#10022;</span>
          {{ usage_suggestion }}
        </p>
      {%- endif -%}

      {%- if section.settings.show_partner and section.settings.partner_logo != blank -%}
        <div class="milaura-scent__partner">
          {{ section.settings.partner_logo
            | image_url: width: 160
            | image_tag:
              loading: 'lazy',
              class: 'milaura-scent__partner-logo',
              alt: section.settings.partner_text | escape
          }}
        </div>
      {%- endif -%}

    </div>

  </div>
</section>
{%- endif -%}

<style>
  /* ============================================
     L'ESSENCE - Base Styles
     ============================================ */
  .milaura-scent {
    padding: 20px 0;
    background: transparent;
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.8s ease, transform 0.8s ease;
  }

  .milaura-scent.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .milaura-scent__card {
    position: relative;
    max-width: 800px;
    overflow: hidden;
    text-align: center;
  }

  /* ============================================
     Background Image + Overlay
     ============================================ */
  .milaura-scent__bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
  }

  .milaura-scent__bg-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    filter: blur({{ section.settings.image_blur }}px);
  }

  .milaura-scent__overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    /* background et opacity g√©r√©s via inline style pour fiabilit√© */
  }

  /* ============================================
     Content Layer
     ============================================ */
  .milaura-scent__content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    padding: 40px 24px;
  }

  /* Label / Titre */
  .milaura-scent__label {
    font-family: var(--milaura-font-body, 'Lato', sans-serif);
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--milaura-gold, #C0A062);
    margin: 0;
  }

  /* Mood Statement */
  .milaura-scent__mood {
    font-family: var(--milaura-font-heading, 'Playfair Display', serif);
    font-size: 20px;
    font-style: italic;
    line-height: 1.6;
    color: {{ section.settings.text_color }};
    max-width: 580px;
    margin: 0;
  }

  .milaura-scent__mood p {
    margin: 0;
  }

  /* Note Pills */
  .milaura-scent__notes {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin-top: 8px;
  }

  .milaura-scent__note {
    display: inline-block;
    padding: 8px 20px;
    background: rgba(192, 160, 98, 0.1);
    border: 1px solid rgba(192, 160, 98, 0.35);
    border-radius: 50px;
    font-family: var(--milaura-font-body, 'Lato', sans-serif);
    font-size: 13px;
    font-weight: 500;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: var(--milaura-gold-dark, #8F723A);
    transition: all 0.3s ease;
  }

  .milaura-scent__note:hover {
    background: rgba(192, 160, 98, 0.2);
    border-color: var(--milaura-gold, #C0A062);
    transform: translateY(-2px);
  }

  /* Usage Suggestion */
  .milaura-scent__usage {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: var(--milaura-font-body, 'Lato', sans-serif);
    font-size: 14px;
    color: {{ section.settings.text_color }};
    opacity: 0.7;
    margin: 8px 0 0 0;
  }

  .milaura-scent__usage-icon {
    color: var(--milaura-gold, #C0A062);
    font-size: 10px;
  }

  /* Partner Logo */
  .milaura-scent__partner {
    margin-top: 16px;
    opacity: 0.5;
    transition: opacity 0.3s ease;
  }

  .milaura-scent__partner:hover {
    opacity: 0.8;
  }

  .milaura-scent__partner-logo {
    max-width: 100px;
    height: auto;
  }

  /* ============================================
     Desktop (768px+)
     ============================================ */
  @media screen and (min-width: 768px) {
    .milaura-scent__content {
      padding: 56px 48px;
      gap: 24px;
    }

    .milaura-scent__label {
      font-size: 13px;
      letter-spacing: 0.2em;
    }

    .milaura-scent__mood {
      font-size: 26px;
      line-height: 1.7;
    }

    .milaura-scent__notes {
      gap: 12px;
      margin-top: 12px;
    }

    .milaura-scent__note {
      padding: 10px 24px;
      font-size: 13px;
    }

    .milaura-scent__usage {
      font-size: 15px;
      margin-top: 12px;
    }

    .milaura-scent__partner-logo {
      max-width: 120px;
    }
  }

  /* ============================================
     Large Desktop (1024px+)
     ============================================ */
  @media screen and (min-width: 1024px) {
    .milaura-scent__content {
      padding: 64px 64px;
    }

    .milaura-scent__mood {
      font-size: 28px;
    }
  }

  /* ============================================
     Small Mobile (< 380px)
     ============================================ */
  @media screen and (max-width: 379px) {
    .milaura-scent__content {
      padding: 32px 16px;
      gap: 16px;
    }

    .milaura-scent__label {
      font-size: 11px;
    }

    .milaura-scent__mood {
      font-size: 18px;
    }

    .milaura-scent__notes {
      gap: 8px;
    }

    .milaura-scent__note {
      padding: 6px 14px;
      font-size: 11px;
    }

    .milaura-scent__usage {
      font-size: 13px;
    }
  }

  /* ============================================
     Reduced Motion
     ============================================ */
  @media (prefers-reduced-motion: reduce) {
    .milaura-scent {
      transition: none;
      opacity: 1;
      transform: none;
    }

    .milaura-scent__note {
      transition: none;
    }
  }
</style>

<script>
(function() {
  const sectionId = '{{ section.id }}';
  const section = document.getElementById('MilauraProductScent-' + sectionId);
  if (!section) return;

  const reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  if (!reducedMotion) {
    const observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.2 });

    observer.observe(section);
  } else {
    section.classList.add('is-visible');
  }
})();
</script>

{% schema %}
{
  "name": "L'Essence (Senteur)",
  "class": "milaura-section",
  "settings": [
    {
      "type": "header",
      "content": "üñºÔ∏è Image de fond"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Image de fond",
      "info": "Image atmosph√©rique pour l'ambiance (optionnel)"
    },
    {
      "type": "color",
      "id": "overlay_color",
      "label": "Couleur de l'overlay",
      "default": "#FFFFFF"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "label": "Opacit√© overlay",
      "min": 0,
      "max": 95,
      "step": 5,
      "default": 75,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "image_blur",
      "label": "Flou de l'image",
      "min": 0,
      "max": 10,
      "step": 1,
      "default": 2,
      "unit": "px",
      "info": "L√©ger flou pour plus de douceur"
    },
    {
      "type": "header",
      "content": "üìù Contenu"
    },
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Afficher le label",
      "default": true
    },
    {
      "type": "text",
      "id": "title",
      "label": "Label",
      "default": "L'Essence"
    },
    {
      "type": "richtext",
      "id": "mood_statement",
      "label": "Description √©motionnelle",
      "default": "<p>Une fragrance enveloppante qui transforme ton espace en un havre de paix. Laisse-toi porter par ses notes d√©licates.</p>",
      "info": "1-2 phrases po√©tiques d√©crivant l'exp√©rience olfactive"
    },
    {
      "type": "text",
      "id": "usage_suggestion",
      "label": "Suggestion d'usage",
      "default": "Parfait pour tes rituels du soir",
      "info": "Quand utiliser cette bougie ? (optionnel)"
    },
    {
      "type": "header",
      "content": "üé® Style"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Couleur du texte",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "ü§ù Partenaire"
    },
    {
      "type": "checkbox",
      "id": "show_partner",
      "label": "Afficher le logo partenaire",
      "default": false
    },
    {
      "type": "image_picker",
      "id": "partner_logo",
      "label": "Logo partenaire"
    },
    {
      "type": "text",
      "id": "partner_text",
      "label": "Texte alternatif",
      "default": "Maison Candella"
    }
  ],
  "blocks": [
    {
      "type": "note",
      "name": "Note olfactive",
      "settings": [
        {
          "type": "text",
          "id": "note_text",
          "label": "Ingr√©dient",
          "default": "N√©roli",
          "info": "Ex: Vanille, Bois de santal, Fleur d'oranger..."
        }
      ]
    }
  ],
  "max_blocks": 4,
  "presets": [
    {
      "name": "L'Essence (Senteur)",
      "blocks": [
        { "type": "note", "settings": { "note_text": "N√©roli" } },
        { "type": "note", "settings": { "note_text": "Vanille" } },
        { "type": "note", "settings": { "note_text": "Musc blanc" } }
      ]
    }
  ]
}
{% endschema %}
