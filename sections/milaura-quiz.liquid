{% style %}
  /* ============================================
     MILAURA QUIZ - DIAGNOSTIC ÉMOTIONNEL
     ============================================ */

  #MilauraQuiz-{{ section.id }} {
    width: 100%;
    padding: var(--milaura-spacing-xl) var(--milaura-spacing-sm);
    background: transparent;
    min-height: 600px;
  }

  /* --- CONTENEUR PRINCIPAL --- */
  #MilauraQuiz-{{ section.id }} .quiz-container {
    max-width: 1000px;
    margin: 0 auto;
    position: relative;
  }

  /* --- ÉTAT : INTRO --- */
  #MilauraQuiz-{{ section.id }} .quiz-state {
    display: none;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.5s ease, transform 0.5s ease;
  }

  #MilauraQuiz-{{ section.id }} .quiz-state.is-active {
    display: block;
    opacity: 1;
    transform: translateY(0);
  }

  #MilauraQuiz-{{ section.id }} .quiz-intro-card {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(25px) saturate(180%);
    -webkit-backdrop-filter: blur(25px) saturate(180%);
    border: 2px solid var(--milaura-gold);
    border-radius: var(--milaura-border-radius);
    padding: var(--milaura-spacing-lg);
    box-shadow: var(--milaura-shadow-lg);
    text-align: center;
  }

  #MilauraQuiz-{{ section.id }} .quiz-intro-title {
    font-family: var(--milaura-font-heading);
    color: var(--milaura-gold);
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: var(--milaura-spacing-md);
    line-height: 1.2;
  }

  #MilauraQuiz-{{ section.id }} .quiz-intro-subtitle {
    font-family: var(--milaura-font-body);
    color: var(--milaura-text);
    font-size: 1.1rem;
    line-height: 1.6;
    margin-bottom: var(--milaura-spacing-lg);
  }

  #MilauraQuiz-{{ section.id }} .quiz-expert-block {
    background: rgba(255, 255, 255, 0.6);
    border-radius: var(--milaura-border-radius-sm);
    padding: var(--milaura-spacing-md);
    margin: var(--milaura-spacing-lg) 0;
    display: flex;
    align-items: center;
    gap: var(--milaura-spacing-md);
    text-align: left;
  }

  #MilauraQuiz-{{ section.id }} .quiz-expert-image {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--milaura-gold);
    flex-shrink: 0;
  }

  #MilauraQuiz-{{ section.id }} .quiz-expert-info {
    flex: 1;
  }

  #MilauraQuiz-{{ section.id }} .quiz-expert-name {
    font-family: var(--milaura-font-heading);
    color: var(--milaura-text);
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 5px;
  }

  #MilauraQuiz-{{ section.id }} .quiz-expert-title {
    font-family: var(--milaura-font-body);
    color: var(--milaura-gold);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
  }

  #MilauraQuiz-{{ section.id }} .quiz-expert-text {
    font-family: var(--milaura-font-body);
    color: var(--milaura-text-light);
    font-size: 0.95rem;
    line-height: 1.5;
  }

  /* --- ÉTAT : QUESTIONS --- */
  #MilauraQuiz-{{ section.id }} .quiz-questions-header {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(20px);
    border-radius: var(--milaura-border-radius);
    padding: var(--milaura-spacing-md);
    margin-bottom: var(--milaura-spacing-lg);
    text-align: center;
    border: 1px solid rgba(192, 160, 98, 0.3);
  }

  #MilauraQuiz-{{ section.id }} .quiz-progress-text {
    font-family: var(--milaura-font-body);
    color: var(--milaura-text);
    font-size: 0.9rem;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  #MilauraQuiz-{{ section.id }} .quiz-progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(192, 160, 98, 0.2);
    border-radius: 10px;
    overflow: hidden;
    position: relative;
  }

  #MilauraQuiz-{{ section.id }} .quiz-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--milaura-gold) 0%, var(--milaura-gold-light) 100%);
    border-radius: 10px;
    transition: width 0.4s ease;
    box-shadow: 0 2px 10px rgba(192, 160, 98, 0.4);
  }

  #MilauraQuiz-{{ section.id }} .quiz-question-card {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(25px);
    border: 2px solid var(--milaura-gold);
    border-radius: var(--milaura-border-radius);
    padding: var(--milaura-spacing-lg);
    box-shadow: var(--milaura-shadow-lg);
  }

  #MilauraQuiz-{{ section.id }} .quiz-question-title {
    font-family: var(--milaura-font-heading);
    color: var(--milaura-text);
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: var(--milaura-spacing-md);
    text-align: center;
    line-height: 1.3;
  }

  #MilauraQuiz-{{ section.id }} .quiz-answers {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--milaura-spacing-md);
    margin-top: var(--milaura-spacing-lg);
  }

  #MilauraQuiz-{{ section.id }} .quiz-answer-btn {
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid rgba(192, 160, 98, 0.4);
    border-radius: var(--milaura-border-radius-sm);
    padding: var(--milaura-spacing-md);
    font-family: var(--milaura-font-body);
    color: var(--milaura-text);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #MilauraQuiz-{{ section.id }} .quiz-answer-btn:hover {
    background: rgba(255, 255, 255, 1);
    border-color: var(--milaura-gold);
    transform: translateY(-3px);
    box-shadow: var(--milaura-shadow-md);
  }

  #MilauraQuiz-{{ section.id }} .quiz-answer-btn:active {
    transform: translateY(0);
  }

  /* --- ÉTAT : TRANSITION --- */
  #MilauraQuiz-{{ section.id }} .quiz-transition-card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(30px);
    border: 2px solid var(--milaura-gold);
    border-radius: var(--milaura-border-radius);
    padding: var(--milaura-spacing-xl);
    box-shadow: var(--milaura-shadow-lg);
    text-align: center;
    min-height: 400px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  #MilauraQuiz-{{ section.id }} .quiz-transition-title {
    font-family: var(--milaura-font-heading);
    color: var(--milaura-gold);
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: var(--milaura-spacing-md);
    line-height: 1.3;
  }

  #MilauraQuiz-{{ section.id }} .quiz-transition-subtitle {
    font-family: var(--milaura-font-script);
    color: var(--milaura-text);
    font-size: 1.5rem;
    margin-bottom: var(--milaura-spacing-lg);
  }

  #MilauraQuiz-{{ section.id }} .quiz-transition-body {
    font-family: var(--milaura-font-body);
    color: var(--milaura-text);
    font-size: 1.1rem;
    line-height: 1.7;
    max-width: 600px;
    margin: 0 auto;
  }

  #MilauraQuiz-{{ section.id }} .quiz-loader {
    display: flex;
    gap: 10px;
    margin-top: var(--milaura-spacing-lg);
    justify-content: center;
  }

  #MilauraQuiz-{{ section.id }} .quiz-loader-dot {
    width: 12px;
    height: 12px;
    background: var(--milaura-gold);
    border-radius: 50%;
    animation: pulse 1.4s ease-in-out infinite;
  }

  #MilauraQuiz-{{ section.id }} .quiz-loader-dot:nth-child(2) {
    animation-delay: 0.2s;
  }

  #MilauraQuiz-{{ section.id }} .quiz-loader-dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 0.3;
      transform: scale(1);
    }
    50% {
      opacity: 1;
      transform: scale(1.2);
    }
  }

  /* --- ÉTAT : RESULT --- */
  #MilauraQuiz-{{ section.id }} .quiz-result-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--milaura-spacing-lg);
  }

  #MilauraQuiz-{{ section.id }} .quiz-result-card {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(25px);
    border: 2px solid var(--milaura-gold);
    border-radius: var(--milaura-border-radius);
    padding: var(--milaura-spacing-lg);
    box-shadow: var(--milaura-shadow-lg);
  }

  #MilauraQuiz-{{ section.id }} .quiz-result-title {
    font-family: var(--milaura-font-heading);
    color: var(--milaura-gold);
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: var(--milaura-spacing-md);
  }

  #MilauraQuiz-{{ section.id }} .quiz-result-profile-label {
    font-family: var(--milaura-font-heading);
    color: var(--milaura-text);
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 10px;
  }

  #MilauraQuiz-{{ section.id }} .quiz-result-profile-desc {
    font-family: var(--milaura-font-body);
    color: var(--milaura-text);
    font-size: 1rem;
    line-height: 1.6;
    margin-bottom: var(--milaura-spacing-md);
  }

  #MilauraQuiz-{{ section.id }} .quiz-result-product-image {
    width: 100%;
    border-radius: var(--milaura-border-radius-sm);
    margin-bottom: var(--milaura-spacing-md);
    border: 1px solid rgba(192, 160, 98, 0.3);
  }

  #MilauraQuiz-{{ section.id }} .quiz-result-product-price {
    font-family: var(--milaura-font-heading);
    color: var(--milaura-gold);
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: var(--milaura-spacing-md);
  }

  #MilauraQuiz-{{ section.id }} .quiz-result-bullets {
    font-family: var(--milaura-font-body);
    color: var(--milaura-text);
    font-size: 0.95rem;
    line-height: 1.8;
    margin-bottom: var(--milaura-spacing-md);
  }

  #MilauraQuiz-{{ section.id }} .quiz-result-bullets ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  #MilauraQuiz-{{ section.id }} .quiz-result-bullets li {
    padding-left: 25px;
    position: relative;
    margin-bottom: 8px;
  }

  #MilauraQuiz-{{ section.id }} .quiz-result-bullets li::before {
    content: '✨';
    position: absolute;
    left: 0;
  }

  #MilauraQuiz-{{ section.id }} .quiz-result-mantra {
    font-family: var(--milaura-font-script);
    color: var(--milaura-gold);
    font-size: 1.3rem;
    font-style: italic;
    text-align: center;
    margin: var(--milaura-spacing-md) 0;
    padding: var(--milaura-spacing-md);
    background: rgba(192, 160, 98, 0.1);
    border-radius: var(--milaura-border-radius-sm);
  }

  #MilauraQuiz-{{ section.id }} .quiz-result-buttons {
    display: flex;
    flex-direction: column;
    gap: var(--milaura-spacing-sm);
    margin-top: var(--milaura-spacing-md);
  }

  #MilauraQuiz-{{ section.id }} .quiz-mood-title {
    font-family: var(--milaura-font-heading);
    color: var(--milaura-gold);
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: var(--milaura-spacing-md);
  }

  #MilauraQuiz-{{ section.id }} .quiz-mood-gauge {
    margin-bottom: var(--milaura-spacing-md);
  }

  #MilauraQuiz-{{ section.id }} .quiz-mood-gauge-label {
    font-family: var(--milaura-font-body);
    color: var(--milaura-text);
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #MilauraQuiz-{{ section.id }} .quiz-mood-gauge-bar {
    width: 100%;
    height: 12px;
    background: rgba(192, 160, 98, 0.15);
    border-radius: 10px;
    overflow: hidden;
    position: relative;
  }

  #MilauraQuiz-{{ section.id }} .quiz-mood-gauge-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.6s ease;
    box-shadow: 0 2px 8px rgba(192, 160, 98, 0.3);
  }

  #MilauraQuiz-{{ section.id }} .quiz-mood-gauge-fill.is-winner {
    background: linear-gradient(90deg, var(--milaura-gold) 0%, var(--milaura-gold-light) 100%);
  }

  #MilauraQuiz-{{ section.id }} .quiz-mood-gauge-fill:not(.is-winner) {
    background: linear-gradient(90deg, rgba(192, 160, 98, 0.4) 0%, rgba(192, 160, 98, 0.2) 100%);
  }

  /* --- LIEN DERNIÈRE RÉVÉLATION --- */
  #MilauraQuiz-{{ section.id }} .quiz-last-result-link {
    text-align: center;
    margin-bottom: var(--milaura-spacing-md);
  }

  #MilauraQuiz-{{ section.id }} .quiz-last-result-link a {
    font-family: var(--milaura-font-body);
    color: var(--milaura-gold);
    text-decoration: none;
    font-size: 0.95rem;
    font-weight: 600;
    text-decoration: underline;
    transition: color 0.3s ease;
  }

  #MilauraQuiz-{{ section.id }} .quiz-last-result-link a:hover {
    color: var(--milaura-gold-dark);
  }

  /* --- MOBILE --- */
  @media screen and (max-width: 990px) {
    #MilauraQuiz-{{ section.id }} {
      padding: var(--milaura-spacing-md) var(--milaura-spacing-xs);
    }

    #MilauraQuiz-{{ section.id }} .quiz-intro-title {
      font-size: 2rem;
    }

    #MilauraQuiz-{{ section.id }} .quiz-expert-block {
      flex-direction: column;
      text-align: center;
    }

    #MilauraQuiz-{{ section.id }} .quiz-answers {
      grid-template-columns: 1fr;
    }

    #MilauraQuiz-{{ section.id }} .quiz-result-layout {
      grid-template-columns: 1fr;
    }

    #MilauraQuiz-{{ section.id }} .quiz-transition-title {
      font-size: 1.8rem;
    }

    #MilauraQuiz-{{ section.id }} .quiz-transition-subtitle {
      font-size: 1.3rem;
    }
  }

  @media screen and (max-width: 480px) {
    #MilauraQuiz-{{ section.id }} .quiz-intro-title {
      font-size: 1.75rem;
    }

    #MilauraQuiz-{{ section.id }} .quiz-question-title {
      font-size: 1.5rem;
    }

    #MilauraQuiz-{{ section.id }} .quiz-transition-title {
      font-size: 1.6rem;
    }

    #MilauraQuiz-{{ section.id }} .quiz-result-title,
    #MilauraQuiz-{{ section.id }} .quiz-mood-title {
      font-size: 1.5rem;
    }
  }
{% endstyle %}

<div id="MilauraQuiz-{{ section.id }}">
  <div class="quiz-container">
    <!-- Lien dernière révélation (si existe) -->
    <div class="quiz-last-result-link" id="quiz-last-result-link-{{ section.id }}" style="display: none;">
      <a href="#" id="quiz-show-last-{{ section.id }}">Revoir ma dernière révélation ✨</a>
    </div>

    <!-- ÉTAT 1 : INTRO -->
    <div class="quiz-state quiz-state-intro" data-state="intro">
      <div class="quiz-intro-card">
        {% if section.settings.intro_title != blank %}
          <h2 class="quiz-intro-title milaura-heading">{{ section.settings.intro_title }}</h2>
        {% endif %}

        {% if section.settings.intro_subtitle != blank %}
          <div class="quiz-intro-subtitle milaura-text">{{ section.settings.intro_subtitle }}</div>
        {% endif %}

        {% if section.settings.show_expert and section.settings.expert_image != blank %}
          <div class="quiz-expert-block">
            <img
              src="{{ section.settings.expert_image | image_url: width: 200 }}"
              alt="{{ section.settings.expert_name }}"
              class="quiz-expert-image"
            >
            <div class="quiz-expert-info">
              {% if section.settings.expert_name != blank %}
                <div class="quiz-expert-name">{{ section.settings.expert_name }}</div>
              {% endif %}
              {% if section.settings.expert_title != blank %}
                <div class="quiz-expert-title">{{ section.settings.expert_title }}</div>
              {% endif %}
              {% if section.settings.expert_text != blank %}
                <div class="quiz-expert-text milaura-text">{{ section.settings.expert_text }}</div>
              {% endif %}
            </div>
          </div>
        {% endif %}

        {% if section.settings.intro_button_label != blank %}
          <button
            type="button"
            class="milaura-btn milaura-btn-primary"
            id="quiz-start-btn-{{ section.id }}"
          >
            {{ section.settings.intro_button_label }}
          </button>
        {% endif %}
      </div>
    </div>

    <!-- ÉTAT 2 : QUESTIONS -->
    <div class="quiz-state quiz-state-questions" data-state="questions" style="display: none;">
      <div class="quiz-questions-header">
        <div class="quiz-progress-text" id="quiz-progress-text-{{ section.id }}">Question 1 sur 7</div>
        <div class="quiz-progress-bar">
          <div class="quiz-progress-fill" id="quiz-progress-fill-{{ section.id }}" style="width: 14.28%;"></div>
        </div>
      </div>

      <div class="quiz-question-card">
        <h3 class="quiz-question-title" id="quiz-question-title-{{ section.id }}"></h3>
        <div class="quiz-answers" id="quiz-answers-{{ section.id }}"></div>
      </div>
    </div>

    <!-- ÉTAT 3 : TRANSITION -->
    <div class="quiz-state quiz-state-transition" data-state="transition" style="display: none;">
      <div class="quiz-transition-card">
        {% if section.settings.transition_title != blank %}
          <h2 class="quiz-transition-title milaura-heading">{{ section.settings.transition_title }}</h2>
        {% endif %}

        {% if section.settings.transition_subtitle != blank %}
          <div class="quiz-transition-subtitle milaura-heading-script">{{ section.settings.transition_subtitle }}</div>
        {% endif %}

        {% if section.settings.transition_body != blank %}
          <div class="quiz-transition-body milaura-text">{{ section.settings.transition_body }}</div>
        {% endif %}

        <div class="quiz-loader">
          <div class="quiz-loader-dot"></div>
          <div class="quiz-loader-dot"></div>
          <div class="quiz-loader-dot"></div>
        </div>
      </div>
    </div>

    <!-- ÉTAT 4 : RESULT -->
    <div class="quiz-state quiz-state-result" data-state="result" style="display: none;">
      <div class="quiz-result-layout">
        <!-- Colonne gauche : Bougie du moment -->
        <div class="quiz-result-card">
          <h3 class="quiz-result-title" id="quiz-result-main-title-{{ section.id }}"></h3>
          <div class="quiz-result-profile-label" id="quiz-result-profile-label-{{ section.id }}"></div>
          <div class="quiz-result-profile-desc milaura-text" id="quiz-result-profile-desc-{{ section.id }}"></div>
          <div id="quiz-result-product-{{ section.id }}"></div>
          <div class="quiz-result-bullets milaura-text" id="quiz-result-bullets-{{ section.id }}"></div>
          <div class="quiz-result-mantra" id="quiz-result-mantra-{{ section.id }}"></div>
          <div class="quiz-result-buttons" id="quiz-result-buttons-{{ section.id }}"></div>
        </div>

        <!-- Colonne droite : Météo émotionnelle -->
        <div class="quiz-result-card">
          <h3 class="quiz-mood-title" id="quiz-mood-title-{{ section.id }}"></h3>
          <div id="quiz-mood-gauges-{{ section.id }}"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const sectionId = '{{ section.id }}';
    const container = document.querySelector('#MilauraQuiz-' + sectionId);
    if (!container) return;

    // ============================================
    // STATE MACHINE
    // ============================================
    const QuizState = {
      INTRO: 'intro',
      QUESTIONS: 'questions',
      TRANSITION: 'transition',
      RESULT: 'result'
    };

    let currentState = QuizState.INTRO;
    let currentQuestionIndex = 0;
    let scores = {
      reconfort: 0,
      protection: 0,
      serenite: 0,
      elegance: 0,
      joie: 0
    };

    // Profils disponibles (fixes dans le JS)
    const profiles = ['reconfort', 'protection', 'serenite', 'elegance', 'joie'];

    // Données des profils depuis Liquid
    const profileData = {
      reconfort: {
        label: {{ section.settings.profile_comfort_label | json }},
        description: {{ section.settings.profile_comfort_description | json }},
        bullets: {{ section.settings.profile_comfort_bullets | json }},
        mantra: {{ section.settings.profile_comfort_mantra | json }},
        product: {% if section.settings.profile_comfort_product %}{
          title: {{ section.settings.profile_comfort_product.title | json }},
          url: {{ section.settings.profile_comfort_product.url | json }},
          price: {{ section.settings.profile_comfort_product.price | money | json }},
          featured_image: {% if section.settings.profile_comfort_product.featured_image %}{{ section.settings.profile_comfort_product.featured_image | image_url: width: 600 | json }}{% else %}null{% endif %},
          handle: {{ section.settings.profile_comfort_product.handle | json }},
          variant_id: {% if section.settings.profile_comfort_product.selected_or_first_available_variant %}{{ section.settings.profile_comfort_product.selected_or_first_available_variant.id | json }}{% else %}null{% endif %}
        }{% else %}null{% endif %}
      },
      protection: {
        label: {{ section.settings.profile_protection_label | json }},
        description: {{ section.settings.profile_protection_description | json }},
        bullets: {{ section.settings.profile_protection_bullets | json }},
        mantra: {{ section.settings.profile_protection_mantra | json }},
        product: {% if section.settings.profile_protection_product %}{
          title: {{ section.settings.profile_protection_product.title | json }},
          url: {{ section.settings.profile_protection_product.url | json }},
          price: {{ section.settings.profile_protection_product.price | money | json }},
          featured_image: {% if section.settings.profile_protection_product.featured_image %}{{ section.settings.profile_protection_product.featured_image | image_url: width: 600 | json }}{% else %}null{% endif %},
          handle: {{ section.settings.profile_protection_product.handle | json }},
          variant_id: {% if section.settings.profile_protection_product.selected_or_first_available_variant %}{{ section.settings.profile_protection_product.selected_or_first_available_variant.id | json }}{% else %}null{% endif %}
        }{% else %}null{% endif %}
      },
      serenite: {
        label: {{ section.settings.profile_serenity_label | json }},
        description: {{ section.settings.profile_serenity_description | json }},
        bullets: {{ section.settings.profile_serenity_bullets | json }},
        mantra: {{ section.settings.profile_serenity_mantra | json }},
        product: {% if section.settings.profile_serenity_product %}{
          title: {{ section.settings.profile_serenity_product.title | json }},
          url: {{ section.settings.profile_serenity_product.url | json }},
          price: {{ section.settings.profile_serenity_product.price | money | json }},
          featured_image: {% if section.settings.profile_serenity_product.featured_image %}{{ section.settings.profile_serenity_product.featured_image | image_url: width: 600 | json }}{% else %}null{% endif %},
          handle: {{ section.settings.profile_serenity_product.handle | json }},
          variant_id: {% if section.settings.profile_serenity_product.selected_or_first_available_variant %}{{ section.settings.profile_serenity_product.selected_or_first_available_variant.id | json }}{% else %}null{% endif %}
        }{% else %}null{% endif %}
      },
      elegance: {
        label: {{ section.settings.profile_elegance_label | json }},
        description: {{ section.settings.profile_elegance_description | json }},
        bullets: {{ section.settings.profile_elegance_bullets | json }},
        mantra: {{ section.settings.profile_elegance_mantra | json }},
        product: {% if section.settings.profile_elegance_product %}{
          title: {{ section.settings.profile_elegance_product.title | json }},
          url: {{ section.settings.profile_elegance_product.url | json }},
          price: {{ section.settings.profile_elegance_product.price | money | json }},
          featured_image: {% if section.settings.profile_elegance_product.featured_image %}{{ section.settings.profile_elegance_product.featured_image | image_url: width: 600 | json }}{% else %}null{% endif %},
          handle: {{ section.settings.profile_elegance_product.handle | json }},
          variant_id: {% if section.settings.profile_elegance_product.selected_or_first_available_variant %}{{ section.settings.profile_elegance_product.selected_or_first_available_variant.id | json }}{% else %}null{% endif %}
        }{% else %}null{% endif %}
      },
      joie: {
        label: {{ section.settings.profile_joy_label | json }},
        description: {{ section.settings.profile_joy_description | json }},
        bullets: {{ section.settings.profile_joy_bullets | json }},
        mantra: {{ section.settings.profile_joy_mantra | json }},
        product: {% if section.settings.profile_joy_product %}{
          title: {{ section.settings.profile_joy_product.title | json }},
          url: {{ section.settings.profile_joy_product.url | json }},
          price: {{ section.settings.profile_joy_product.price | money | json }},
          featured_image: {% if section.settings.profile_joy_product.featured_image %}{{ section.settings.profile_joy_product.featured_image | image_url: width: 600 | json }}{% else %}null{% endif %},
          handle: {{ section.settings.profile_joy_product.handle | json }},
          variant_id: {% if section.settings.profile_joy_product.selected_or_first_available_variant %}{{ section.settings.profile_joy_product.selected_or_first_available_variant.id | json }}{% else %}null{% endif %}
        }{% else %}null{% endif %}
      }
    };

    // Récupérer les questions depuis les blocks Liquid
    const questionsData = [];
    {% for block in section.blocks %}
      {% if block.type == 'question' %}
        questionsData.push({
          id: '{{ block.id }}',
          label: {{ block.settings.question_label | json }},
          answers: [
            {% if block.settings.answer_1_label != blank %}
              { label: {{ block.settings.answer_1_label | json }}, profile: {{ block.settings.answer_1_profile | json }} },
            {% endif %}
            {% if block.settings.answer_2_label != blank %}
              { label: {{ block.settings.answer_2_label | json }}, profile: {{ block.settings.answer_2_profile | json }} },
            {% endif %}
            {% if block.settings.answer_3_label != blank %}
              { label: {{ block.settings.answer_3_label | json }}, profile: {{ block.settings.answer_3_profile | json }} },
            {% endif %}
            {% if block.settings.answer_4_label != blank %}
              { label: {{ block.settings.answer_4_label | json }}, profile: {{ block.settings.answer_4_profile | json }} }
            {% endif %}
          ]
        });
      {% endif %}
    {% endfor %}

    // ============================================
    // FONCTIONS DE NAVIGATION
    // ============================================
    function goToState(state) {
      const states = container.querySelectorAll('.quiz-state');
      states.forEach(s => {
        s.classList.remove('is-active');
        s.style.display = 'none';
      });

      const targetState = container.querySelector(`.quiz-state-${state}`);
      if (targetState) {
        targetState.style.display = 'block';
        setTimeout(() => {
          targetState.classList.add('is-active');
        }, 10);
      }

      currentState = state;
    }

    function goToIntro() {
      goToState(QuizState.INTRO);
    }

    function goToQuestions() {
      currentQuestionIndex = 0;
      scores = {
        reconfort: 0,
        protection: 0,
        serenite: 0,
        elegance: 0,
        joie: 0
      };
      goToState(QuizState.QUESTIONS);
      displayQuestion(0);
    }

    function goToTransition() {
      goToState(QuizState.TRANSITION);
      const duration = {{ section.settings.transition_duration_ms | default: 3000 }};
      setTimeout(() => {
        goToResult();
      }, duration);
    }

    function goToResult() {
      calculateResults();
      displayResults();
      goToState(QuizState.RESULT);
    }

    // ============================================
    // LOGIQUE DES QUESTIONS
    // ============================================
    function displayQuestion(index) {
      if (index >= questionsData.length) {
        goToTransition();
        return;
      }

      const question = questionsData[index];
      const questionTitleEl = container.querySelector('#quiz-question-title-' + sectionId);
      const answersEl = container.querySelector('#quiz-answers-' + sectionId);
      const progressTextEl = container.querySelector('#quiz-progress-text-' + sectionId);
      const progressFillEl = container.querySelector('#quiz-progress-fill-' + sectionId);

      if (questionTitleEl) {
        questionTitleEl.textContent = question.label;
      }

      if (progressTextEl) {
        progressTextEl.textContent = `Question ${index + 1} sur ${questionsData.length}`;
      }

      if (progressFillEl) {
        const progress = ((index + 1) / questionsData.length) * 100;
        progressFillEl.style.width = progress + '%';
      }

      if (answersEl) {
        answersEl.innerHTML = '';
        question.answers.forEach((answer, i) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'quiz-answer-btn';
          btn.textContent = answer.label;
          btn.addEventListener('click', () => {
            handleAnswer(answer.profile);
          });
          answersEl.appendChild(btn);
        });
      }
    }

    function handleAnswer(profile) {
      if (profiles.includes(profile)) {
        scores[profile] = (scores[profile] || 0) + 1;
      }

      currentQuestionIndex++;
      displayQuestion(currentQuestionIndex);
    }

    // ============================================
    // CALCUL DES RÉSULTATS
    // ============================================
    function calculateResults() {
      const totalScore = Object.values(scores).reduce((sum, val) => sum + val, 0);
      const percentages = {};
      let winnerProfile = null;
      let maxScore = -1;

      profiles.forEach(profile => {
        const score = scores[profile] || 0;
        percentages[profile] = totalScore > 0 ? Math.round((score / totalScore) * 100) : 0;
        if (score > maxScore) {
          maxScore = score;
          winnerProfile = profile;
        }
      });

      return {
        winnerProfile: winnerProfile,
        scores: scores,
        percentages: percentages,
        totalScore: totalScore
      };
    }

    // ============================================
    // AFFICHAGE DES RÉSULTATS
    // ============================================
    function displayResults() {
      const results = calculateResults();
      const winnerProfile = results.winnerProfile;

      const profile = profileData[winnerProfile];
      if (!profile) return;

      // Titre principal
      const mainTitleEl = container.querySelector('#quiz-result-main-title-' + sectionId);
      if (mainTitleEl) {
        const mainTitle = {{ section.settings.result_main_title | json }};
        mainTitleEl.textContent = mainTitle || 'Ta bougie du moment';
      }

      // Label et description du profil
      const profileLabelEl = container.querySelector('#quiz-result-profile-label-' + sectionId);
      if (profileLabelEl && profile.label) {
        profileLabelEl.textContent = profile.label;
      }

      const profileDescEl = container.querySelector('#quiz-result-profile-desc-' + sectionId);
      if (profileDescEl && profile.description) {
        profileDescEl.innerHTML = profile.description;
      }

      // Produit
      const productEl = container.querySelector('#quiz-result-product-' + sectionId);
      if (productEl && profile.product) {
        const product = profile.product;
        let html = '';
        
        if (product.featured_image) {
          html += `<img src="${product.featured_image}" alt="${product.title}" class="quiz-result-product-image">`;
        }
        
        if (product.price) {
          html += `<div class="quiz-result-product-price">${product.price}</div>`;
        }
        
        productEl.innerHTML = html;
      }

      // Bullets
      const bulletsEl = container.querySelector('#quiz-result-bullets-' + sectionId);
      if (bulletsEl && profile.bullets) {
        bulletsEl.innerHTML = profile.bullets;
      }

      // Mantra
      const mantraEl = container.querySelector('#quiz-result-mantra-' + sectionId);
      if (mantraEl && profile.mantra) {
        mantraEl.textContent = profile.mantra;
      }

      // Boutons
      const buttonsEl = container.querySelector('#quiz-result-buttons-' + sectionId);
      if (buttonsEl && profile.product) {
        const product = profile.product;
        let html = '';
        
        if (product.url) {
          html += `<a href="${product.url}" class="milaura-btn milaura-btn-primary" style="text-align: center; text-decoration: none; display: block;">Découvrir ma bougie ✨</a>`;
        }
        
        if (product.variant_id) {
          html += `<button type="button" class="milaura-btn" style="margin-top: 10px; width: 100%;" onclick="fetch('/cart/add.js', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: ${product.variant_id}, quantity: 1 }) }).then(() => { window.location.href = '/cart'; });">Ajouter au panier</button>`;
        }
        
        buttonsEl.innerHTML = html;
      }

      // Météo émotionnelle
      const moodTitleEl = container.querySelector('#quiz-mood-title-' + sectionId);
      if (moodTitleEl) {
        const moodTitle = {{ section.settings.result_mood_title | json }};
        moodTitleEl.textContent = moodTitle || 'Ta météo émotionnelle';
      }

      const gaugesEl = container.querySelector('#quiz-mood-gauges-' + sectionId);
      if (gaugesEl) {
        gaugesEl.innerHTML = '';
        profiles.forEach(profileId => {
          const profileInfo = profileData[profileId];
          const percentage = results.percentages[profileId] || 0;
          const isWinner = profileId === winnerProfile;

          const gauge = document.createElement('div');
          gauge.className = 'quiz-mood-gauge';
          
          const label = document.createElement('div');
          label.className = 'quiz-mood-gauge-label';
          label.innerHTML = `<span>${profileInfo.label || profileId}</span><span>${percentage}%</span>`;
          
          const bar = document.createElement('div');
          bar.className = 'quiz-mood-gauge-bar';
          
          const fill = document.createElement('div');
          fill.className = 'quiz-mood-gauge-fill' + (isWinner ? ' is-winner' : '');
          fill.style.width = percentage + '%';
          
          bar.appendChild(fill);
          gauge.appendChild(label);
          gauge.appendChild(bar);
          gaugesEl.appendChild(gauge);
        });
      }

      // Stocker dans localStorage
      if (profile.product) {
        const storageData = {
          profileId: winnerProfile,
          scores: results.scores,
          percentages: results.percentages,
          productHandle: profile.product.handle || null,
          timestamp: Date.now()
        };
        localStorage.setItem('milauraLastResult', JSON.stringify(storageData));
      }
    }

    // ============================================
    // GESTION DU LOCALSTORAGE
    // ============================================
    function checkLastResult() {
      const lastResult = localStorage.getItem('milauraLastResult');
      if (lastResult) {
        try {
          const data = JSON.parse(lastResult);
          const linkEl = container.querySelector('#quiz-last-result-link-' + sectionId);
          const showLinkEl = container.querySelector('#quiz-show-last-' + sectionId);
          
          if (linkEl) linkEl.style.display = 'block';
          if (showLinkEl) {
            showLinkEl.addEventListener('click', (e) => {
              e.preventDefault();
              // Recharger les résultats depuis localStorage
              const storedData = JSON.parse(localStorage.getItem('milauraLastResult'));
              scores = storedData.scores;
              displayResults();
              goToState(QuizState.RESULT);
            });
          }
        } catch (e) {
          console.error('Error parsing last result:', e);
        }
      }
    }

    // ============================================
    // INITIALISATION
    // ============================================
    function init() {
      // Bouton start
      const startBtn = container.querySelector('#quiz-start-btn-' + sectionId);
      if (startBtn) {
        startBtn.addEventListener('click', goToQuestions);
      }

      // Vérifier dernière révélation
      checkLastResult();

      // Afficher l'état initial
      goToState(QuizState.INTRO);
    }

    // Démarrer quand le DOM est prêt
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

{% schema %}
{
  "name": "Milaura Quiz",
  "enabled_on": {
    "templates": ["*"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Introduction"
    },
    {
      "type": "text",
      "id": "intro_title",
      "label": "Titre d'introduction",
      "default": "Bienvenue dans ton rituel intérieur"
    },
    {
      "type": "richtext",
      "id": "intro_subtitle",
      "label": "Sous-titre d'introduction",
      "default": "<p>Découvre ta bougie émotionnelle personnalisée en répondant à quelques questions.</p>"
    },
    {
      "type": "text",
      "id": "intro_button_label",
      "label": "Label du bouton",
      "default": "Commencer le rituel"
    },
    {
      "type": "header",
      "content": "Bloc Experte"
    },
    {
      "type": "checkbox",
      "id": "show_expert",
      "label": "Afficher le bloc experte",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "expert_image",
      "label": "Photo de l'experte"
    },
    {
      "type": "text",
      "id": "expert_name",
      "label": "Nom de l'experte",
      "default": "Lorraine Vidal"
    },
    {
      "type": "text",
      "id": "expert_title",
      "label": "Titre de l'experte",
      "default": "Fondatrice & Experte en aromathérapie"
    },
    {
      "type": "richtext",
      "id": "expert_text",
      "label": "Texte de l'experte",
      "default": "<p>Je t'accompagne dans cette découverte de ton profil émotionnel unique.</p>"
    },
    {
      "type": "header",
      "content": "Transition"
    },
    {
      "type": "text",
      "id": "transition_title",
      "label": "Titre de transition",
      "default": "Nous réunissons nos énergies pour révéler ta création unique…"
    },
    {
      "type": "text",
      "id": "transition_subtitle",
      "label": "Sous-titre de transition",
      "default": "Ce n'est pas un quiz. C'est un miroir émotionnel."
    },
    {
      "type": "richtext",
      "id": "transition_body",
      "label": "Texte de transition",
      "default": "<p>Notre approche allie la science neuro-olfactive et l'art de la création sensorielle pour révéler ta bougie personnalisée.</p>"
    },
    {
      "type": "number",
      "id": "transition_duration_ms",
      "label": "Durée de la transition (ms)",
      "default": 3000
    },
    {
      "type": "header",
      "content": "Résultats"
    },
    {
      "type": "text",
      "id": "result_main_title",
      "label": "Titre principal des résultats",
      "default": "Ta bougie du moment"
    },
    {
      "type": "text",
      "id": "result_mood_title",
      "label": "Titre météo émotionnelle",
      "default": "Ta météo émotionnelle"
    },
    {
      "type": "header",
      "content": "Profil : Réconfort"
    },
    {
      "type": "text",
      "id": "profile_comfort_label",
      "label": "Label",
      "default": "Réconfort"
    },
    {
      "type": "richtext",
      "id": "profile_comfort_description",
      "label": "Description",
      "default": "<p>Tu cherches l'apaisement et la douceur. Cette bougie t'apportera le réconfort dont tu as besoin.</p>"
    },
    {
      "type": "product",
      "id": "profile_comfort_product",
      "label": "Produit associé"
    },
    {
      "type": "richtext",
      "id": "profile_comfort_bullets",
      "label": "Bénéfices (liste)",
      "default": "<ul><li>Apaisement immédiat</li><li>Réconfort émotionnel</li><li>Moment de douceur</li></ul>"
    },
    {
      "type": "text",
      "id": "profile_comfort_mantra",
      "label": "Mantra",
      "default": "Je m'offre le réconfort que je mérite"
    },
    {
      "type": "header",
      "content": "Profil : Protection"
    },
    {
      "type": "text",
      "id": "profile_protection_label",
      "label": "Label",
      "default": "Protection"
    },
    {
      "type": "richtext",
      "id": "profile_protection_description",
      "label": "Description",
      "default": "<p>Tu as besoin de te sentir protégé(e) et en sécurité. Cette bougie créera un bouclier énergétique autour de toi.</p>"
    },
    {
      "type": "product",
      "id": "profile_protection_product",
      "label": "Produit associé"
    },
    {
      "type": "richtext",
      "id": "profile_protection_bullets",
      "label": "Bénéfices (liste)",
      "default": "<ul><li>Bouclier énergétique</li><li>Protection émotionnelle</li><li>Sentiment de sécurité</li></ul>"
    },
    {
      "type": "text",
      "id": "profile_protection_mantra",
      "label": "Mantra",
      "default": "Je suis protégé(e) et en sécurité"
    },
    {
      "type": "header",
      "content": "Profil : Sérénité"
    },
    {
      "type": "text",
      "id": "profile_serenity_label",
      "label": "Label",
      "default": "Sérénité"
    },
    {
      "type": "richtext",
      "id": "profile_serenity_description",
      "label": "Description",
      "default": "<p>Tu recherches la paix intérieure et la tranquillité. Cette bougie t'aidera à trouver ton équilibre.</p>"
    },
    {
      "type": "product",
      "id": "profile_serenity_product",
      "label": "Produit associé"
    },
    {
      "type": "richtext",
      "id": "profile_serenity_bullets",
      "label": "Bénéfices (liste)",
      "default": "<ul><li>Paix intérieure</li><li>Équilibre émotionnel</li><li>Tranquillité d'esprit</li></ul>"
    },
    {
      "type": "text",
      "id": "profile_serenity_mantra",
      "label": "Mantra",
      "default": "Je trouve la paix en moi"
    },
    {
      "type": "header",
      "content": "Profil : Élégance"
    },
    {
      "type": "text",
      "id": "profile_elegance_label",
      "label": "Label",
      "default": "Élégance"
    },
    {
      "type": "richtext",
      "id": "profile_elegance_description",
      "label": "Description",
      "default": "<p>Tu apprécies la beauté et la sophistication. Cette bougie reflète ton raffinement.</p>"
    },
    {
      "type": "product",
      "id": "profile_elegance_product",
      "label": "Produit associé"
    },
    {
      "type": "richtext",
      "id": "profile_elegance_bullets",
      "label": "Bénéfices (liste)",
      "default": "<ul><li>Raffinement</li><li>Beauté intérieure</li><li>Sophistication</li></ul>"
    },
    {
      "type": "text",
      "id": "profile_elegance_mantra",
      "label": "Mantra",
      "default": "Je rayonne d'élégance"
    },
    {
      "type": "header",
      "content": "Profil : Joie"
    },
    {
      "type": "text",
      "id": "profile_joy_label",
      "label": "Label",
      "default": "Joie"
    },
    {
      "type": "richtext",
      "id": "profile_joy_description",
      "label": "Description",
      "default": "<p>Tu cherches la légèreté et la joie de vivre. Cette bougie apportera de la lumière dans ta vie.</p>"
    },
    {
      "type": "product",
      "id": "profile_joy_product",
      "label": "Produit associé"
    },
    {
      "type": "richtext",
      "id": "profile_joy_bullets",
      "label": "Bénéfices (liste)",
      "default": "<ul><li>Légèreté</li><li>Joie de vivre</li><li>Énergie positive</li></ul>"
    },
    {
      "type": "text",
      "id": "profile_joy_mantra",
      "label": "Mantra",
      "default": "Je choisis la joie chaque jour"
    }
  ],
  "blocks": [
    {
      "type": "question",
      "name": "Question",
      "settings": [
        {
          "type": "text",
          "id": "question_label",
          "label": "Question",
          "default": "Comment te sens-tu en ce moment ?"
        },
        {
          "type": "text",
          "id": "answer_1_label",
          "label": "Réponse 1",
          "default": "J'ai besoin de réconfort"
        },
        {
          "type": "select",
          "id": "answer_1_profile",
          "label": "Profil réponse 1",
          "options": [
            {
              "value": "reconfort",
              "label": "Réconfort"
            },
            {
              "value": "protection",
              "label": "Protection"
            },
            {
              "value": "serenite",
              "label": "Sérénité"
            },
            {
              "value": "elegance",
              "label": "Élégance"
            },
            {
              "value": "joie",
              "label": "Joie"
            }
          ],
          "default": "reconfort"
        },
        {
          "type": "text",
          "id": "answer_2_label",
          "label": "Réponse 2",
          "default": "Je me sens vulnérable"
        },
        {
          "type": "select",
          "id": "answer_2_profile",
          "label": "Profil réponse 2",
          "options": [
            {
              "value": "reconfort",
              "label": "Réconfort"
            },
            {
              "value": "protection",
              "label": "Protection"
            },
            {
              "value": "serenite",
              "label": "Sérénité"
            },
            {
              "value": "elegance",
              "label": "Élégance"
            },
            {
              "value": "joie",
              "label": "Joie"
            }
          ],
          "default": "protection"
        },
        {
          "type": "text",
          "id": "answer_3_label",
          "label": "Réponse 3 (optionnel)"
        },
        {
          "type": "select",
          "id": "answer_3_profile",
          "label": "Profil réponse 3",
          "options": [
            {
              "value": "reconfort",
              "label": "Réconfort"
            },
            {
              "value": "protection",
              "label": "Protection"
            },
            {
              "value": "serenite",
              "label": "Sérénité"
            },
            {
              "value": "elegance",
              "label": "Élégance"
            },
            {
              "value": "joie",
              "label": "Joie"
            }
          ],
          "default": "serenite"
        },
        {
          "type": "text",
          "id": "answer_4_label",
          "label": "Réponse 4 (optionnel)"
        },
        {
          "type": "select",
          "id": "answer_4_profile",
          "label": "Profil réponse 4",
          "options": [
            {
              "value": "reconfort",
              "label": "Réconfort"
            },
            {
              "value": "protection",
              "label": "Protection"
            },
            {
              "value": "serenite",
              "label": "Sérénité"
            },
            {
              "value": "elegance",
              "label": "Élégance"
            },
            {
              "value": "joie",
              "label": "Joie"
            }
          ],
          "default": "elegance"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Milaura Quiz",
      "blocks": [
        {
          "type": "question",
          "settings": {
            "question_label": "Comment te sens-tu en ce moment ?",
            "answer_1_label": "J'ai besoin de réconfort",
            "answer_2_label": "Je me sens vulnérable",
            "answer_3_label": "Je cherche la paix",
            "answer_4_label": "Je veux de l'élégance"
          }
        },
        {
          "type": "question",
          "settings": {
            "question_label": "Quel est ton besoin principal aujourd'hui ?",
            "answer_1_label": "Réconfort",
            "answer_2_label": "Protection",
            "answer_3_label": "Sérénité"
          }
        }
      ]
    }
  ]
}
{% endschema %}

