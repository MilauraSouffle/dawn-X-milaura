{% comment %}
  MILAURA NEWSLETTER POPUP
  "Votre Rituel Personnalise" - Popup intelligent avec 3 parcours
  Triggers: scroll+time, exit-intent, post-quiz
  Google-compliant mobile (max 70vh, easy dismiss)
{% endcomment %}

{% style %}
  /* ============================================
     MILAURA NEWSLETTER POPUP
     ============================================ */

  .milaura-popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 200000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .milaura-popup-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  /* --- CARTE --- */
  .milaura-popup-card {
    position: relative;
    width: 100%;
    max-width: 440px;
    max-height: 70vh;
    overflow-y: auto;
    /* Glassmorphism */
    background: rgba(253, 251, 247, 0.97);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border-radius: 24px;
    border: 1px solid rgba(192, 160, 98, 0.3);
    box-shadow: 0 24px 80px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(192, 160, 98, 0.1);
    padding: 36px 28px 28px;
    text-align: center;
    transform: scale(0.9) translateY(20px);
    transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
  }

  .milaura-popup-overlay.active .milaura-popup-card {
    transform: scale(1) translateY(0);
  }

  /* Bouton fermer */
  .milaura-popup-close {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 36px;
    height: 36px;
    border: none;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
    padding: 0;
  }

  .milaura-popup-close:hover {
    background: rgba(0, 0, 0, 0.1);
  }

  .milaura-popup-close svg {
    width: 16px;
    height: 16px;
    color: #666;
  }

  /* --- CONTENU --- */
  .milaura-popup-kicker {
    font-family: 'Dancing Script', cursive;
    color: var(--milaura-gold, #C0A062);
    font-size: 1.1rem;
    margin: 0 0 8px 0;
  }

  .milaura-popup-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.35rem;
    font-weight: 600;
    color: #000;
    margin: 0 0 8px 0;
    line-height: 1.3;
  }

  .milaura-popup-text {
    font-family: 'Lato', sans-serif;
    font-size: 0.9rem;
    color: #555;
    line-height: 1.5;
    margin: 0 0 20px 0;
  }

  .milaura-popup-profile-badge {
    display: inline-block;
    padding: 6px 16px;
    background: linear-gradient(135deg, rgba(192, 160, 98, 0.15), rgba(192, 160, 98, 0.08));
    border: 1px solid rgba(192, 160, 98, 0.3);
    border-radius: 20px;
    font-family: 'Playfair Display', serif;
    font-size: 0.95rem;
    color: var(--milaura-gold-dark, #8F723A);
    font-weight: 600;
    margin-bottom: 16px;
  }

  /* --- Bullets visuels --- */
  .milaura-popup-benefits {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
    text-align: left;
  }

  .milaura-popup-benefit {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .milaura-popup-benefit-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: linear-gradient(135deg, rgba(192, 160, 98, 0.15), rgba(192, 160, 98, 0.05));
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .milaura-popup-benefit-icon svg {
    width: 18px;
    height: 18px;
    color: var(--milaura-gold-dark, #8F723A);
  }

  .milaura-popup-benefit-text {
    font-family: 'Lato', sans-serif;
    font-size: 0.85rem;
    color: #333;
    line-height: 1.3;
  }

  /* --- CTA quiz post-inscription --- */
  .milaura-popup-quiz-cta {
    display: inline-block;
    margin-top: 14px;
    padding: 10px 20px;
    border: 1px solid rgba(192, 160, 98, 0.3);
    border-radius: 50px;
    background: transparent;
    font-family: 'Lato', sans-serif;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--milaura-gold-dark, #8F723A);
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .milaura-popup-quiz-cta:hover {
    background: rgba(192, 160, 98, 0.08);
    border-color: var(--milaura-gold, #C0A062);
    transform: translateY(-1px);
  }

  /* --- Formulaire --- */
  .milaura-popup-form {
    display: flex;
    gap: 10px;
  }

  .milaura-popup-email {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid rgba(192, 160, 98, 0.25);
    border-radius: 50px;
    background: rgba(255, 255, 255, 0.8);
    font-family: 'Lato', sans-serif;
    font-size: 0.9rem;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }

  .milaura-popup-email:focus {
    outline: none;
    border-color: var(--milaura-gold, #C0A062);
    box-shadow: 0 0 0 3px rgba(192, 160, 98, 0.12);
  }

  .milaura-popup-submit {
    padding: 12px 22px;
    background: linear-gradient(135deg, var(--milaura-gold, #C0A062), var(--milaura-gold-light, #E6C88B));
    color: #fff;
    border: none;
    border-radius: 50px;
    font-family: 'Lato', sans-serif;
    font-size: 0.85rem;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    white-space: nowrap;
  }

  .milaura-popup-submit:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(192, 160, 98, 0.35);
  }

  /* --- Succes --- */
  .milaura-popup-success {
    display: none;
    text-align: center;
    padding: 10px 0;
  }

  .milaura-popup-success.active {
    display: block;
  }

  .milaura-popup-success-icon {
    font-size: 2.5rem;
    margin-bottom: 12px;
  }

  .milaura-popup-success-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.2rem;
    font-weight: 600;
    color: #000;
    margin: 0 0 8px 0;
  }

  .milaura-popup-success-text {
    font-family: 'Lato', sans-serif;
    font-size: 0.9rem;
    color: #555;
    margin: 0;
  }

  .milaura-popup-promo {
    margin-top: 16px;
    padding: 14px 18px;
    background: linear-gradient(135deg, rgba(192, 160, 98, 0.12), rgba(192, 160, 98, 0.05));
    border: 1px dashed rgba(192, 160, 98, 0.4);
    border-radius: 14px;
  }

  .milaura-popup-promo-label {
    font-family: 'Lato', sans-serif;
    font-size: 0.78rem;
    color: #666;
    margin: 0 0 6px 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .milaura-popup-promo-code {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--milaura-gold-dark, #8F723A);
    letter-spacing: 2px;
    margin: 0;
    user-select: all;
    cursor: pointer;
  }

  /* Mention RGPD */
  .milaura-popup-legal {
    font-family: 'Lato', sans-serif;
    font-size: 0.7rem;
    color: #aaa;
    margin-top: 14px;
    line-height: 1.4;
  }

  /* --- MOBILE --- */
  @media screen and (max-width: 768px) {
    .milaura-popup-overlay {
      align-items: flex-end;
      padding: 0;
    }

    .milaura-popup-card {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 24px 24px 0 0;
      padding: 32px 20px 24px;
      transform: translateY(100%);
    }

    .milaura-popup-overlay.active .milaura-popup-card {
      transform: translateY(0);
    }

    .milaura-popup-form {
      flex-direction: column;
    }

    .milaura-popup-submit {
      width: 100%;
    }
  }

  /* --- REDUCED MOTION --- */
  @media (prefers-reduced-motion: reduce) {
    .milaura-popup-overlay,
    .milaura-popup-card,
    .milaura-popup-microquiz-btn,
    .milaura-popup-submit {
      transition: none !important;
    }
  }
{% endstyle %}

<div class="milaura-popup-overlay" id="milaura-popup-overlay" role="dialog" aria-modal="true" aria-label="{{ section.settings.popup_aria_label | default: 'Rituel personnalise' }}">
  <div class="milaura-popup-card">
    <button class="milaura-popup-close" id="milaura-popup-close" aria-label="Fermer">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>

    <!-- Contenu principal (identique quiz fait ou pas) -->
    <div id="milaura-popup-main">
      <p class="milaura-popup-kicker">{{ section.settings.kicker | default: 'Rien que pour toi' }}</p>
      <h2 class="milaura-popup-title">{{ section.settings.title | default: 'Ton premier rituel bien-etre, offert' }}</h2>

      <!-- Badge profil (visible seulement si quiz fait) -->
      <div class="milaura-popup-profile-badge" id="milaura-popup-profile-name" style="display:none;"></div>

      <!-- 3 bullets visuels -->
      <div class="milaura-popup-benefits">
        <div class="milaura-popup-benefit">
          <div class="milaura-popup-benefit-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
          </div>
          <span class="milaura-popup-benefit-text">{{ section.settings.benefit_1 | default: 'Guide pierres & intention du mois' }}</span>
        </div>
        <div class="milaura-popup-benefit">
          <div class="milaura-popup-benefit-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
          </div>
          <span class="milaura-popup-benefit-text">{{ section.settings.benefit_2 | default: 'Conseil rituel personnalise' }}</span>
        </div>
        <div class="milaura-popup-benefit">
          <div class="milaura-popup-benefit-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
          </div>
          <span class="milaura-popup-benefit-text">{{ section.settings.benefit_3 | default: 'Offres exclusives membres' }}</span>
        </div>
      </div>

      <p class="milaura-popup-retention" style="font-family:'Lato',sans-serif;font-size:0.8rem;color:var(--milaura-gold-dark,#8F723A);font-style:italic;margin:0 0 16px 0;line-height:1.4;">{{ section.settings.retention_text | default: "Et dans 30 jours, un rappel pour rafraichir ton quiz et decouvrir ta nouvelle pierre du moment." }}</p>

      <form class="milaura-popup-form" id="milaura-popup-form" method="post" action="/contact#contact_form" accept-charset="UTF-8">
        <input type="hidden" name="form_type" value="customer">
        <input type="hidden" name="utf8" value="✓">
        <input type="hidden" name="contact[tags]" value="newsletter,rituel,source:popup" id="milaura-popup-tags">
        <input type="hidden" name="contact[note]" id="milaura-popup-note" value="">
        <label for="milaura-popup-email" class="visually-hidden">Email</label>
        <input type="email" id="milaura-popup-email" name="contact[email]" class="milaura-popup-email" placeholder="{{ section.settings.email_placeholder | default: 'ton@email.com' }}" required autocomplete="email">
        <button type="submit" class="milaura-popup-submit">{{ section.settings.btn_label | default: 'Recevoir mon rituel gratuit' }}</button>
      </form>
      <p class="milaura-popup-legal">{{ section.settings.legal_text | default: "En t'inscrivant, tu acceptes de recevoir nos emails. Desabonnement en un clic." }}</p>
    </div>

    <!-- Succes + CTA quiz -->
    <div class="milaura-popup-success" id="milaura-popup-success">
      <div class="milaura-popup-success-icon">✨</div>
      <h3 class="milaura-popup-success-title">{{ section.settings.success_title | default: 'Bienvenue dans la communaute !' }}</h3>
      <p class="milaura-popup-success-text">{{ section.settings.success_text | default: 'Ton premier rituel arrive bientot. Dans 30 jours, tu recevras un rappel pour rafraichir ton quiz et choisir la pierre qui t accompagnera.' }}</p>
      {% if section.settings.promo_code != blank %}
        <div class="milaura-popup-promo">
          <p class="milaura-popup-promo-label">{{ section.settings.promo_label | default: 'Ton code -10% premiere commande' }}</p>
          <p class="milaura-popup-promo-code">{{ section.settings.promo_code | default: 'BIENVENUE10' }}</p>
        </div>
      {% endif %}
      <a href="{{ section.settings.quiz_url | default: '/pages/quiz' }}" class="milaura-popup-quiz-cta" id="milaura-popup-quiz-cta" style="display:none;">
        {{ section.settings.quiz_cta_label | default: 'Decouvre ton profil emotionnel →' }}
      </a>
    </div>
  </div>
</div>

<script>
{% if customer %}window.milauraIsCustomer = true;{% endif %}
(function() {
  'use strict';

  var overlay = document.getElementById('milaura-popup-overlay');
  var closeBtn = document.getElementById('milaura-popup-close');
  var popupShown = false;

  var profileLabels = {
    apaisement: 'Apaisement',
    protection: 'Protection',
    serenite: 'Serenite',
    amour: 'Amour',
    chance: 'Chance'
  };

  /* --- Helpers --- */
  function isSubscribed() {
    try { return localStorage.getItem('milauraNewsletterSubscribed') === 'true'; } catch(e) { return false; }
  }

  function isDismissed() {
    try {
      var ts = localStorage.getItem('milauraPopupDismissed');
      if (!ts) return false;
      return (Date.now() - parseInt(ts, 10)) < 7 * 24 * 60 * 60 * 1000; /* 7 days */
    } catch(e) { return false; }
  }

  function getQuizResult() {
    try {
      var raw = localStorage.getItem('milauraLastResult');
      if (raw) return JSON.parse(raw);
    } catch(e) {}
    return null;
  }

  function getPageCount() {
    try {
      var count = parseInt(sessionStorage.getItem('milauraPageCount') || '0', 10) + 1;
      sessionStorage.setItem('milauraPageCount', String(count));
      return count;
    } catch(e) { return 1; }
  }

  var pageCount = getPageCount();

  function canShow() {
    if (window.milauraIsCustomer) return false;
    return !isSubscribed() && !isDismissed() && !popupShown;
  }

  /* --- Show popup --- */
  function showPopup() {
    if (!canShow()) return;
    popupShown = true;

    var mainContent = document.getElementById('milaura-popup-main');
    var badge = document.getElementById('milaura-popup-profile-name');
    var noteField = document.getElementById('milaura-popup-note');
    var tagsField = document.getElementById('milaura-popup-tags');

    /* Show profile badge if quiz done */
    var result = getQuizResult();
    if (result && result.profile) {
      var label = profileLabels[result.profile] || result.profile;
      if (badge) {
        badge.textContent = label;
        badge.style.display = 'inline-block';
      }
      if (noteField) noteField.value = 'Profil: ' + label;
      if (tagsField) tagsField.value = 'newsletter,rituel,source:popup,energy:' + result.profile;
    }

    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  /* --- Close popup --- */
  function closePopup() {
    overlay.classList.remove('active');
    document.body.style.overflow = '';
    try { localStorage.setItem('milauraPopupDismissed', String(Date.now())); } catch(e) {}
  }

  /* Close handlers */
  if (closeBtn) closeBtn.addEventListener('click', closePopup);
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) closePopup();
  });
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && overlay.classList.contains('active')) closePopup();
  });

  /* --- Form submission --- */
  var form = document.getElementById('milaura-popup-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      var emailInput = form.querySelector('input[type="email"]');
      if (!emailInput || !emailInput.value) return;

      var formData = new FormData(form);

      fetch('/contact#contact_form', {
        method: 'POST',
        body: formData,
        headers: { 'Accept': 'text/html' }
      }).then(function() {
        try { localStorage.setItem('milauraNewsletterSubscribed', 'true'); } catch(e) {}
        document.dispatchEvent(new CustomEvent('milaura:newsletter-subscribed'));

        /* Show success */
        var mainContent = document.getElementById('milaura-popup-main');
        var successEl = document.getElementById('milaura-popup-success');
        if (mainContent) mainContent.style.display = 'none';
        if (successEl) successEl.classList.add('active');

        /* Show quiz CTA only if no quiz done */
        var result = getQuizResult();
        if (!result || !result.profile) {
          var quizCta = document.getElementById('milaura-popup-quiz-cta');
          if (quizCta) quizCta.style.display = 'inline-block';
        }

        /* Auto-close after 4s */
        setTimeout(closePopup, 4000);
      }).catch(function() {
        form.submit();
      });
    });
  }

  /* --- TRIGGERS --- */
  var pageTemplate = '{{ template.name }}';
  var isHomepage = (pageTemplate === 'index');
  var isProduct = (pageTemplate === 'product');
  var isCollection = (pageTemplate === 'collection');

  /* Trigger 1: Homepage = simple delay (configurable, default 30s) */
  if (isHomepage) {
    var homepageDelay = {{ section.settings.homepage_delay | default: 30 }} * 1000;
    setTimeout(function() { showPopup(); }, homepageDelay);
  }

  /* Trigger 2: Product page = 30s OR exit-intent (desktop) */
  if (isProduct) {
    setTimeout(function() { showPopup(); }, 30000);

    if (window.innerWidth > 768) {
      document.addEventListener('mouseout', function exitHandler(e) {
        if (e.clientY <= 0 && canShow()) {
          showPopup();
          document.removeEventListener('mouseout', exitHandler);
        }
      });
    }
  }

  /* Trigger 3: Collection page = 80% scroll */
  if (isCollection) {
    function checkScrollCollection() {
      var scrollPercent = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
      if (scrollPercent >= 80) {
        window.removeEventListener('scroll', checkScrollCollection);
        showPopup();
      }
    }
    window.addEventListener('scroll', checkScrollCollection, { passive: true });
  }

  /* Trigger 4: Page-count = 3+ pages vues, montrer apres 15s */
  if (pageCount >= 3 && !isHomepage && !isProduct && !isCollection) {
    setTimeout(function() { showPopup(); }, 15000);
  }

  /* Trigger 5: Post-quiz (any page) */
  document.addEventListener('milaura:quiz-result', function() {
    setTimeout(function() { showPopup(); }, 2000);
  });

  /* Listen for subscription from bubble */
  document.addEventListener('milaura:newsletter-subscribed', function() {
    if (overlay.classList.contains('active')) closePopup();
  });

})();
</script>

{% schema %}
{
  "name": "Milaura Popup Newsletter",
  "settings": [
    {
      "type": "header",
      "content": "Contenu principal"
    },
    {
      "type": "text",
      "id": "kicker",
      "label": "Kicker",
      "default": "Rien que pour toi"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Titre",
      "default": "Ton premier rituel bien-etre, offert"
    },
    {
      "type": "text",
      "id": "btn_label",
      "label": "Bouton",
      "default": "Recevoir mon rituel gratuit"
    },
    {
      "type": "header",
      "content": "Benefices (3 bullets)"
    },
    {
      "type": "text",
      "id": "benefit_1",
      "label": "Benefice 1",
      "default": "Guide pierres & intention du mois"
    },
    {
      "type": "text",
      "id": "benefit_2",
      "label": "Benefice 2",
      "default": "Conseil rituel personnalise"
    },
    {
      "type": "text",
      "id": "benefit_3",
      "label": "Benefice 3",
      "default": "Offres exclusives membres"
    },
    {
      "type": "header",
      "content": "Retention"
    },
    {
      "type": "textarea",
      "id": "retention_text",
      "label": "Texte de retention (sous les bullets)",
      "default": "Et dans 30 jours, un rappel pour rafraichir ton quiz et decouvrir ta nouvelle pierre du moment."
    },
    {
      "type": "header",
      "content": "Succes & Quiz CTA"
    },
    {
      "type": "text",
      "id": "success_title",
      "label": "Titre succes",
      "default": "Bienvenue dans la communaute !"
    },
    {
      "type": "textarea",
      "id": "success_text",
      "label": "Texte succes",
      "default": "Ton premier rituel arrive bientot. Dans 30 jours, tu recevras un rappel pour rafraichir ton quiz et choisir la pierre qui t accompagnera."
    },
    {
      "type": "text",
      "id": "quiz_cta_label",
      "label": "CTA quiz (si pas fait)",
      "default": "Decouvre ton profil emotionnel →"
    },
    {
      "type": "url",
      "id": "quiz_url",
      "label": "URL page quiz"
    },
    {
      "type": "header",
      "content": "Code promo"
    },
    {
      "type": "text",
      "id": "promo_code",
      "label": "Code promo",
      "default": "BIENVENUE10",
      "info": "Laisser vide pour masquer le bloc promo"
    },
    {
      "type": "text",
      "id": "promo_label",
      "label": "Label au-dessus du code",
      "default": "Ton code -10% premiere commande"
    },
    {
      "type": "header",
      "content": "Triggers"
    },
    {
      "type": "range",
      "id": "homepage_delay",
      "label": "Delai homepage (secondes)",
      "min": 10,
      "max": 120,
      "step": 5,
      "default": 30,
      "info": "Temps avant affichage du popup sur la homepage"
    },
    {
      "type": "header",
      "content": "General"
    },
    {
      "type": "text",
      "id": "email_placeholder",
      "label": "Placeholder email",
      "default": "ton@email.com"
    },
    {
      "type": "textarea",
      "id": "legal_text",
      "label": "Texte legal",
      "default": "En t'inscrivant, tu acceptes de recevoir nos emails. Desabonnement en un clic."
    },
    {
      "type": "text",
      "id": "popup_aria_label",
      "label": "Aria label popup",
      "default": "Rituel personnalise"
    }
  ],
  "presets": [
    {
      "name": "Milaura Popup Newsletter"
    }
  ]
}
{% endschema %}
