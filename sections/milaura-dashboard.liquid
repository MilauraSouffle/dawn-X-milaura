{% comment %}
  Milaura Dashboard V2 ‚Äî Section monolithique
  Affiche les resultats du quiz emotionnel sur la page /account
  Donnees : localStorage.milauraLastResult + profileData JS + produits Liquid
{% endcomment %}

{% style %}
/* ============================================
   MILAURA DASHBOARD ‚Äî CSS SCOPE
   ============================================ */
#MilauraDashboard-{{ section.id }} {
  --dash-accent: {{ section.settings.accent_color | default: '#C0A062' }};
  --dash-accent-rgb: 192, 160, 98;
  max-width: 900px;
  margin: 0 auto;
  padding: 0 0 var(--milaura-spacing-xl) 0;
}

/* --- LOADING STATE --- */
.dash-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px;
  gap: 20px;
}
.dash-spinner {
  width: 48px;
  height: 48px;
  border: 3px solid rgba(192, 160, 98, 0.15);
  border-top-color: var(--dash-accent);
  border-radius: 50%;
  animation: dash-spin 0.8s linear infinite;
}
@keyframes dash-spin {
  to { transform: rotate(360deg); }
}
.dash-loading-text {
  font-family: var(--milaura-font-body);
  font-size: 15px;
  color: var(--milaura-text-light);
  letter-spacing: 0.5px;
}

/* --- EMPTY STATE --- */
.dash-empty {
  display: none;
  text-align: center;
  padding: 60px 24px;
}
.dash-empty-card {
  background-color: rgba(255, 255, 255, 0.85);
  background: rgba(255, 255, 255, 0.75);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(192, 160, 98, 0.4);
  border-radius: 30px;
  box-shadow: 0 20px 50px rgba(192, 160, 98, 0.15);
  padding: 50px 36px;
  max-width: 520px;
  margin: 0 auto;
}
.dash-empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
  display: block;
}
.dash-empty-title {
  font-family: var(--milaura-font-heading);
  font-size: 26px;
  font-weight: 500;
  color: var(--milaura-text);
  margin: 0 0 12px 0;
  line-height: 1.25;
}
.dash-empty-text {
  font-family: var(--milaura-font-body);
  font-size: 15px;
  color: var(--milaura-text-light);
  line-height: 1.65;
  margin: 0 0 24px 0;
}

/* --- DASHBOARD STATE --- */
.dash-main {
  display: none;
  flex-direction: column;
  gap: 20px;
}

/* --- A. HEADER --- */
.dash-header {
  text-align: center;
  padding: 8px 0 0 0;
}
.dash-greeting {
  font-family: var(--milaura-font-heading);
  font-size: {{ section.settings.heading_size | default: 32 }}px;
  font-weight: 500;
  color: var(--milaura-text);
  margin: 0 0 8px 0;
  line-height: 1.2;
}
.dash-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 18px;
  border-radius: 50px;
  background: rgba(var(--dash-accent-rgb), 0.1);
  border: 1px solid rgba(var(--dash-accent-rgb), 0.25);
  font-family: var(--milaura-font-body);
  font-size: 14px;
  font-weight: 600;
  color: var(--dash-accent);
  letter-spacing: 0.5px;
}
.dash-badge-icon {
  font-size: 16px;
  line-height: 1;
}

/* --- B. SCORE VIBRATOIRE --- */
.dash-score {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px 0;
}
.dash-score-ring {
  position: relative;
  width: 160px;
  height: 160px;
}
.dash-score-ring svg {
  transform: rotate(-90deg);
  width: 100%;
  height: 100%;
}
.dash-score-bg {
  fill: none;
  stroke: rgba(var(--dash-accent-rgb), 0.12);
  stroke-width: 8;
}
.dash-score-fill {
  fill: none;
  stroke: var(--dash-accent);
  stroke-width: 8;
  stroke-linecap: round;
  stroke-dasharray: 440;
  stroke-dashoffset: 440;
  transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1);
}
.dash-score-value {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}
.dash-score-percent {
  font-family: var(--milaura-font-heading);
  font-size: 38px;
  font-weight: 600;
  color: var(--dash-accent);
  line-height: 1;
  display: block;
}
.dash-score-label {
  font-family: var(--milaura-font-body);
  font-size: 11px;
  color: var(--milaura-text-light);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-top: 4px;
  display: block;
}

/* --- C. KPI GRID --- */
.dash-kpis {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.dash-kpi {
  background-color: rgba(255, 255, 255, 0.85);
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(192, 160, 98, 0.2);
  border-radius: 20px;
  padding: 18px 16px;
  text-align: center;
}
.dash-kpi-icon {
  font-size: 22px;
  margin-bottom: 6px;
  display: block;
}
.dash-kpi-value {
  font-family: var(--milaura-font-heading);
  font-size: 16px;
  font-weight: 600;
  color: var(--milaura-text);
  display: block;
  margin-bottom: 2px;
}
.dash-kpi-label {
  font-family: var(--milaura-font-body);
  font-size: 11px;
  color: var(--milaura-text-light);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* --- D. COLD READING --- */
.dash-reading {
  background-color: rgba(255, 255, 255, 0.85);
  background: rgba(255, 255, 255, 0.75);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(192, 160, 98, 0.4);
  border-radius: 30px;
  box-shadow: 0 20px 50px rgba(192, 160, 98, 0.15);
  padding: 36px 30px;
}
.dash-reading-title {
  font-family: var(--milaura-font-heading);
  font-size: 22px;
  font-weight: 500;
  font-style: italic;
  color: var(--milaura-text);
  margin: 0 0 16px 0;
  line-height: 1.35;
}
.dash-reading-text {
  font-family: var(--milaura-font-body);
  font-size: {{ section.settings.body_size | default: 15 }}px;
  color: var(--milaura-text-light);
  line-height: 1.75;
  margin: 0 0 16px 0;
}
.dash-reading-text .word {
  opacity: 0;
  transition: opacity 0.3s ease;
}
.dash-reading-text .word.visible {
  opacity: 1;
}
.dash-reading-bullets {
  list-style: none;
  padding: 0;
  margin: 0;
}
.dash-reading-bullets li {
  font-family: var(--milaura-font-body);
  font-size: 14px;
  color: var(--milaura-text);
  padding: 6px 0;
  padding-left: 24px;
  position: relative;
  line-height: 1.5;
}
.dash-reading-bullets li::before {
  content: '';
  position: absolute;
  left: 0;
  top: 13px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--dash-accent);
  opacity: 0.6;
}

/* --- E. MANTRA --- */
.dash-mantra {
  text-align: center;
  padding: 20px 16px;
}
.dash-mantra-text {
  font-family: var(--milaura-font-script);
  font-size: 28px;
  color: var(--dash-accent);
  line-height: 1.4;
  margin: 0;
  text-shadow: 0 0 30px rgba(var(--dash-accent-rgb), 0.2);
}
.dash-mantra-quotes {
  font-family: var(--milaura-font-heading);
  font-size: 22px;
  color: rgba(var(--dash-accent-rgb), 0.4);
}

/* --- F. PRODUIT STAR --- */
.dash-product {
  background-color: rgba(255, 255, 255, 0.85);
  background: rgba(255, 255, 255, 0.75);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(192, 160, 98, 0.4);
  border-radius: 30px;
  box-shadow: 0 20px 50px rgba(192, 160, 98, 0.15);
  padding: 28px 24px;
  text-align: center;
}
.dash-product-eyebrow {
  font-family: var(--milaura-font-body);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 3px;
  color: var(--milaura-gold-dark);
  margin: 0 0 16px 0;
}
.dash-product-img {
  width: 200px;
  height: 200px;
  object-fit: cover;
  border-radius: 20px;
  margin: 0 auto 16px auto;
  display: block;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
}
.dash-product-title {
  font-family: var(--milaura-font-heading);
  font-size: 22px;
  font-weight: 500;
  color: var(--milaura-text);
  margin: 0 0 10px 0;
}
.dash-product-badges {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.dash-product-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 4px 14px;
  border-radius: 50px;
  background: rgba(var(--dash-accent-rgb), 0.08);
  font-family: var(--milaura-font-body);
  font-size: 12px;
  color: var(--milaura-text-light);
}
.dash-product-price {
  font-family: var(--milaura-font-body);
  font-size: 20px;
  font-weight: 700;
  color: var(--milaura-text);
  margin: 0 0 16px 0;
}
.dash-product-cta {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

/* --- G. RITUEL --- */
.dash-ritual {
  padding: 8px 0;
}
.dash-ritual-title {
  font-family: var(--milaura-font-heading);
  font-size: 20px;
  font-weight: 500;
  color: var(--milaura-text);
  margin: 0 0 16px 0;
  text-align: center;
}
.dash-ritual-steps {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.dash-ritual-step {
  display: flex;
  gap: 14px;
  align-items: flex-start;
  background-color: rgba(255, 255, 255, 0.85);
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(192, 160, 98, 0.2);
  border-radius: 20px;
  padding: 18px 16px;
}
.dash-ritual-num {
  flex-shrink: 0;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--dash-accent);
  color: #fff;
  font-family: var(--milaura-font-heading);
  font-size: 15px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
}
.dash-ritual-text {
  font-family: var(--milaura-font-body);
  font-size: 14px;
  color: var(--milaura-text);
  line-height: 1.6;
  padding-top: 5px;
}

/* --- H. QUICK ACTIONS --- */
.dash-actions {
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  padding: 4px 0;
}
.dash-action-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 20px;
  border-radius: 50px;
  background: rgba(255, 255, 255, 0.85);
  border: 1px solid rgba(192, 160, 98, 0.3);
  font-family: var(--milaura-font-body);
  font-size: 13px;
  font-weight: 600;
  color: var(--milaura-text);
  text-decoration: none;
  transition: all 0.2s ease;
  letter-spacing: 0.3px;
}
.dash-action-pill:hover {
  border-color: var(--milaura-gold);
  box-shadow: 0 4px 15px rgba(192, 160, 98, 0.2);
  transform: translateY(-1px);
}
.dash-action-pill span {
  font-size: 15px;
  line-height: 1;
}

/* --- I. METEO EMOTIONNELLE --- */
.dash-mood {
  padding: 8px 0;
}
.dash-mood-title {
  font-family: var(--milaura-font-heading);
  font-size: 20px;
  font-weight: 500;
  color: var(--milaura-text);
  margin: 0 0 16px 0;
  text-align: center;
}
.dash-mood-bars {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.dash-mood-row {
  display: flex;
  align-items: center;
  gap: 12px;
}
.dash-mood-label {
  width: 110px;
  font-family: var(--milaura-font-body);
  font-size: 13px;
  color: var(--milaura-text-light);
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 0;
}
.dash-mood-label-icon {
  font-size: 14px;
  line-height: 1;
}
.dash-mood-track {
  flex: 1;
  height: 8px;
  background: rgba(192, 160, 98, 0.1);
  border-radius: 8px;
  overflow: hidden;
  min-width: 60px;
}
.dash-mood-fill {
  height: 100%;
  border-radius: 8px;
  width: 0%;
  transition: width 1s ease;
}
.dash-mood-fill.is-winner {
  background: linear-gradient(90deg, var(--dash-accent) 0%, rgba(var(--dash-accent-rgb), 0.6) 100%);
}
.dash-mood-fill.is-secondary {
  background: linear-gradient(90deg, rgba(192, 160, 98, 0.35) 0%, rgba(192, 160, 98, 0.15) 100%);
}
.dash-mood-pct {
  width: 42px;
  font-family: var(--milaura-font-body);
  font-size: 13px;
  color: var(--milaura-text-light);
  text-align: right;
  flex-shrink: 0;
}

/* --- J. MON VOYAGE --- */
.dash-voyage {
  background-color: rgba(255, 255, 255, 0.85);
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(192, 160, 98, 0.2);
  border-radius: 20px;
  padding: 22px 20px;
  text-align: center;
}
.dash-voyage-title {
  font-family: var(--milaura-font-heading);
  font-size: 18px;
  font-weight: 500;
  color: var(--milaura-text);
  margin: 0 0 8px 0;
}
.dash-voyage-date {
  font-family: var(--milaura-font-body);
  font-size: 13px;
  color: var(--milaura-text-light);
  margin: 0 0 6px 0;
}
.dash-voyage-summary {
  font-family: var(--milaura-font-body);
  font-size: 14px;
  color: var(--milaura-text);
  line-height: 1.5;
  margin: 0;
}

/* --- K. FOOTER --- */
.dash-footer {
  display: flex;
  justify-content: center;
  gap: 12px;
  flex-wrap: wrap;
  padding: 8px 0 0 0;
}

/* --- STICKY CTA --- */
.dash-sticky {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 100;
  background-color: rgba(255, 255, 255, 0.95);
  background: rgba(255, 255, 255, 0.92);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid rgba(192, 160, 98, 0.3);
  padding: 12px 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  transform: translateY(100%);
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.dash-sticky.visible {
  transform: translateY(0);
}
.dash-sticky-name {
  font-family: var(--milaura-font-heading);
  font-size: 15px;
  font-weight: 500;
  color: var(--milaura-text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 180px;
}
.dash-sticky-price {
  font-family: var(--milaura-font-body);
  font-size: 14px;
  font-weight: 700;
  color: var(--milaura-text);
}

/* --- SCROLL REVEAL --- */
.dash-reveal {
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.6s ease, transform 0.6s ease;
}
.dash-reveal.revealed {
  opacity: 1;
  transform: translateY(0);
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media screen and (max-width: 768px) {
  #MilauraDashboard-{{ section.id }} {
    padding: 0 0 90px 0;
  }
  .dash-greeting {
    font-size: 26px;
  }
  .dash-score-ring {
    width: 140px;
    height: 140px;
  }
  .dash-score-percent {
    font-size: 32px;
  }
  .dash-reading {
    padding: 28px 20px;
    border-radius: 20px;
  }
  .dash-reading-title {
    font-size: 19px;
  }
  .dash-product {
    padding: 24px 18px;
    border-radius: 20px;
  }
  .dash-product-img {
    width: 160px;
    height: 160px;
  }
  .dash-mantra-text {
    font-size: 24px;
  }
  .dash-kpis {
    gap: 10px;
  }
  .dash-kpi {
    padding: 14px 12px;
    border-radius: 16px;
  }
  .dash-mood-label {
    width: 90px;
    font-size: 12px;
  }
  .dash-actions {
    gap: 8px;
  }
  .dash-action-pill {
    padding: 8px 16px;
    font-size: 12px;
  }
}

@media screen and (max-width: 480px) {
  .dash-greeting {
    font-size: 22px;
  }
  .dash-score-ring {
    width: 120px;
    height: 120px;
  }
  .dash-score-percent {
    font-size: 28px;
  }
  .dash-empty-card {
    padding: 36px 20px;
    border-radius: 20px;
  }
  .dash-empty-title {
    font-size: 22px;
  }
  .dash-reading {
    padding: 22px 16px;
  }
  .dash-product {
    padding: 20px 14px;
  }
  .dash-product-img {
    width: 140px;
    height: 140px;
  }
  .dash-ritual-step {
    padding: 14px 12px;
  }
}

@media screen and (max-width: 380px) {
  .dash-greeting {
    font-size: 20px;
  }
  .dash-score-ring {
    width: 110px;
    height: 110px;
  }
  .dash-kpis {
    gap: 8px;
  }
  .dash-kpi {
    padding: 12px 10px;
    border-radius: 14px;
  }
  .dash-kpi-value {
    font-size: 14px;
  }
  .dash-mood-label {
    width: 80px;
    font-size: 11px;
  }
  .dash-reading {
    border-radius: 16px;
    padding: 18px 14px;
  }
  .dash-product {
    border-radius: 16px;
  }
}

/* --- REDUCED MOTION --- */
@media (prefers-reduced-motion: reduce) {
  .dash-spinner {
    animation: none;
    border-top-color: transparent;
  }
  .dash-score-fill {
    transition: none;
  }
  .dash-mood-fill {
    transition: none;
  }
  .dash-reveal {
    opacity: 1;
    transform: none;
    transition: none;
  }
  .dash-sticky {
    transition: none;
  }
  .dash-reading-text .word {
    opacity: 1;
    transition: none;
  }
}
{% endstyle %}

<div id="MilauraDashboard-{{ section.id }}">

  {%- comment -%} ETAT LOADING {%- endcomment -%}
  <div class="dash-loading" data-dash-state="loading">
    <div class="dash-spinner" aria-hidden="true"></div>
    <div class="dash-loading-text">{{ section.settings.loading_text | default: "Chargement de votre profil..." }}</div>
  </div>

  {%- comment -%} ETAT VIDE (pas de quiz) {%- endcomment -%}
  <div class="dash-empty" data-dash-state="empty">
    <div class="dash-empty-card">
      <span class="dash-empty-icon" aria-hidden="true">{{ section.settings.empty_icon | default: "‚ú®" }}</span>
      <h2 class="dash-empty-title">{{ section.settings.empty_title | default: "D√©couvrez votre profil √©motionnel" }}</h2>
      <p class="dash-empty-text">{{ section.settings.empty_text | default: "Votre diagnostic r√©v√®lera la bougie et la pierre qui r√©sonnent avec votre √©nergie actuelle." }}</p>
      <a href="{{ section.settings.quiz_url | default: '/pages/quiz' }}" class="milaura-btn-gold">
        {{ section.settings.empty_cta | default: "Faire le diagnostic" }}
      </a>
    </div>
  </div>

  {%- comment -%} ETAT DASHBOARD {%- endcomment -%}
  <div class="dash-main" data-dash-state="dashboard">

    {%- comment -%} A. HEADER {%- endcomment -%}
    <div class="dash-header dash-reveal">
      <h1 class="dash-greeting">
        {{ section.settings.greeting_prefix | default: "Bonjour" }}{% if customer %} {{ customer.first_name }}{% endif %}
      </h1>
      <div class="dash-badge" data-dash-badge>
        <span class="dash-badge-icon" data-dash-badge-icon></span>
        <span data-dash-badge-label></span>
      </div>
    </div>

    {%- comment -%} B. SCORE VIBRATOIRE {%- endcomment -%}
    <div class="dash-score dash-reveal">
      <div class="dash-score-ring">
        <svg viewBox="0 0 160 160" aria-hidden="true">
          <circle class="dash-score-bg" cx="80" cy="80" r="70"></circle>
          <circle class="dash-score-fill" cx="80" cy="80" r="70" data-dash-score-circle></circle>
        </svg>
        <div class="dash-score-value">
          <span class="dash-score-percent" data-dash-score-pct>0%</span>
          <span class="dash-score-label">{{ section.settings.score_label | default: "Vibration" }}</span>
        </div>
      </div>
    </div>

    {%- comment -%} C. KPI GRID {%- endcomment -%}
    <div class="dash-kpis dash-reveal">
      <div class="dash-kpi">
        <span class="dash-kpi-icon" data-dash-kpi-profile-icon></span>
        <span class="dash-kpi-value" data-dash-kpi-profile></span>
        <span class="dash-kpi-label">Profil</span>
      </div>
      <div class="dash-kpi">
        <span class="dash-kpi-icon">üíé</span>
        <span class="dash-kpi-value" data-dash-kpi-stone></span>
        <span class="dash-kpi-label">Pierre</span>
      </div>
      <div class="dash-kpi">
        <span class="dash-kpi-icon">üïØÔ∏è</span>
        <span class="dash-kpi-value" data-dash-kpi-scent></span>
        <span class="dash-kpi-label">Senteur</span>
      </div>
      <div class="dash-kpi">
        <span class="dash-kpi-icon">üìÖ</span>
        <span class="dash-kpi-value" data-dash-kpi-date></span>
        <span class="dash-kpi-label">Dernier diagnostic</span>
      </div>
    </div>

    {%- comment -%} D. COLD READING {%- endcomment -%}
    {%- if section.settings.show_cold_reading != false -%}
    <div class="dash-reading dash-reveal" data-dash-reading>
      <h2 class="dash-reading-title" data-dash-reading-title></h2>
      <p class="dash-reading-text" data-dash-reading-text></p>
      <ul class="dash-reading-bullets" data-dash-reading-bullets></ul>
    </div>
    {%- endif -%}

    {%- comment -%} E. MANTRA {%- endcomment -%}
    <div class="dash-mantra dash-reveal">
      <p class="dash-mantra-text">
        <span class="dash-mantra-quotes">&laquo;&nbsp;</span><span data-dash-mantra></span><span class="dash-mantra-quotes">&nbsp;&raquo;</span>
      </p>
    </div>

    {%- comment -%} F. PRODUIT STAR {%- endcomment -%}
    <div class="dash-product dash-reveal" data-dash-product>
      <p class="dash-product-eyebrow">{{ section.settings.product_eyebrow | default: "L'appel de l'√¢me" }}</p>
      <img class="dash-product-img" src="" alt="" data-dash-product-img loading="lazy">
      <h3 class="dash-product-title" data-dash-product-title></h3>
      <div class="dash-product-badges" data-dash-product-badges></div>
      <p class="dash-product-price" data-dash-product-price></p>
      <button type="button" class="milaura-btn-gold dash-product-cta" data-dash-add-to-cart disabled>
        Adopter
      </button>
    </div>

    {%- comment -%} G. RITUEL {%- endcomment -%}
    <div class="dash-ritual dash-reveal" data-dash-ritual>
      <h3 class="dash-ritual-title">{{ section.settings.ritual_title | default: "Ton rituel de connexion" }}</h3>
      <div class="dash-ritual-steps" data-dash-ritual-steps></div>
    </div>

    {%- comment -%} H. QUICK ACTIONS {%- endcomment -%}
    <div class="dash-actions dash-reveal">
      <a href="#dash-ritual-{{ section.id }}" class="dash-action-pill"><span>üïØÔ∏è</span> Mon Rituel</a>
      <a href="/collections/all" class="dash-action-pill"><span>üõçÔ∏è</span> Boutique</a>
      <a href="{{ section.settings.quiz_url | default: '/pages/quiz' }}" class="dash-action-pill"><span>üîÑ</span> Refaire le quiz</a>
    </div>

    {%- comment -%} I. METEO EMOTIONNELLE {%- endcomment -%}
    {%- if section.settings.show_mood_bars != false -%}
    <div class="dash-mood dash-reveal" data-dash-mood>
      <h3 class="dash-mood-title">{{ section.settings.mood_title | default: "Ta m√©t√©o √©motionnelle" }}</h3>
      <div class="dash-mood-bars" data-dash-mood-bars></div>
    </div>
    {%- endif -%}

    {%- comment -%} J. MON VOYAGE {%- endcomment -%}
    {%- if section.settings.show_voyage != false -%}
    <div class="dash-voyage dash-reveal" data-dash-voyage>
      <h3 class="dash-voyage-title">{{ section.settings.voyage_title | default: "Mon Voyage" }}</h3>
      <p class="dash-voyage-date" data-dash-voyage-date></p>
      <p class="dash-voyage-summary" data-dash-voyage-summary></p>
    </div>
    {%- endif -%}

    {%- comment -%} K. FOOTER {%- endcomment -%}
    <div class="dash-footer dash-reveal">
      <a href="{{ section.settings.quiz_url | default: '/pages/quiz' }}" class="milaura-btn-gold">Refaire le diagnostic</a>
      <a href="/collections/all" class="milaura-btn" style="font-size:13px">Boutique</a>
    </div>

  </div><!-- /dash-main -->

  {%- comment -%} STICKY CTA {%- endcomment -%}
  <div class="dash-sticky" data-dash-sticky aria-hidden="true">
    <span class="dash-sticky-name" data-dash-sticky-name></span>
    <span class="dash-sticky-price" data-dash-sticky-price></span>
    <button type="button" class="milaura-btn-gold" style="padding:10px 24px;font-size:12px" data-dash-sticky-btn disabled>
      Ajouter
    </button>
  </div>

</div><!-- /MilauraDashboard -->

{%- comment -%} PRODUIT DATA (Liquid ‚Üí JSON pour JS) {%- endcomment -%}
<script type="application/json" data-dash-products>
{
  {%- assign profiles = "apaisement,protection,serenite,amour,chance" | split: "," -%}
  {%- for p in profiles -%}
    {%- assign pid = "profile_" | append: p | append: "_product" -%}
    {%- assign prod = section.settings[pid] -%}
    "{{ p }}": {% if prod %}{
      "title": {{ prod.title | json }},
      "url": {{ prod.url | json }},
      "price": {{ prod.price | money | json }},
      "featured_image": {% if prod.featured_image %}{{ prod.featured_image | image_url: width: 600 | json }}{% else %}null{% endif %},
      "handle": {{ prod.handle | json }},
      "variant_id": {% if prod.selected_or_first_available_variant %}{{ prod.selected_or_first_available_variant.id }}{% else %}null{% endif %}
    }{% else %}null{% endif %}{% unless forloop.last %},{% endunless %}
  {%- endfor -%}
}
</script>

<script>
(function() {
  'use strict';

  var SECTION_ID = {{ section.id | json }};
  var root = document.getElementById('MilauraDashboard-' + SECTION_ID);
  if (!root) return;

  /* ============================================
     PROFILES ‚Äî Source de verite (identique a quiz.liquid L1176-1292)
     ============================================ */
  var PROFILES = {
    apaisement: {
      label: 'Apaisement',
      displayName: 'Apaisement',
      moodLabel: 'Syst√®me nerveux en surchauffe',
      dashboardTitle: 'Ton syst√®me nerveux r√©clame une tr√™ve.',
      description: "Tu es la personne ¬´ forte ¬ª. Celle qui g√®re, qui encaisse, qui avance. De l'ext√©rieur, tout a l'air sous contr√¥le. Mais ton corps, lui, raconte une autre histoire. M√¢choires serr√©es, sommeil agit√©, souffle court... Tu ne te reposes pas, tu t'√©teins d'√©puisement. Ton probl√®me n'est pas ta capacit√© √† faire, c'est ta capacit√© √† d√©poser les armes.",
      bullets: ['Apaisement imm√©diat du syst√®me nerveux', 'Douceur √©motionnelle et l√¢cher-prise', 'Sensation de cocon r√©parateur'],
      ritual: "1. Allume-la. Inspire 3 fois.\n2. Autorise-toi √† √™tre vuln√©rable, juste 10 minutes.\n3. Dis-toi : ¬´ Je peux d√©poser les armes. ¬ª",
      stone: 'Calc√©doine bleue',
      scent: 'N√©roli',
      icon: 'üíô',
      colorAccent: '#6BA3C7',
      colorAccentRgb: '107, 163, 199'
    },
    protection: {
      label: 'Protection',
      displayName: 'Protection',
      moodLabel: '√ânergie envahie',
      dashboardTitle: "Ton √©nergie est pr√©cieuse, arr√™te de la distribuer.",
      description: "Tu as une hypersensibilit√© que tu essaies de cacher. Tu ressens les ambiances et les intentions des gens avant m√™me qu'ils ne parlent. C'est un don, mais en ce moment, c'est une mal√©diction : tu te laisses envahir. Tu finis tes journ√©es vid√©(e) non pas par ton travail, mais par les autres. Tu as besoin de reconstruire tes fronti√®res.",
      bullets: ['Bouclier √©nerg√©tique', 'Fronti√®res claires et nettes', 'Sanctuaire personnel'],
      ritual: "1. Allume-la en rentrant.\n2. Imagine un mur invisible se lever.\n3. Dis-toi : ¬´ Ici, c'est mon sanctuaire. ¬ª",
      stone: 'Obsidienne noire',
      scent: "Bois d'oud",
      icon: 'üñ§',
      colorAccent: '#4A4A4A',
      colorAccentRgb: '74, 74, 74'
    },
    serenite: {
      label: 'S√©r√©nit√©',
      displayName: 'S√©r√©nit√©',
      moodLabel: 'Mental en sur-contr√¥le',
      dashboardTitle: 'Ton mental est satur√©, tu dois couper le flux.',
      description: "Tu n'es pas fatigu√©(e) de la vie, tu es fatigu√©(e) de la g√©rer. Ton probl√®me n'est pas le chaos, c'est le sur-contr√¥le. Tu analyses, tu planifies, tu anticipes les probl√®mes qui n'existent pas encore. Ton cerveau est comme un navigateur avec 50 onglets ouverts qui ne r√©pond plus. Tu as perdu la clart√© parce que tu as peur que si tu arr√™tes d'y penser, tout s'√©croule. Spoiler : le monde continuera de tourner si tu d√©branches 10 minutes.",
      bullets: ['D√©connexion s√©lective', 'Reset cognitif', 'Clart√© mentale retrouv√©e'],
      ritual: "1. Coupe le t√©l√©phone. Allume.\n2. Regarde la flamme.\n3. Laisse les pens√©es passer sans les accrocher.",
      stone: 'Am√©thyste',
      scent: 'Th√© blanc',
      icon: 'üíú',
      colorAccent: '#9B7EC8',
      colorAccentRgb: '155, 126, 200'
    },
    amour: {
      label: 'Amour',
      displayName: 'Amour',
      moodLabel: 'Carence de bienveillance envers soi',
      dashboardTitle: "Tu donnes tout aux autres, mais qui s'occupe de toi ?",
      description: "C'est le paradoxe de ta vie actuelle : tu es une source in√©puisable de soutien pour tes proches, mais tu es d'une duret√© implacable avec toi-m√™me. Tu attends inconsciemment que quelqu'un vienne te ¬´ sauver ¬ª ou te valider, alors que ton c≈ìur a juste besoin de ta propre douceur. Tu es en carence de bienveillance envers toi-m√™me.",
      bullets: ['R√©paration vibratoire du c≈ìur', 'Bienveillance envers soi', 'Douceur enveloppante'],
      ritual: "1. Allume-la. Main sur le c≈ìur.\n2. Dis-toi les mots que tu aimerais entendre de quelqu'un d'autre.\n3. Dis-toi : ¬´ Je m√©rite la douceur que je donne aux autres. ¬ª",
      stone: 'Quartz rose',
      scent: 'Ambre gris',
      icon: 'üíó',
      colorAccent: '#D4839E',
      colorAccentRgb: '212, 131, 158'
    },
    chance: {
      label: 'Chance',
      displayName: 'Chance',
      moodLabel: "En attente d'un d√©clic",
      dashboardTitle: "Tu es pr√™t(e) pour le renouveau, il manque juste l'√©tincelle.",
      description: "Tu n'es pas d√©prim√©(e), tu es impatient(e). Tu sens au fond de tes tripes que tu es √† la fin d'un cycle. L'ancien ne te convient plus, le nouveau n'est pas encore l√†. Cette zone d'entre-deux te rend nerveux(se). Tu cherches le ¬´ truc ¬ª, l'opportunit√©, le signe qui va tout d√©bloquer. Spoiler : le blocage n'est pas dehors, c'est juste une peur de sauter.",
      bullets: ["√ânergie d'action et d'opportunit√©", 'Joie et √©lan retrouv√©s', 'Feu vert int√©rieur'],
      ritual: "1. Allume-la.\n2. Visualise ton objectif comme s'il √©tait d√©j√† fait.\n3. Souris. L'√©nergie suit l'intention.",
      stone: 'Aventurine verte',
      scent: "Fleur d'oranger",
      icon: 'üíö',
      colorAccent: '#6BAF7B',
      colorAccentRgb: '107, 175, 123'
    }
  };

  /* Mantras from Liquid schema settings */
  var MANTRAS = {
    apaisement: {{ section.settings.profile_apaisement_mantra | default: "Je peux d√©poser les armes" | json }},
    protection: {{ section.settings.profile_protection_mantra | default: "Je prot√®ge mon √©nergie" | json }},
    serenite: {{ section.settings.profile_serenite_mantra | default: "Je l√¢che le contr√¥le" | json }},
    amour: {{ section.settings.profile_amour_mantra | default: "Je m√©rite la douceur que je donne aux autres" | json }},
    chance: {{ section.settings.profile_chance_mantra | default: "L'√©nergie suit l'intention" | json }}
  };

  /* Mood label order (for mood bars) */
  var MOOD_ORDER = ['apaisement', 'protection', 'serenite', 'amour', 'chance'];

  /* ============================================
     DOM REFS
     ============================================ */
  var els = {
    loading: root.querySelector('[data-dash-state="loading"]'),
    empty: root.querySelector('[data-dash-state="empty"]'),
    main: root.querySelector('[data-dash-state="dashboard"]'),
    badge: root.querySelector('[data-dash-badge]'),
    badgeIcon: root.querySelector('[data-dash-badge-icon]'),
    badgeLabel: root.querySelector('[data-dash-badge-label]'),
    scoreCircle: root.querySelector('[data-dash-score-circle]'),
    scorePct: root.querySelector('[data-dash-score-pct]'),
    kpiProfile: root.querySelector('[data-dash-kpi-profile]'),
    kpiProfileIcon: root.querySelector('[data-dash-kpi-profile-icon]'),
    kpiStone: root.querySelector('[data-dash-kpi-stone]'),
    kpiScent: root.querySelector('[data-dash-kpi-scent]'),
    kpiDate: root.querySelector('[data-dash-kpi-date]'),
    readingTitle: root.querySelector('[data-dash-reading-title]'),
    readingText: root.querySelector('[data-dash-reading-text]'),
    readingBullets: root.querySelector('[data-dash-reading-bullets]'),
    mantra: root.querySelector('[data-dash-mantra]'),
    productCard: root.querySelector('[data-dash-product]'),
    productImg: root.querySelector('[data-dash-product-img]'),
    productTitle: root.querySelector('[data-dash-product-title]'),
    productBadges: root.querySelector('[data-dash-product-badges]'),
    productPrice: root.querySelector('[data-dash-product-price]'),
    addToCartBtn: root.querySelector('[data-dash-add-to-cart]'),
    ritualSteps: root.querySelector('[data-dash-ritual-steps]'),
    moodBars: root.querySelector('[data-dash-mood-bars]'),
    voyageDate: root.querySelector('[data-dash-voyage-date]'),
    voyageSummary: root.querySelector('[data-dash-voyage-summary]'),
    sticky: root.querySelector('[data-dash-sticky]'),
    stickyName: root.querySelector('[data-dash-sticky-name]'),
    stickyPrice: root.querySelector('[data-dash-sticky-price]'),
    stickyBtn: root.querySelector('[data-dash-sticky-btn]')
  };

  /* ============================================
     PRODUCT DATA (from Liquid JSON)
     ============================================ */
  var productData = {};
  try {
    var jsonEl = document.querySelector('[data-dash-products]');
    if (jsonEl) productData = JSON.parse(jsonEl.textContent);
  } catch (e) {
    console.error('Dashboard: error parsing product data', e);
  }

  /* ============================================
     STATE MANAGEMENT
     ============================================ */
  function showState(state) {
    els.loading.style.display = state === 'loading' ? 'flex' : 'none';
    els.empty.style.display = state === 'empty' ? 'block' : 'none';
    els.main.style.display = state === 'dashboard' ? 'flex' : 'none';
    if (state !== 'dashboard') {
      els.sticky.classList.remove('visible');
    }
  }

  /* ============================================
     SET ACCENT COLOR
     ============================================ */
  function setAccentColor(hex, rgb) {
    root.style.setProperty('--dash-accent', hex);
    root.style.setProperty('--dash-accent-rgb', rgb);
  }

  /* ============================================
     RENDER SCORE SVG
     ============================================ */
  function renderScore(percentages, profileId) {
    var pct = percentages && percentages[profileId] ? percentages[profileId] : 0;
    if (els.scorePct) els.scorePct.textContent = Math.round(pct) + '%';
    if (els.scoreCircle) {
      var circumference = 2 * Math.PI * 70; /* r=70 */
      var offset = circumference - (pct / 100) * circumference;
      /* Start at full offset, animate to target */
      els.scoreCircle.style.strokeDasharray = circumference;
      els.scoreCircle.style.strokeDashoffset = circumference;
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          els.scoreCircle.style.strokeDashoffset = offset;
        });
      });
    }
  }

  /* ============================================
     RENDER KPIs
     ============================================ */
  function renderKPIs(data, profile) {
    if (els.kpiProfile) els.kpiProfile.textContent = profile.displayName;
    if (els.kpiProfileIcon) els.kpiProfileIcon.textContent = profile.icon;
    if (els.kpiStone) els.kpiStone.textContent = data.stone || profile.stone;
    if (els.kpiScent) els.kpiScent.textContent = data.scent || profile.scent;
    if (els.kpiDate) {
      var d = data.timestamp ? new Date(data.timestamp) : new Date();
      els.kpiDate.textContent = d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
    }
  }

  /* ============================================
     RENDER COLD READING (mot-par-mot)
     ============================================ */
  function renderColdReading(profile) {
    if (els.readingTitle) els.readingTitle.textContent = profile.dashboardTitle;

    if (els.readingText) {
      var words = profile.description.split(' ');
      var html = words.map(function(w) { return '<span class="word">' + w + '</span>'; }).join(' ');
      els.readingText.innerHTML = html;

      /* Stagger reveal */
      var wordEls = els.readingText.querySelectorAll('.word');
      var reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      wordEls.forEach(function(el, i) {
        if (reducedMotion) {
          el.classList.add('visible');
        } else {
          setTimeout(function() { el.classList.add('visible'); }, 30 * i);
        }
      });
    }

    if (els.readingBullets && profile.bullets) {
      els.readingBullets.innerHTML = profile.bullets.map(function(b) {
        return '<li>' + b + '</li>';
      }).join('');
    }
  }

  /* ============================================
     RENDER MANTRA
     ============================================ */
  function renderMantra(profileId) {
    if (els.mantra) {
      els.mantra.textContent = MANTRAS[profileId] || '';
    }
  }

  /* ============================================
     RENDER PRODUCT STAR
     ============================================ */
  function renderProduct(profileId, profile) {
    var prod = productData[profileId];
    if (!prod) {
      if (els.productCard) els.productCard.style.display = 'none';
      if (els.sticky) els.sticky.style.display = 'none';
      return;
    }

    if (els.productImg) {
      els.productImg.src = prod.featured_image || '';
      els.productImg.alt = prod.title || '';
    }
    if (els.productTitle) els.productTitle.textContent = prod.title || '';
    if (els.productPrice) els.productPrice.textContent = prod.price || '';

    /* Badges pierre + senteur */
    if (els.productBadges) {
      els.productBadges.innerHTML =
        '<span class="dash-product-badge">üíé ' + profile.stone + '</span>' +
        '<span class="dash-product-badge">üå∏ ' + profile.scent + '</span>';
    }

    /* Add-to-cart button */
    if (els.addToCartBtn && prod.variant_id) {
      els.addToCartBtn.disabled = false;
      els.addToCartBtn.setAttribute('data-variant-id', prod.variant_id);
    }

    /* Sticky bar data */
    if (els.stickyName) els.stickyName.textContent = prod.title || '';
    if (els.stickyPrice) els.stickyPrice.textContent = prod.price || '';
    if (els.stickyBtn && prod.variant_id) {
      els.stickyBtn.disabled = false;
      els.stickyBtn.setAttribute('data-variant-id', prod.variant_id);
    }
  }

  /* ============================================
     RENDER RITUAL
     ============================================ */
  function renderRitual(profile, data) {
    if (!els.ritualSteps) return;
    var ritual = data.ritual || profile.ritual || '';
    var steps = ritual.split('\n').filter(function(s) { return s.trim(); });
    els.ritualSteps.innerHTML = steps.map(function(step, i) {
      /* Remove leading "1. " numbering if present */
      var text = step.replace(/^\d+\.\s*/, '');
      return '<div class="dash-ritual-step">' +
        '<span class="dash-ritual-num">' + (i + 1) + '</span>' +
        '<span class="dash-ritual-text">' + text + '</span>' +
        '</div>';
    }).join('');
  }

  /* ============================================
     RENDER MOOD BARS
     ============================================ */
  function renderMoodBars(percentages, profileId) {
    if (!els.moodBars || !percentages) return;

    var html = MOOD_ORDER.map(function(id) {
      var p = PROFILES[id];
      var pct = percentages[id] || 0;
      var isWinner = id === profileId;
      return '<div class="dash-mood-row">' +
        '<span class="dash-mood-label"><span class="dash-mood-label-icon">' + p.icon + '</span> ' + p.label + '</span>' +
        '<div class="dash-mood-track"><div class="dash-mood-fill ' + (isWinner ? 'is-winner' : 'is-secondary') + '" data-pct="' + Math.round(pct) + '"></div></div>' +
        '<span class="dash-mood-pct">' + Math.round(pct) + '%</span>' +
        '</div>';
    }).join('');

    els.moodBars.innerHTML = html;

    /* Animate bars */
    requestAnimationFrame(function() {
      requestAnimationFrame(function() {
        var fills = els.moodBars.querySelectorAll('.dash-mood-fill');
        fills.forEach(function(el) {
          el.style.width = el.getAttribute('data-pct') + '%';
        });
      });
    });
  }

  /* ============================================
     RENDER VOYAGE
     ============================================ */
  function renderVoyage(data, profile) {
    if (els.voyageDate && data.timestamp) {
      var d = new Date(data.timestamp);
      els.voyageDate.textContent = 'Diagnostic du ' + d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
    }
    if (els.voyageSummary) {
      els.voyageSummary.textContent = 'Profil ' + profile.displayName + ' ‚Äî ' + profile.stone + ' & ' + profile.scent;
    }
  }

  /* ============================================
     RENDER BADGE
     ============================================ */
  function renderBadge(profile) {
    if (els.badgeIcon) els.badgeIcon.textContent = profile.icon;
    if (els.badgeLabel) els.badgeLabel.textContent = 'Profil ' + profile.displayName;
  }

  /* ============================================
     ADD TO CART (pattern identique a quiz.liquid L1662-1701)
     ============================================ */
  function addToCart(variantId, btn) {
    if (!variantId || btn.disabled) return;
    var originalText = btn.textContent;
    btn.textContent = 'Ajout en cours...';
    btn.disabled = true;

    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: parseInt(variantId, 10), quantity: 1 })
    })
    .then(function(r) { return r.json(); })
    .then(function() {
      btn.textContent = '\u2713 Ajout√© au panier';
      btn.style.background = 'linear-gradient(135deg, #4CAF50, #66BB6A)';
      setTimeout(function() {
        btn.textContent = originalText;
        btn.style.background = '';
        btn.disabled = false;
      }, 2000);
      if (typeof window.updateCartCount === 'function') window.updateCartCount();
    })
    .catch(function(err) {
      console.error('Dashboard add-to-cart error:', err);
      btn.textContent = 'Erreur - R√©essayer';
      btn.style.background = 'linear-gradient(135deg, #f44336, #e57373)';
      btn.disabled = false;
      setTimeout(function() {
        btn.textContent = originalText;
        btn.style.background = '';
      }, 2000);
    });
  }

  /* ============================================
     STICKY BAR (IntersectionObserver)
     ============================================ */
  function initStickyBar() {
    if (!els.productCard || !els.sticky) return;
    if (!('IntersectionObserver' in window)) return;

    var observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          els.sticky.classList.remove('visible');
          els.sticky.setAttribute('aria-hidden', 'true');
        } else {
          els.sticky.classList.add('visible');
          els.sticky.setAttribute('aria-hidden', 'false');
        }
      });
    }, { threshold: 0.1 });

    observer.observe(els.productCard);
  }

  /* ============================================
     SCROLL REVEAL (IntersectionObserver)
     ============================================ */
  function initScrollAnimations() {
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      root.querySelectorAll('.dash-reveal').forEach(function(el) {
        el.classList.add('revealed');
      });
      return;
    }
    if (!('IntersectionObserver' in window)) {
      root.querySelectorAll('.dash-reveal').forEach(function(el) {
        el.classList.add('revealed');
      });
      return;
    }

    var observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          entry.target.classList.add('revealed');
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1, rootMargin: '0px 0px -30px 0px' });

    root.querySelectorAll('.dash-reveal').forEach(function(el) {
      observer.observe(el);
    });
  }

  /* ============================================
     SHOW DASHBOARD (orchestre tout)
     ============================================ */
  function showDashboard(data) {
    var profileId = data.profileId;
    var profile = PROFILES[profileId];
    if (!profile) {
      showState('empty');
      return;
    }

    /* Accent color */
    setAccentColor(
      data.profileAccent || profile.colorAccent,
      data.profileAccentRgb || profile.colorAccentRgb
    );

    /* Render all blocks */
    renderBadge(profile);
    renderScore(data.percentages, profileId);
    renderKPIs(data, profile);
    renderColdReading(profile);
    renderMantra(profileId);
    renderProduct(profileId, profile);
    renderRitual(profile, data);
    renderMoodBars(data.percentages, profileId);
    renderVoyage(data, profile);

    /* Show dashboard, init animations */
    showState('dashboard');
    initScrollAnimations();
    initStickyBar();
  }

  /* ============================================
     INIT ‚Äî Read localStorage, route to state
     ============================================ */
  function init() {
    showState('loading');

    /* Add-to-cart event listeners */
    if (els.addToCartBtn) {
      els.addToCartBtn.addEventListener('click', function() {
        addToCart(this.getAttribute('data-variant-id'), this);
      });
    }
    if (els.stickyBtn) {
      els.stickyBtn.addEventListener('click', function() {
        addToCart(this.getAttribute('data-variant-id'), this);
      });
    }

    /* Read localStorage */
    var raw = null;
    try {
      raw = localStorage.getItem('milauraLastResult');
    } catch (e) {
      /* localStorage blocked */
    }

    if (!raw) {
      showState('empty');
      return;
    }

    var data = null;
    try {
      data = JSON.parse(raw);
    } catch (e) {
      showState('empty');
      return;
    }

    if (!data || !data.profileId || !PROFILES[data.profileId]) {
      showState('empty');
      return;
    }

    /* Small delay for loading UX */
    setTimeout(function() {
      showDashboard(data);
    }, 400);
  }

  /* ============================================
     LISTEN FOR QUIZ RESULTS (real-time update)
     ============================================ */
  window.addEventListener('milaura:quiz-result', function(e) {
    if (e.detail && e.detail.profileId) {
      showDashboard(e.detail);
    }
  });

  /* ============================================
     BOOT
     ============================================ */
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>

{% schema %}
{
  "name": "Milaura Dashboard",
  "enabled_on": {
    "templates": ["customers/account"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Textes g√©n√©raux"
    },
    {
      "type": "text",
      "id": "greeting_prefix",
      "label": "Pr√©fixe de salutation",
      "default": "Bonjour"
    },
    {
      "type": "text",
      "id": "loading_text",
      "label": "Texte de chargement",
      "default": "Chargement de votre profil..."
    },
    {
      "type": "text",
      "id": "score_label",
      "label": "Label du score",
      "default": "Vibration"
    },
    {
      "type": "text",
      "id": "product_eyebrow",
      "label": "Accroche produit",
      "default": "L'appel de l'√¢me"
    },
    {
      "type": "text",
      "id": "ritual_title",
      "label": "Titre rituel",
      "default": "Ton rituel de connexion"
    },
    {
      "type": "text",
      "id": "mood_title",
      "label": "Titre m√©t√©o √©motionnelle",
      "default": "Ta m√©t√©o √©motionnelle"
    },
    {
      "type": "text",
      "id": "voyage_title",
      "label": "Titre voyage",
      "default": "Mon Voyage"
    },
    {
      "type": "header",
      "content": "√âtat vide (pas de quiz)"
    },
    {
      "type": "text",
      "id": "empty_icon",
      "label": "Ic√¥ne √©tat vide",
      "default": "‚ú®"
    },
    {
      "type": "text",
      "id": "empty_title",
      "label": "Titre √©tat vide",
      "default": "D√©couvrez votre profil √©motionnel"
    },
    {
      "type": "textarea",
      "id": "empty_text",
      "label": "Texte √©tat vide",
      "default": "Votre diagnostic r√©v√®lera la bougie et la pierre qui r√©sonnent avec votre √©nergie actuelle."
    },
    {
      "type": "text",
      "id": "empty_cta",
      "label": "CTA √©tat vide",
      "default": "Faire le diagnostic"
    },
    {
      "type": "url",
      "id": "quiz_url",
      "label": "URL du quiz"
    },
    {
      "type": "header",
      "content": "‚îÄ‚îÄ Profil Apaisement ‚îÄ‚îÄ"
    },
    {
      "type": "product",
      "id": "profile_apaisement_product",
      "label": "Produit Apaisement"
    },
    {
      "type": "text",
      "id": "profile_apaisement_mantra",
      "label": "Mantra Apaisement",
      "default": "Je peux d√©poser les armes"
    },
    {
      "type": "header",
      "content": "‚îÄ‚îÄ Profil Protection ‚îÄ‚îÄ"
    },
    {
      "type": "product",
      "id": "profile_protection_product",
      "label": "Produit Protection"
    },
    {
      "type": "text",
      "id": "profile_protection_mantra",
      "label": "Mantra Protection",
      "default": "Je prot√®ge mon √©nergie"
    },
    {
      "type": "header",
      "content": "‚îÄ‚îÄ Profil S√©r√©nit√© ‚îÄ‚îÄ"
    },
    {
      "type": "product",
      "id": "profile_serenite_product",
      "label": "Produit S√©r√©nit√©"
    },
    {
      "type": "text",
      "id": "profile_serenite_mantra",
      "label": "Mantra S√©r√©nit√©",
      "default": "Je l√¢che le contr√¥le"
    },
    {
      "type": "header",
      "content": "‚îÄ‚îÄ Profil Amour ‚îÄ‚îÄ"
    },
    {
      "type": "product",
      "id": "profile_amour_product",
      "label": "Produit Amour"
    },
    {
      "type": "text",
      "id": "profile_amour_mantra",
      "label": "Mantra Amour",
      "default": "Je m√©rite la douceur que je donne aux autres"
    },
    {
      "type": "header",
      "content": "‚îÄ‚îÄ Profil Chance ‚îÄ‚îÄ"
    },
    {
      "type": "product",
      "id": "profile_chance_product",
      "label": "Produit Chance"
    },
    {
      "type": "text",
      "id": "profile_chance_mantra",
      "label": "Mantra Chance",
      "default": "L'√©nergie suit l'intention"
    },
    {
      "type": "header",
      "content": "Tailles de texte"
    },
    {
      "type": "range",
      "id": "heading_size",
      "label": "Taille du titre principal (px)",
      "min": 20,
      "max": 48,
      "step": 1,
      "default": 32,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "body_size",
      "label": "Taille du texte corps (px)",
      "min": 12,
      "max": 20,
      "step": 1,
      "default": 15,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Couleurs"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Couleur accent par d√©faut",
      "default": "#C0A062"
    },
    {
      "type": "header",
      "content": "Affichage"
    },
    {
      "type": "checkbox",
      "id": "show_cold_reading",
      "label": "Afficher le cold reading",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_mood_bars",
      "label": "Afficher la m√©t√©o √©motionnelle",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_voyage",
      "label": "Afficher Mon Voyage",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Milaura Dashboard"
    }
  ]
}
{% endschema %}
